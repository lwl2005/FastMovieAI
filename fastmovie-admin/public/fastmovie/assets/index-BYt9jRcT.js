import{d as Oe,Y as je,r,z as ce,w as He,o as We,a as Ye,j as z,k as f,l as o,m as l,t as b,u as s,s as n,h as c,q as Ke,as as P,ai as Qe,a8 as Xe,I as B,M as ue,p as Ze,P as ea,ar as aa,e as x,f as pe,a7 as sa,a5 as la,C as oa,x as W,B as ta,af as na,ac as ia,a6 as da,J as ra,S as ca,E as g}from"./vendor-C6C8mA7k.js";import{_ as ua}from"./xl-scene-create-BqosGKV5.js";import{u as me,a as pa,I as ma,_ as fa}from"./usePoints-DiZlsgf1.js";import{c as ga,u as _a,$ as _,R as y,r as fe,_ as va}from"./index-BY2sLTz-.js";import{I as xa}from"./icon-prev-step-BXDsHHJ2.js";import{I as ha}from"./icon-next-step-dF3w-4aj.js";import{I as ya}from"./icon-batch-DD0Cm_Jc.js";import{I as ge}from"./icon-points-DqG7XnbB.js";import{I as Sa}from"./icon-replace-D95gtLmn.js";import{u as ba}from"./usePush-CTrtsatV.js";const ka={class:"flex flex-column draw-module"},Ca={class:"flex-1 flex grid-gap-10 overflow-hidden"},wa={class:"flex-1 flex flex-column grid-gap-10 overflow-hidden"},Ia={class:"flex grid-gap-2"},Ua={class:"text-success"},Va={key:0,class:"flex flex-center flex-column grid-gap-2 text-info"},za={key:1,class:"flex flex-center flex-column grid-gap-2 text-info"},Ea={class:"flex grid-gap-2"},Ra={class:"montage-storyboard rounded-4 border"},La={class:"montage-storyboard-list"},Pa=["onClick"],Ba={class:"flex montage-storyboard-list-item-title grid-gap-2"},Fa={class:"h10 flex-1 text-nowrap text-ellipsis-1"},$a={class:"flex flex-column grid-gap-1 flex-center"},Ga={class:"flex"},Da={key:0,class:"flex flex-center grid-gap-2"},Na={class:"scene-form-wrapper bg-overlay border rounded-4 scene-form flex flex-column grid-gap-4"},Aa={class:"border-bottom flex flex-center"},Ma={class:"flex flex-column grid-gap-2 px-4"},qa={class:"grid-columns-4 grid-gap-2"},Ta={class:"flex flex-column grid-gap-2 px-4"},Ja={class:"bg rounded-4 p-4 border"},Oa={class:"flex flex-y-center grid-gap-2"},ja={class:"h10 text-ellipsis-1",style:{"max-width":"60px"}},Ha={class:"bg-overlay rounded-round p-3 flex flex-center grid-gap-2 pointer hover-bg-hover"},Wa={class:"flex flex-center grid-gap-2"},Ya={class:"h10"},Ka={key:0,class:"grid-columns-2 grid-gap-4 p-4"},Qa=["onClick"],Xa={class:"p-4 w-100 flex grid-gap-4 flex-center"},Za={class:"flex flex-center grid-gap-2"},es={class:"h10"},as=Oe({__name:"index",emits:["update:drama"],setup(ss,{emit:_e}){const k=je(),ve=ga(),{USERINFO:xe}=_a(ve),E=r(k.params.drama_id),T=r(k.params.episode_id),he=_e,J=r({}),ye=()=>{E.value&&_.get("/app/shortplay/api/Works/details",{params:{id:E.value}}).then(a=>{a.code===y.SUCCESS?(J.value=a.data,he("update:drama",J.value)):g.error(a.msg)}).catch(()=>{g.error("获取短剧详情失败")})},v=ce({type:"episode",name:"",drama_id:E.value,episode_id:T.value}),p=r([]),Y=r(!1),O=r(null),u=r(),i=r({drama_id:E.value,episode_id:T.value,id:"",title:"",description:"",scene_location:"",scene_space:"",scene_time:"",scene_weather:"",image:"",model_id:null,reference_image:""});He(p,()=>{try{const a=p.value.find(e=>e.id===u.value?.id);a?G(a):(u.value=void 0,i.value={drama_id:E.value,episode_id:T.value,id:"",title:"",description:"",scene_location:"",scene_space:"",scene_time:"",scene_weather:"",image:"",model_id:null,reference_image:""})}catch(a){console.error("watch sceneList error",a)}});const K=()=>{Y.value=!0,_.get("/app/shortplay/api/Scene/index",{params:v}).then(a=>{a.code===y.SUCCESS&&(p.value=a.data,!p.value.find(d=>d.id===u.value?.id)&&p.value.length>0&&G(p.value[0]))}).catch(a=>{console.error("getSceneList error",a)}).finally(()=>{Y.value=!1})},F=r([]),Q=r(!1),X=ce({alias_id:"",scene:"scene_image",page:1,page_size:100});let $=null;const Z=()=>{$&&$.abort(),$=new AbortController,Q.value=!0,F.value=[],_.get("/app/model/api/Task/index",{params:X,signal:$?.signal}).then(a=>{a.code===y.SUCCESS&&(F.value=a.data.data)}).catch(()=>{}).finally(()=>{Q.value=!1})},G=a=>{u.value=a,i.value.id=a.id,i.value.title=a.title,i.value.description=a.description,i.value.scene_location=a.scene_location,i.value.scene_space=a.scene_space,i.value.scene_time=a.scene_time,i.value.scene_weather=a.scene_weather,i.value.image=a.image,i.value.model_id=a.model_id,X.alias_id=a.id,Z()},ee=r(null),ae=r(null),h=r({}),j=a=>{a?h.value=a:(h.value={},i.value.model_id=null),ee.value?.hide()},Se=me([h]),D=r(!1),be=()=>{D.value||u.value.image_state||(D.value=!0,_.post("/app/shortplay/api/Generate/sceneImage",{...i.value,model_id:h.value.id}).then(a=>{a.code===y.SUCCESS?u.value.image_state=1:g.error(a.msg)}).catch(()=>{g.error("生成图片失败")}).finally(()=>{D.value=!1}))},N=r(null),C=r(!1),ke=a=>{C.value=!1,a.code===y.SUCCESS?i.value.reference_image=a.data.url:g.error(a.msg),N.value?.clearFiles()},Ce=()=>{C.value=!1,N.value?.clearFiles()},A=r(!1),we=a=>{A.value||a.status!=="success"||(A.value=!0,_.post("/app/shortplay/api/Scene/update",{id:u.value.id,drama_id:v.drama_id,episode_id:v.episode_id,image:a.result.image_path}).then(e=>{e.code===y.SUCCESS?(u.value.image=a.result.image_path,u.value.image_state=0,i.value.image=a.result.image_path):g.error(e.msg)}).catch(()=>{g.error("替换场景失败")}).finally(()=>{A.value=!1}))},w=r(!1),M=r(!1),se=r(0),H=r([]),Ie=()=>{w.value=!0,H.value=p.value.filter(a=>!a.image),se.value=H.value.length},Ue=me([h],se),Ve=()=>{M.value=!0,Promise.all(H.value.map(a=>_.post("/app/shortplay/api/Generate/sceneImage",{id:a.id,model_id:h.value.id}))).then(()=>{K()}).catch(a=>{console.error("submitBatchGenerate error",a)}).finally(()=>{M.value=!1,w.value=!1})},{subscribe:ze,unsubscribeAll:Ee}=ba(),Re=()=>{ze("private-generatesceneimage-"+xe.value?.user,a=>{console.log("channels complete info message",a);const e=p.value.find(d=>d.id===a.id);e&&(e.image_state=0,a.image&&(e.image=a.image),Z())})},Le=()=>{fe.push(`/generate/props/${k.params.drama_id}/${k.params.episode_id}`)},Pe=()=>{fe.push(`/generate/storyboard/${k.params.drama_id}/${k.params.episode_id}`)},le=r(!1),Be=a=>{le.value=!0;const e=JSON.parse(JSON.stringify(p.value)),L=p.value.filter(m=>m.id!==a.id),S=L.sort((m,I)=>m.sort-I.sort).map((m,I)=>({...m,sort:I+1}));return p.value=L.map(m=>S.find(q=>q.id===m.id)??m),_.post("/app/shortplay/api/Scene/deleteScene",{id:a.id,drama_id:v.drama_id,episode_id:v.episode_id}).then(m=>{m.code===y.SUCCESS?(g.success("删除成功"),u.value?.id==a.id&&(u.value=void 0)):(g.error(m.msg),p.value=e)}).catch(()=>{g.error("删除失败"),p.value=e}).finally(()=>{le.value=!1})},Fe=a=>{const e=p.value.findIndex(d=>d.id===a.id);e!==-1?p.value[e]=a:p.value.push(a),u.value?.id===a.id&&G(a)},oe=r(null),R=r(!1),$e=a=>{R.value=!1,a.code===y.SUCCESS?(u.value.image=a.data.url,_.post("/app/shortplay/api/Scene/update",{id:u.value.id,drama_id:v.drama_id,episode_id:v.episode_id,image:a.data.url}).then(e=>{e.code===y.SUCCESS?g.success("保存成功"):g.error(e.msg)})):g.error(a.msg),oe.value?.clearFiles()},Ge=()=>{R.value=!1,oe.value?.clearFiles()};return We(()=>{K(),ye(),Re()}),Ye(()=>{console.log("scenes unmounted"),Ee()}),(a,e)=>{const d=Ke,L=Qe,S=Xe,m=z("Delete"),I=aa,q=z("Plus"),te=la,U=oa,V=ta,De=z("Close"),Ne=z("ArrowDown"),Ae=z("PictureRounded"),ne=ia,Me=z("Top"),ie=fa,de=da,qe=ca,Te=ua,Je=sa;return c(),f("div",ka,[o("div",Ca,[o("div",wa,[o("div",Ia,[o("span",null,b(s(u)?.title),1),o("span",Ua,"场景"+b(s(u)?.id),1)]),l(S,{src:s(u)?.image_state?"":s(u)?.image,fit:"contain",class:"preview-image bg-mosaic",shape:"square"},{default:n(()=>[s(u)?.image_state?(c(),f("div",Va,[l(d,{size:"64"},{default:n(()=>[l(s(P),{class:"circular"})]),_:1}),e[13]||(e[13]=o("span",null,"场景绘制中...",-1))])):(c(),f("div",za,[l(d,{size:"64"},{default:n(()=>[l(pa)]),_:1}),e[16]||(e[16]=o("span",null,"在右侧让AI为你生成场景图",-1)),o("div",Ea,[e[15]||(e[15]=o("span",null,"或",-1)),l(L,{ref_key:"uploadImageRef",ref:N,data:{dir_name:"scene/image",dir_title:"场景图照片"},action:s(_).getCompleteUrl("app/shortplay/api/Uploads/upload"),headers:s(_).getHeaders(),accept:"image/jpeg,image/png",limit:1,type:"cover",disabled:s(R),"before-upload":()=>(R.value=!0,!0),"on-success":$e,"show-file-list":!1,"on-error":()=>{R.value=!1,Ge()}},{default:n(()=>[...e[14]||(e[14]=[o("span",{class:"text-text-primary"},"从本地上传素材",-1)])]),_:1},8,["action","headers","disabled","before-upload","on-error"])]),e[17]||(e[17]=o("span",null,"图片：JPG/PNG，大于 300px，不超过 10MB",-1))]))]),_:1},8,["src"]),o("div",Ra,[l(te,{ref:"videoScrollbarRef",class:"montage-storyboard-video montage-storyboard-scrollbar","x-scroll":"","y-scroll":!1,"wrap-class":"montage-storyboard-video-wrap"},{default:n(()=>[o("div",La,[(c(!0),f(B,null,ue(s(p),t=>(c(),f("div",{class:Ze(["montage-storyboard-list-item rounded-4",{active:t.id===s(u)?.id}]),key:t.id,onClick:re=>G(t)},[o("div",Ba,[o("span",Fa,"场景"+b(t.id)+" - "+b(t.title),1),l(I,{title:"确定删除该分镜吗？",placement:"bottom-end","confirm-button-type":"danger",teleported:!1,width:"fit-content",onConfirm:re=>Be(t)},{reference:n(()=>[l(d,{class:"icon-button hover-show"},{default:n(()=>[l(m)]),_:1})]),_:1},8,["onConfirm"])]),ea((c(),x(S,{class:"montage-storyboard-list-item-image bg-mosaic",src:t.image,fit:["9:16","16:9"].includes(s(J).aspect_ratio)?"contain":"cover","element-loading-text":"图片生成中..."},{default:n(()=>[o("div",$a,[o("div",Ga,[t.image_state?(c(),f("span",Da,[l(d,{size:"20"},{default:n(()=>[l(s(P),{class:"circular"})]),_:1}),e[18]||(e[18]=o("span",{class:"h10"},"生成中...",-1))])):pe("",!0)])])]),_:2},1032,["src","fit"])),[[Je,t.image_state&&t.image]])],10,Pa))),128)),o("div",{class:"montage-storyboard-list-item rounded-4 flex flex-column grid-gap-2 flex-center pointer",onClick:e[0]||(e[0]=t=>s(O)?.open?.({drama_id:s(v).drama_id,episode_id:s(v).episode_id}))},[l(d,{size:"20"},{default:n(()=>[l(q)]),_:1}),e[19]||(e[19]=o("span",{class:"h10"},"新增场景",-1))])])]),_:1},512)])]),o("div",Na,[s(i).id?(c(),f(B,{key:0},[o("div",Aa,[l(V,{modelValue:s(i).title,"onUpdate:modelValue":e[2]||(e[2]=t=>s(i).title=t),placeholder:"场景",size:"large",class:"scene-form-input flex-1"},{suffix:n(()=>[l(U,{type:"primary",bg:"",text:"",size:"small",onClick:e[1]||(e[1]=t=>s(O)?.open?.({scene:s(u),drama_id:s(v).drama_id,episode_id:s(v).episode_id}))},{default:n(()=>[...e[20]||(e[20]=[W("编辑",-1)])]),_:1})]),_:1},8,["modelValue"])]),o("div",Ma,[e[21]||(e[21]=o("span",null,"场景",-1)),o("div",qa,[l(V,{modelValue:s(i).scene_location,"onUpdate:modelValue":e[3]||(e[3]=t=>s(i).scene_location=t),placeholder:"地点",class:"grid-column-2 scene-form-input"},null,8,["modelValue"]),l(V,{modelValue:s(i).scene_space,"onUpdate:modelValue":e[4]||(e[4]=t=>s(i).scene_space=t),placeholder:"内景OR外景",class:"grid-column-2 scene-form-input"},null,8,["modelValue"]),l(V,{modelValue:s(i).scene_time,"onUpdate:modelValue":e[5]||(e[5]=t=>s(i).scene_time=t),placeholder:"大概时间",class:"grid-column-2 scene-form-input"},null,8,["modelValue"]),l(V,{modelValue:s(i).scene_weather,"onUpdate:modelValue":e[6]||(e[6]=t=>s(i).scene_weather=t),placeholder:"天气",class:"grid-column-2 scene-form-input"},null,8,["modelValue"])])]),o("div",Ta,[e[24]||(e[24]=o("span",null,"场景描述",-1)),o("div",Ja,[l(V,{modelValue:s(i).description,"onUpdate:modelValue":e[7]||(e[7]=t=>s(i).description=t),placeholder:"请输入场景描述",size:"small",class:"scene-form-textarea",type:"textarea",autosize:{minRows:6,maxRows:20}},null,8,["modelValue"]),o("div",Oa,[o("div",{class:"bg-overlay rounded-round p-3 flex flex-center grid-gap-2 pointer hover-bg-hover",ref_key:"modelButtonRef",ref:ae,title:"选择使用AI生成图"},[s(h).id?(c(),f(B,{key:0},[l(S,{src:s(h).icon,alt:s(h).name,shape:"square",size:16},null,8,["src","alt"]),o("span",ja,b(s(h).name),1),l(d,{size:"16",class:"pointer",onClick:e[8]||(e[8]=na(t=>j(),["stop"]))},{default:n(()=>[l(De)]),_:1})],64)):(c(),f(B,{key:1},[l(d,{size:"16"},{default:n(()=>[l(ma)]),_:1}),e[22]||(e[22]=o("span",{class:"h10"},"场景图",-1)),l(d,{size:"16"},{default:n(()=>[l(Ne)]),_:1})],64))],512),l(L,{ref_key:"uploadImageRef",ref:N,title:"添加参考图",data:{dir_name:"scene/reference",dir_title:"场景参考照片"},action:s(_).getCompleteUrl("app/shortplay/api/Uploads/upload"),headers:s(_).getHeaders(),accept:"image/jpeg,image/png",limit:1,type:"cover",disabled:s(C),"before-upload":()=>(C.value=!0,!0),"on-success":ke,"show-file-list":!1,"on-error":Ce},{default:n(()=>[o("div",Ha,[l(ne,{placement:"top",disabled:!s(i).reference_image,width:"fit-content"},{reference:n(()=>[!s(i).reference_image||s(C)?(c(),x(d,{key:0,size:"16"},{default:n(()=>[s(C)?(c(),x(s(P),{key:0,class:"circular"})):(c(),x(q,{key:1}))]),_:1})):(c(),x(d,{key:1,size:"16",color:"var(--el-color-success)"},{default:n(()=>[l(Ae)]),_:1}))]),default:n(()=>[l(S,{src:s(i).reference_image,fit:"contain",size:130,shape:"square"},null,8,["src"])]),_:1},8,["disabled"])])]),_:1},8,["action","headers","disabled","before-upload"]),e[23]||(e[23]=o("div",{class:"flex-1"},null,-1)),o("div",Wa,[l(d,{size:"16"},{default:n(()=>[l(ge)]),_:1}),o("span",Ya,b(s(Se)),1)]),o("div",{class:"rounded-round p-3 flex flex-center grid-gap-2 pointer",style:{"background-color":"#FFFFFF",color:"#141414"},onClick:be},[l(d,{size:"20"},{default:n(()=>[s(D)||s(u).image_state?(c(),x(s(P),{key:0,class:"circular"})):(c(),x(Me,{key:1}))]),_:1})])])])]),l(ne,{ref_key:"modelPopoverRef",ref:ee,"popper-class":"model-popover","virtual-ref":s(ae),"virtual-triggering":"",placement:"bottom",width:"min(100vw,380px)",trigger:"click"},{default:n(()=>[l(ie,{modelValue:s(i).model_id,"onUpdate:modelValue":e[9]||(e[9]=t=>s(i).model_id=t),onSelect:j,"no-init":"",scene:"scene_image"},null,8,["modelValue"])]),_:1},8,["virtual-ref"]),e[26]||(e[26]=o("div",{class:"flex flex-column grid-gap-2 px-4 pt-4"},[o("span",null,"场景记录")],-1)),l(te,{class:"flex-1"},{default:n(()=>[s(F).length>0?(c(),f("div",Ka,[(c(!0),f(B,null,ue(s(F),t=>(c(),f("div",{class:"grid-column-1 task-item",key:t.id},[l(S,{src:t.result.image_path,fit:"contain",shape:"square",size:206},null,8,["src"]),t.status==="success"&&t.result.image_path!==s(i).image?(c(),f("div",{key:0,class:"flex flex-center grid-gap-2 task-item-replace pointer",onClick:re=>we(t)},[l(d,null,{default:n(()=>[s(A)?(c(),x(s(P),{key:0,class:"circular"})):(c(),x(Sa,{key:1}))]),_:1}),e[25]||(e[25]=o("span",{class:"h10 text-nowrap"},"替换原始",-1))],8,Qa)):pe("",!0)]))),128))])):(c(),x(de,{key:1,description:"暂无原始记录"}))]),_:1})],64)):(c(),x(de,{key:1,description:"点击场景名称选择场景"}))])]),o("div",Xa,[l(U,{bg:"",text:"",size:"large",onClick:Le},{default:n(()=>[l(d,{size:"16"},{default:n(()=>[l(xa)]),_:1}),e[27]||(e[27]=o("span",null,"上一步",-1))]),_:1}),l(U,{type:"success",size:"large",disabled:s(p).filter(t=>t.status==="initializing").length<=0,onClick:Ie},{default:n(()=>[l(d,{size:"16"},{default:n(()=>[l(ya)]),_:1}),e[28]||(e[28]=o("span",null,"批量生成",-1))]),_:1},8,["disabled"]),l(U,{type:"success",size:"large",onClick:Pe},{default:n(()=>[e[29]||(e[29]=o("span",null,"下一步",-1)),l(d,{size:"16",class:"ml-2"},{default:n(()=>[l(ha)]),_:1})]),_:1})]),l(qe,{modelValue:s(w),"onUpdate:modelValue":e[12]||(e[12]=t=>ra(w)?w.value=t:null),class:"generate-storyboard-dialog",draggable:"",width:"800px"},{header:n(()=>[...e[30]||(e[30]=[o("span",{class:"font-weight-600"},"批量生成场景",-1)])]),footer:n(()=>[l(U,{type:"info",onClick:e[11]||(e[11]=t=>w.value=!1),disabled:s(M)},{default:n(()=>[...e[31]||(e[31]=[W("取消",-1)])]),_:1},8,["disabled"]),e[33]||(e[33]=o("div",{class:"flex-1"},null,-1)),o("div",Za,[l(d,{size:"16"},{default:n(()=>[l(ge)]),_:1}),o("span",es,b(s(Ue)),1)]),l(U,{type:"success",icon:"Check",onClick:Ve,disabled:!s(i).model_id,loading:s(M)},{default:n(()=>[...e[32]||(e[32]=[W("生成",-1)])]),_:1},8,["disabled","loading"])]),default:n(()=>[l(ie,{title:"模型",modelValue:s(i).model_id,"onUpdate:modelValue":e[10]||(e[10]=t=>s(i).model_id=t),onSelect:j,"no-init":"",class:"flex-1 bg-overlay rounded-4 p-4",scene:"scene_image"},null,8,["modelValue"])]),_:1},8,["modelValue"]),l(Te,{ref_key:"sceneCreateRef",ref:O,onSuccess:Fe},null,512)])}}}),ms=va(as,[["__scopeId","data-v-0b0e0477"]]);export{ms as default};
