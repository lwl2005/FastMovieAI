(function(){"use strict";class J{img;durationMs;ready;constructor(n,l){this.img=n,this.durationMs=l,this.ready=n.ready}get meta(){const n=this.img.meta;return{width:n.width,height:n.height,displayWidth:n.width,codedWidth:n.width,displayHeight:n.height,codedHeight:n.height,duration:this.durationMs}}async tick(n){return n>=this.durationMs?{state:"done"}:{...await this.img.tick(n),state:"success"}}async split(n){if(n<=0||n>=this.durationMs)throw new Error("split time out of range");const l=new J(await this.img.clone(),n),o=new J(await this.img.clone(),this.durationMs-n);return[l,o]}async clone(){return new J(await this.img.clone(),this.durationMs)}destroy(){this.img.destroy()}}function we(d){return d&&d.__esModule&&Object.prototype.hasOwnProperty.call(d,"default")?d.default:d}var Tt={},jt;function be(){return jt||(jt=1,(function(d){var n=(function(){var t=new Date,e=4,s=3,a=2,h=1,c=e,p={setLogLevel:function(g){g==this.debug?c=h:g==this.info?c=a:g==this.warn?c=s:(g==this.error,c=e)},debug:function(g,m){console.debug===void 0&&(console.debug=console.log),h>=c&&console.debug("["+n.getDurationString(new Date-t,1e3)+"]","["+g+"]",m)},log:function(g,m){this.debug(g.msg)},info:function(g,m){a>=c&&console.info("["+n.getDurationString(new Date-t,1e3)+"]","["+g+"]",m)},warn:function(g,m){s>=c&&console.warn("["+n.getDurationString(new Date-t,1e3)+"]","["+g+"]",m)},error:function(g,m){e>=c&&console.error("["+n.getDurationString(new Date-t,1e3)+"]","["+g+"]",m)}};return p})();n.getDurationString=function(t,e){var s;function a(b,w){for(var U=""+b,B=U.split(".");B[0].length<w;)B[0]="0"+B[0];return B.join(".")}t<0?(s=!0,t=-t):s=!1;var h=e||1,c=t/h,p=Math.floor(c/3600);c-=p*3600;var g=Math.floor(c/60);c-=g*60;var m=c*1e3;return c=Math.floor(c),m-=c*1e3,m=Math.floor(m),(s?"-":"")+p+":"+a(g,2)+":"+a(c,2)+"."+a(m,3)},n.printRanges=function(t){var e=t.length;if(e>0){for(var s="",a=0;a<e;a++)a>0&&(s+=","),s+="["+n.getDurationString(t.start(a))+","+n.getDurationString(t.end(a))+"]";return s}else return"(empty)"},d.Log=n;var l=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};l.prototype.getPosition=function(){return this.position},l.prototype.getEndPosition=function(){return this.buffer.byteLength},l.prototype.getLength=function(){return this.buffer.byteLength},l.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},l.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},l.prototype.readAnyInt=function(t,e){var s=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?s=this.dataview.getInt8(this.position):s=this.dataview.getUint8(this.position);break;case 2:e?s=this.dataview.getInt16(this.position):s=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";s=this.dataview.getUint8(this.position)<<16,s|=this.dataview.getUint8(this.position+1)<<8,s|=this.dataview.getUint8(this.position+2);break;case 4:e?s=this.dataview.getInt32(this.position):s=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";s=this.dataview.getUint32(this.position)<<32,s|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,s}else throw"Not enough bytes in buffer"},l.prototype.readUint8=function(){return this.readAnyInt(1,!1)},l.prototype.readUint16=function(){return this.readAnyInt(2,!1)},l.prototype.readUint24=function(){return this.readAnyInt(3,!1)},l.prototype.readUint32=function(){return this.readAnyInt(4,!1)},l.prototype.readUint64=function(){return this.readAnyInt(8,!1)},l.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",s=0;s<t;s++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"},l.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)},l.prototype.readInt8=function(){return this.readAnyInt(1,!0)},l.prototype.readInt16=function(){return this.readAnyInt(2,!0)},l.prototype.readInt32=function(){return this.readAnyInt(4,!0)},l.prototype.readInt64=function(){return this.readAnyInt(8,!1)},l.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),s=0;s<t;s++)e[s]=this.readUint8();return e},l.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),s=0;s<t;s++)e[s]=this.readInt16();return e},l.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),s=0;s<t;s++)e[s]=this.readUint16();return e},l.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),s=0;s<t;s++)e[s]=this.readUint32();return e},l.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),s=0;s<t;s++)e[s]=this.readInt32();return e},d.MP4BoxStream=l;var o=function(t,e,s){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=s??o.LITTLE_ENDIAN};o.prototype={},o.prototype.getPosition=function(){return this.position},o.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,s=this._buffer.byteLength;if(e<=s){e>this._byteLength&&(this._byteLength=e);return}for(s<1&&(s=1);e>s;)s*=2;var a=new ArrayBuffer(s),h=new Uint8Array(this._buffer),c=new Uint8Array(a,0,h.length);c.set(h),this.buffer=a,this._byteLength=e}},o.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),s=new Uint8Array(this._buffer,0,e.length);e.set(s),this.buffer=t}},o.BIG_ENDIAN=!1,o.LITTLE_ENDIAN=!0,o.prototype._byteLength=0,Object.defineProperty(o.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(o.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(o.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(o.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),o.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},o.prototype.isEof=function(){return this.position>=this._byteLength},o.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},o.prototype.readInt32Array=function(t,e){t=t??this.byteLength-this.position/4;var s=new Int32Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s},o.prototype.readInt16Array=function(t,e){t=t??this.byteLength-this.position/2;var s=new Int16Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s},o.prototype.readInt8Array=function(t){t=t??this.byteLength-this.position;var e=new Int8Array(t);return o.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},o.prototype.readUint32Array=function(t,e){t=t??this.byteLength-this.position/4;var s=new Uint32Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s},o.prototype.readUint16Array=function(t,e){t=t??this.byteLength-this.position/2;var s=new Uint16Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s},o.prototype.readUint8Array=function(t){t=t??this.byteLength-this.position;var e=new Uint8Array(t);return o.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},o.prototype.readFloat64Array=function(t,e){t=t??this.byteLength-this.position/8;var s=new Float64Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s},o.prototype.readFloat32Array=function(t,e){t=t??this.byteLength-this.position/4;var s=new Float32Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s},o.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t??this.endianness);return this.position+=4,e},o.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t??this.endianness);return this.position+=2,e},o.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},o.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t??this.endianness);return this.position+=4,e},o.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t??this.endianness);return this.position+=2,e},o.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},o.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t??this.endianness);return this.position+=4,e},o.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t??this.endianness);return this.position+=8,e},o.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,o.memcpy=function(t,e,s,a,h){var c=new Uint8Array(t,e,h),p=new Uint8Array(s,a,h);c.set(p)},o.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},o.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},o.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),s=0;s<t.byteLength;s+=t.BYTES_PER_ELEMENT)for(var a=s+t.BYTES_PER_ELEMENT-1,h=s;a>h;a--,h++){var c=e[h];e[h]=e[a],e[a]=c}return t},o.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],s=0;s<t.length;s++)e[s]=t[s];return String.fromCharCode.apply(null,e)},o.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t??this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))},o.prototype.readCString=function(t){var e=this.byteLength-this.position,s=new Uint8Array(this._buffer,this._byteOffset+this.position),a=e;t!=null&&(a=Math.min(t,e));for(var h=0;h<a&&s[h]!==0;h++);var c=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(h)]);return t!=null?this.position+=a-h:h!=e&&(this.position+=1),c};var f=Math.pow(2,32);o.prototype.readInt64=function(){return this.readInt32()*f+this.readUint32()},o.prototype.readUint64=function(){return this.readUint32()*f+this.readUint32()},o.prototype.readInt64=function(){return this.readUint32()*f+this.readUint32()},o.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},d.DataStream=o,o.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var s=window.URL.createObjectURL(e),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("href",s),a.setAttribute("download",t),a.setAttribute("target","_self"),a.click(),window.URL.revokeObjectURL(s)}else throw"DataStream.save: Can't create object URL."},o.prototype._dynamicSize=!0,Object.defineProperty(o.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),o.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),s=new Uint8Array(e),a=new Uint8Array(this._buffer,t,s.length);s.set(a),this.buffer=e,this.position-=t},o.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeInt32(t[s],e)},o.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeInt16(t[s],e)},o.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},o.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeUint32(t[s],e)},o.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeUint16(t[s],e)},o.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},o.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeFloat64(t[s],e)},o.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeFloat32(t[s],e)},o.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e??this.endianness),this.position+=4},o.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e??this.endianness),this.position+=2},o.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},o.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e??this.endianness),this.position+=4},o.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e??this.endianness),this.position+=2},o.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},o.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e??this.endianness),this.position+=4},o.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e??this.endianness),this.position+=8},o.prototype.writeUCS2String=function(t,e,s){s==null&&(s=t.length);for(var a=0;a<t.length&&a<s;a++)this.writeUint16(t.charCodeAt(a),e);for(;a<s;a++)this.writeUint16(0)},o.prototype.writeString=function(t,e,s){var a=0;if(e==null||e=="ASCII")if(s!=null){var h=Math.min(t.length,s);for(a=0;a<h;a++)this.writeUint8(t.charCodeAt(a));for(;a<s;a++)this.writeUint8(0)}else for(a=0;a<t.length;a++)this.writeUint8(t.charCodeAt(a));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,s)))},o.prototype.writeCString=function(t,e){var s=0;if(e!=null){var a=Math.min(t.length,e);for(s=0;s<a;s++)this.writeUint8(t.charCodeAt(s));for(;s<e;s++)this.writeUint8(0)}else{for(s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));this.writeUint8(0)}},o.prototype.writeStruct=function(t,e){for(var s=0;s<t.length;s+=2){var a=t[s+1];this.writeType(a,e[t[s]],e)}},o.prototype.writeType=function(t,e,s){var a;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,s);var h=null,c="ASCII",p=this.position;switch(typeof t=="string"&&/:/.test(t)&&(a=t.split(":"),t=a[0],h=parseInt(a[1])),typeof t=="string"&&/,/.test(t)&&(a=t.split(","),t=a[0],c=parseInt(a[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,o.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,o.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,o.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,o.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,o.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,o.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,o.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,o.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,o.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,o.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,o.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,o.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,h);break;case"string":this.writeString(e,c,h);break;case"u16string":this.writeUCS2String(e,this.endianness,h);break;case"u16stringle":this.writeUCS2String(e,o.LITTLE_ENDIAN,h);break;case"u16stringbe":this.writeUCS2String(e,o.BIG_ENDIAN,h);break;default:if(t.length==3){for(var g=t[1],m=0;m<e.length;m++)this.writeType(g,e[m]);break}else{this.writeStruct(t,e);break}}h!=null&&(this.position=p,this._realloc(h),this.position=p+h)},o.prototype.writeUint64=function(t){var e=Math.floor(t/f);this.writeUint32(e),this.writeUint32(t&4294967295)},o.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)},o.prototype.adjustUint32=function(t,e){var s=this.position;this.seek(t),this.writeUint32(e),this.seek(s)},o.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var s=new Int32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e??this.endianness),this.position+=t*4,s},o.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var s=new Int16Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e??this.endianness),this.position+=t*2,s},o.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},o.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var s=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e??this.endianness),this.position+=t*4,s},o.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var s=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e??this.endianness),this.position+=t*2,s},o.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var s=new Float64Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e??this.endianness),this.position+=t*8,s},o.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var s=new Float32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e??this.endianness),this.position+=t*4,s};var u=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};u.prototype=new o(new ArrayBuffer,0,o.BIG_ENDIAN),u.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,n.debug("MultiBufferStream","Stream ready for parsing"),!0):(n.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(n.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)},ArrayBuffer.concat=function(t,e){n.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var s=new Uint8Array(t.byteLength+e.byteLength);return s.set(new Uint8Array(t),0),s.set(new Uint8Array(e),t.byteLength),s.buffer},u.prototype.reduceBuffer=function(t,e,s){var a;return a=new Uint8Array(s),a.set(new Uint8Array(t,e,s)),a.buffer.fileStart=t.fileStart+e,a.buffer.usedBytes=0,a.buffer},u.prototype.insertBuffer=function(t){for(var e=!0,s=0;s<this.buffers.length;s++){var a=this.buffers[s];if(t.fileStart<=a.fileStart){if(t.fileStart===a.fileStart)if(t.byteLength>a.byteLength){this.buffers.splice(s,1),s--;continue}else n.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=a.fileStart||(t=this.reduceBuffer(t,0,a.fileStart-t.fileStart)),n.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(s,0,t),s===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<a.fileStart+a.byteLength){var h=a.fileStart+a.byteLength-t.fileStart,c=t.byteLength-h;if(c>0)t=this.reduceBuffer(t,h,c);else{e=!1;break}}}e&&(n.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),s===0&&(this.buffer=t))},u.prototype.logBufferLevel=function(t){var e,s,a,h,c=[],p,g="";for(a=0,h=0,e=0;e<this.buffers.length;e++)s=this.buffers[e],e===0?(p={},c.push(p),p.start=s.fileStart,p.end=s.fileStart+s.byteLength,g+="["+p.start+"-"):p.end===s.fileStart?p.end=s.fileStart+s.byteLength:(p={},p.start=s.fileStart,g+=c[c.length-1].end-1+"], ["+p.start+"-",p.end=s.fileStart+s.byteLength,c.push(p)),a+=s.usedBytes,h+=s.byteLength;c.length>0&&(g+=p.end-1+"]");var m=t?n.info:n.debug;this.buffers.length===0?m("MultiBufferStream","No more buffer in memory"):m("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+a+"/"+h+" bytes), continuous ranges: "+g)},u.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(n.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},u.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,s=this.buffer.usedBytes,a=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=s,this.buffer.fileStart=a,n.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1},u.prototype.findPosition=function(t,e,s){var a,h=null,c=-1;for(t===!0?a=0:a=this.bufferIndex;a<this.buffers.length&&(h=this.buffers[a],h.fileStart<=e);){c=a,s&&(h.fileStart+h.byteLength<=e?h.usedBytes=h.byteLength:h.usedBytes=e-h.fileStart,this.logBufferLevel());a++}return c!==-1?(h=this.buffers[c],h.fileStart+h.byteLength>=e?(n.debug("MultiBufferStream","Found position in existing buffer #"+c),c):-1):-1},u.prototype.findEndContiguousBuf=function(t){var e,s,a,h=t!==void 0?t:this.bufferIndex;if(s=this.buffers[h],this.buffers.length>h+1)for(e=h+1;e<this.buffers.length&&(a=this.buffers[e],a.fileStart===s.fileStart+s.byteLength);e++)s=a;return s.fileStart+s.byteLength},u.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t},u.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},u.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},u.prototype.seek=function(t,e,s){var a;return a=this.findPosition(e,t,s),a!==-1?(this.buffer=this.buffers[a],this.bufferIndex=a,this.position=t-this.buffer.fileStart,n.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(n.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},u.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},u.prototype.getLength=function(){return this.byteLength},u.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},d.MultiBufferStream=u;var _=function(){var t=3,e=4,s=5,a=6,h=[];h[t]="ES_Descriptor",h[e]="DecoderConfigDescriptor",h[s]="DecoderSpecificInfo",h[a]="SLConfigDescriptor",this.getDescriptorName=function(g){return h[g]};var c=this,p={};return this.parseOneDescriptor=function(g){var m=0,b,w,U;for(b=g.readUint8(),U=g.readUint8();U&128;)m=(U&127)<<7,U=g.readUint8();return m+=U&127,n.debug("MPEG4DescriptorParser","Found "+(h[b]||"Descriptor "+b)+", size "+m+" at position "+g.getPosition()),h[b]?w=new p[h[b]](m):w=new p.Descriptor(m),w.parse(g),w},p.Descriptor=function(g,m){this.tag=g,this.size=m,this.descs=[]},p.Descriptor.prototype.parse=function(g){this.data=g.readUint8Array(this.size)},p.Descriptor.prototype.findDescriptor=function(g){for(var m=0;m<this.descs.length;m++)if(this.descs[m].tag==g)return this.descs[m];return null},p.Descriptor.prototype.parseRemainingDescriptors=function(g){for(var m=g.position;g.position<m+this.size;){var b=c.parseOneDescriptor(g);this.descs.push(b)}},p.ES_Descriptor=function(g){p.Descriptor.call(this,t,g)},p.ES_Descriptor.prototype=new p.Descriptor,p.ES_Descriptor.prototype.parse=function(g){if(this.ES_ID=g.readUint16(),this.flags=g.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=g.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var m=g.readUint8();this.URL=g.readString(m),this.size-=m+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=g.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(g)},p.ES_Descriptor.prototype.getOTI=function(g){var m=this.findDescriptor(e);return m?m.oti:0},p.ES_Descriptor.prototype.getAudioConfig=function(g){var m=this.findDescriptor(e);if(!m)return null;var b=m.findDescriptor(s);if(b&&b.data){var w=(b.data[0]&248)>>3;return w===31&&b.data.length>=2&&(w=32+((b.data[0]&7)<<3)+((b.data[1]&224)>>5)),w}else return null},p.DecoderConfigDescriptor=function(g){p.Descriptor.call(this,e,g)},p.DecoderConfigDescriptor.prototype=new p.Descriptor,p.DecoderConfigDescriptor.prototype.parse=function(g){this.oti=g.readUint8(),this.streamType=g.readUint8(),this.upStream=(this.streamType>>1&1)!==0,this.streamType=this.streamType>>>2,this.bufferSize=g.readUint24(),this.maxBitrate=g.readUint32(),this.avgBitrate=g.readUint32(),this.size-=13,this.parseRemainingDescriptors(g)},p.DecoderSpecificInfo=function(g){p.Descriptor.call(this,s,g)},p.DecoderSpecificInfo.prototype=new p.Descriptor,p.SLConfigDescriptor=function(g){p.Descriptor.call(this,a,g)},p.SLConfigDescriptor.prototype=new p.Descriptor,this};d.MPEG4DescriptorParser=_;var r={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){r.FullBox.prototype=new r.Box,r.ContainerBox.prototype=new r.Box,r.SampleEntry.prototype=new r.Box,r.TrackGroupTypeBox.prototype=new r.FullBox,r.BASIC_BOXES.forEach(function(t){r.createBoxCtor(t)}),r.FULL_BOXES.forEach(function(t){r.createFullBoxCtor(t)}),r.CONTAINER_BOXES.forEach(function(t){r.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,s){this.type=t,this.size=e,this.uuid=s},FullBox:function(t,e,s){r.Box.call(this,t,e,s),this.flags=0,this.version=0},ContainerBox:function(t,e,s){r.Box.call(this,t,e,s),this.boxes=[]},SampleEntry:function(t,e,s,a){r.ContainerBox.call(this,t,e),this.hdr_size=s,this.start=a},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){r.FullBox.call(this,t,e)},createBoxCtor:function(t,e){r.boxCodes.push(t),r[t+"Box"]=function(s){r.Box.call(this,t,s)},r[t+"Box"].prototype=new r.Box,e&&(r[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){r[t+"Box"]=function(s){r.FullBox.call(this,t,s)},r[t+"Box"].prototype=new r.FullBox,r[t+"Box"].prototype.parse=function(s){this.parseFullHeader(s),e&&e.call(this,s)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,s=0;s<e;s++)this[t[s]+"s"]=[]}},createContainerBoxCtor:function(t,e,s){r[t+"Box"]=function(a){r.ContainerBox.call(this,t,a),r.addSubBoxArrays.call(this,s)},r[t+"Box"].prototype=new r.ContainerBox,e&&(r[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,s){r.sampleEntryCodes[t]=[],r[t+"SampleEntry"]=function(a,h){r.SampleEntry.call(this,a,h),r.addSubBoxArrays.call(this,s)},r[t+"SampleEntry"].prototype=new r.SampleEntry,e&&(r[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,s,a){r.sampleEntryCodes[t].push(e),r[e+"SampleEntry"]=function(h){r[t+"SampleEntry"].call(this,e,h),r.addSubBoxArrays.call(this,a)},r[e+"SampleEntry"].prototype=new r[t+"SampleEntry"],s&&(r[e+"SampleEntry"].prototype.parse=s)},createEncryptedSampleEntryCtor:function(t,e,s){r.createSampleEntryCtor.call(this,t,e,s,["sinf"])},createSampleGroupCtor:function(t,e){r[t+"SampleGroupEntry"]=function(s){r.SampleGroupEntry.call(this,t,s)},r[t+"SampleGroupEntry"].prototype=new r.SampleGroupEntry,e&&(r[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){r[t+"TrackGroupTypeBox"]=function(s){r.TrackGroupTypeBox.call(this,t,s)},r[t+"TrackGroupTypeBox"].prototype=new r.TrackGroupTypeBox,e&&(r[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,s,a){r.UUIDs.push(t),r.UUIDBoxes[t]=function(h){e?r.FullBox.call(this,"uuid",h,t):s?r.ContainerBox.call(this,"uuid",h,t):r.Box.call(this,"uuid",h,t)},r.UUIDBoxes[t].prototype=e?new r.FullBox:s?new r.ContainerBox:new r.Box,a&&(e?r.UUIDBoxes[t].prototype.parse=function(h){this.parseFullHeader(h),a&&a.call(this,h)}:r.UUIDBoxes[t].prototype.parse=a)}};r.initialize(),r.TKHD_FLAG_ENABLED=1,r.TKHD_FLAG_IN_MOVIE=2,r.TKHD_FLAG_IN_PREVIEW=4,r.TFHD_FLAG_BASE_DATA_OFFSET=1,r.TFHD_FLAG_SAMPLE_DESC=2,r.TFHD_FLAG_SAMPLE_DUR=8,r.TFHD_FLAG_SAMPLE_SIZE=16,r.TFHD_FLAG_SAMPLE_FLAGS=32,r.TFHD_FLAG_DUR_EMPTY=65536,r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,r.TRUN_FLAGS_DATA_OFFSET=1,r.TRUN_FLAGS_FIRST_FLAG=4,r.TRUN_FLAGS_DURATION=256,r.TRUN_FLAGS_SIZE=512,r.TRUN_FLAGS_FLAGS=1024,r.TRUN_FLAGS_CTS_OFFSET=2048,r.Box.prototype.add=function(t){return this.addBox(new r[t+"Box"])},r.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},r.Box.prototype.set=function(t,e){return this[t]=e,this},r.Box.prototype.addEntry=function(t,e){var s=e||"entries";return this[s]||(this[s]=[]),this[s].push(t),this},d.BoxParser=r,r.parseUUID=function(t){return r.parseHex16(t)},r.parseHex16=function(t){for(var e="",s=0;s<16;s++){var a=t.readUint8().toString(16);e+=a.length===1?"0"+a:a}return e},r.parseOneBox=function(t,e,s){var a,h=t.getPosition(),c=0,p,g;if(t.getEndPosition()-h<8)return n.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:r.ERR_NOT_ENOUGH_DATA};if(s&&s<8)return n.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:r.ERR_NOT_ENOUGH_DATA};var m=t.readUint32(),b=t.readString(4),w=b;if(n.debug("BoxParser","Found box of type '"+b+"' and size "+m+" at position "+h),c=8,b=="uuid"){if(t.getEndPosition()-t.getPosition()<16||s-c<16)return t.seek(h),n.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:r.ERR_NOT_ENOUGH_DATA};g=r.parseUUID(t),c+=16,w=g}if(m==1){if(t.getEndPosition()-t.getPosition()<8||s&&s-c<8)return t.seek(h),n.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+b+'" box'),{code:r.ERR_NOT_ENOUGH_DATA};m=t.readUint64(),c+=8}else if(m===0){if(s)m=s;else if(b!=="mdat")return n.error("BoxParser","Unlimited box size not supported for type: '"+b+"'"),a=new r.Box(b,m),{code:r.OK,box:a,size:a.size}}return m!==0&&m<c?(n.error("BoxParser","Box of type "+b+" has an invalid size "+m+" (too small to be a box)"),{code:r.ERR_NOT_ENOUGH_DATA,type:b,size:m,hdr_size:c,start:h}):m!==0&&s&&m>s?(n.error("BoxParser","Box of type '"+b+"' has a size "+m+" greater than its container size "+s),{code:r.ERR_NOT_ENOUGH_DATA,type:b,size:m,hdr_size:c,start:h}):m!==0&&h+m>t.getEndPosition()?(t.seek(h),n.info("BoxParser","Not enough data in stream to parse the entire '"+b+"' box"),{code:r.ERR_NOT_ENOUGH_DATA,type:b,size:m,hdr_size:c,start:h}):e?{code:r.OK,type:b,size:m,hdr_size:c,start:h}:(r[b+"Box"]?a=new r[b+"Box"](m):b!=="uuid"?(n.warn("BoxParser","Unknown box type: '"+b+"'"),a=new r.Box(b,m),a.has_unparsed_data=!0):r.UUIDBoxes[g]?a=new r.UUIDBoxes[g](m):(n.warn("BoxParser","Unknown uuid type: '"+g+"'"),a=new r.Box(b,m),a.uuid=g,a.has_unparsed_data=!0),a.hdr_size=c,a.start=h,a.write===r.Box.prototype.write&&a.type!=="mdat"&&(n.info("BoxParser","'"+w+"' box writing not yet implemented, keeping unparsed data in memory for later write"),a.parseDataAndRewind(t)),a.parse(t),p=t.getPosition()-(a.start+a.size),p<0?(n.warn("BoxParser","Parsing of box '"+w+"' did not read the entire indicated box data size (missing "+-p+" bytes), seeking forward"),t.seek(a.start+a.size)):p>0&&(n.error("BoxParser","Parsing of box '"+w+"' read "+p+" more bytes than the indicated box data size, seeking backwards"),a.size!==0&&t.seek(a.start+a.size)),{code:r.OK,box:a,size:a.size})},r.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},r.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},r.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},r.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},r.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},r.ContainerBox.prototype.parse=function(t){for(var e,s;t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)if(s=e.box,this.boxes.push(s),this.subBoxNames&&this.subBoxNames.indexOf(s.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(s.type)]+"s"].push(s);else{var a=s.type!=="uuid"?s.type:s.uuid;this[a]?n.warn("Box of type "+a+" already stored in field of this type"):this[a]=s}else return},r.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},r.SAMPLE_ENTRY_TYPE_VISUAL="Visual",r.SAMPLE_ENTRY_TYPE_AUDIO="Audio",r.SAMPLE_ENTRY_TYPE_HINT="Hint",r.SAMPLE_ENTRY_TYPE_METADATA="Metadata",r.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",r.SAMPLE_ENTRY_TYPE_SYSTEM="System",r.SAMPLE_ENTRY_TYPE_TEXT="Text",r.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},r.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},r.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},r.SampleEntry.prototype.parseFooter=function(t){r.ContainerBox.prototype.parse.call(this,t)},r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_HINT),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SYSTEM),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_TEXT),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"dav1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avs3"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"uncv"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mha1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mha2"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"fLaC"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_TEXT,"enct"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"encm"),r.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,s=((e&1)+1)*16;this.layer_size=[];for(var a=0;a<3;a++)s==16?this.layer_size[a]=t.readUint16():this.layer_size[a]=t.readUint32()}),r.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),r.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),r.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){n.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){n.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){n.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){n.error("av1C reserved_2 parsing problem");return}var s=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(s)}),r.createBoxCtor("avcC",function(t){var e,s;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,s=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),s-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),s--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),s-=2+this.PPS[e].length;s>0&&(this.ext=t.readUint8Array(s))}),r.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),r.createFullBoxCtor("ccst",function(t){var e=t.readUint8();this.all_ref_pics_intra=(e&128)==128,this.intra_pred_used=(e&64)==64,this.max_ref_per_pic=(e&63)>>2,t.readUint24()}),r.createBoxCtor("cdef",function(t){var e;for(this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())}),r.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),r.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),r.createFullBoxCtor("cmex",function(t){this.flags&1&&(this.pos_x=t.readInt32()),this.flags&2&&(this.pos_y=t.readInt32()),this.flags&4&&(this.pos_z=t.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version==1),this.flags&32&&(this.id=t.readUint32())}),r.createFullBoxCtor("cmin",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),this.flags&1&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())}),r.createBoxCtor("cmpd",function(t){for(this.component_count=t.readUint32(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}}),r.createFullBoxCtor("co64",function(t){var e,s;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(s=0;s<e;s++)this.chunk_offsets.push(t.readUint64())}),r.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),r.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))}),r.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),r.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),r.createFullBoxCtor("ctts",function(t){var e,s;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(s=0;s<e;s++){this.sample_counts.push(t.readUint32());var a=t.readInt32();a<0&&n.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(a)}else if(this.version==1)for(s=0;s<e;s++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),r.createBoxCtor("dac3",function(t){var e=t.readUint8(),s=t.readUint8(),a=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|s>>6&3,this.acmod=s>>3&7,this.lfeon=s>>2&1,this.bit_rate_code=s&3|a>>5&7}),r.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var s=0;s<this.num_ind_sub+1;s++){var a={};this.ind_subs.push(a);var h=t.readUint8(),c=t.readUint8(),p=t.readUint8();a.fscod=h>>6,a.bsid=h>>1&31,a.bsmod=(h&1)<<4|c>>4&15,a.acmod=c>>1&7,a.lfeon=c&1,a.num_dep_sub=p>>1&15,a.num_dep_sub>0&&(a.chan_loc=(p&1)<<8|t.readUint8())}}),r.createFullBoxCtor("dfLa",function(t){var e=127,s=128,a=[],h=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];do{var c=t.readUint8(),p=Math.min(c&e,h.length-1);if(p?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),a.push(h[p]),c&s)break}while(!0);this.numMetadataBlocks=a.length+" ("+a.join(", ")+")"}),r.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),r.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),r.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),r.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),r.createFullBoxCtor("dref",function(t){var e,s;this.entries=[];for(var a=t.readUint32(),h=0;h<a;h++)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)s=e.box,this.entries.push(s);else return}),r.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),r.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),r.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),s=0;s<e;s++){var a={};this.entries.push(a),this.version===1?(a.segment_duration=t.readUint64(),a.media_time=t.readInt64()):(a.segment_duration=t.readUint32(),a.media_time=t.readInt32()),a.media_rate_integer=t.readInt16(),a.media_rate_fraction=t.readInt16()}}),r.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(16+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)}),r.createEntityToGroupCtor=function(t,e){r[t+"Box"]=function(s){r.FullBox.call(this,t,s)},r[t+"Box"].prototype=new r.FullBox,r[t+"Box"].prototype.parse=function(s){if(this.parseFullHeader(s),e)e.call(this,s);else for(this.group_id=s.readUint32(),this.num_entities_in_group=s.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var a=s.readUint32();this.entity_ids.push(a)}}},r.createEntityToGroupCtor("aebr"),r.createEntityToGroupCtor("afbr"),r.createEntityToGroupCtor("albc"),r.createEntityToGroupCtor("altr"),r.createEntityToGroupCtor("brst"),r.createEntityToGroupCtor("dobr"),r.createEntityToGroupCtor("eqiv"),r.createEntityToGroupCtor("favc"),r.createEntityToGroupCtor("fobr"),r.createEntityToGroupCtor("iaug"),r.createEntityToGroupCtor("pano"),r.createEntityToGroupCtor("slid"),r.createEntityToGroupCtor("ster"),r.createEntityToGroupCtor("tsyn"),r.createEntityToGroupCtor("wbbr"),r.createEntityToGroupCtor("prgr"),r.createEntityToGroupCtor("pymd",function(t){this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(var e=0;e<this.num_entities_in_group;e++){var s=t.readUint32();this.entity_ids.push(s)}for(this.tile_size_x=t.readUint16(),this.tile_size_y=t.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[],e=0;e<this.num_entities_in_group;e++)this.layer_binning[e]=t.readUint16(),this.tiles_in_layer_row_minus1[e]=t.readUint16(),this.tiles_in_layer_column_minus1[e]=t.readUint16()}),r.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(this.data=e,typeof _<"u"){var s=new _;this.esd=s.parseOneDescriptor(new o(e.buffer,0,o.BIG_ENDIAN))}}),r.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),r.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),r.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var s=0;e>=4;)this.compatible_brands[s]=t.readString(4),e-=4,s++}),r.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))}),r.createBoxCtor("hvcC",function(t){var e,s,a,h;this.configurationVersion=t.readUint8(),h=t.readUint8(),this.general_profile_space=h>>6,this.general_tier_flag=(h&32)>>5,this.general_profile_idc=h&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),h=t.readUint8(),this.constantFrameRate=h>>6,this.numTemporalLayers=(h&13)>>3,this.temporalIdNested=(h&4)>>2,this.lengthSizeMinusOne=h&3,this.nalu_arrays=[];var c=t.readUint8();for(e=0;e<c;e++){var p=[];this.nalu_arrays.push(p),h=t.readUint8(),p.completeness=(h&128)>>7,p.nalu_type=h&63;var g=t.readUint16();for(s=0;s<g;s++){var m={};p.push(m),a=t.readUint16(),m.data=t.readUint8Array(a)}}}),r.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var s=0;s<this.entry_count;s++)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)e.box.type!=="infe"&&n.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[s]=e.box;else return}),r.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var s=0;if(this.version<2)s=t.readUint16();else if(this.version===2)s=t.readUint32();else throw"version of iloc box not supported";for(var a=0;a<s;a++){var h={};if(this.items.push(h),this.version<2)h.item_ID=t.readUint16();else if(this.version===2)h.item_ID=t.readUint32();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?h.construction_method=t.readUint16()&15:h.construction_method=0,h.data_reference_index=t.readUint16(),this.base_offset_size){case 0:h.base_offset=0;break;case 4:h.base_offset=t.readUint32();break;case 8:h.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var c=t.readUint16();h.extents=[];for(var p=0;p<c;p++){var g={};if(h.extents.push(g),this.version===1||this.version===2)switch(this.index_size){case 0:g.extent_index=0;break;case 4:g.extent_index=t.readUint32();break;case 8:g.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:g.extent_offset=0;break;case 4:g.extent_offset=t.readUint32();break;case 8:g.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:g.extent_length=0;break;case 4:g.extent_length=t.readUint32();break;case 8:g.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),r.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1}),r.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),n.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))}),r.createFullBoxCtor("ipma",function(t){var e,s;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var a={};this.associations.push(a),this.version<1?a.id=t.readUint16():a.id=t.readUint32();var h=t.readUint8();for(a.props=[],s=0;s<h;s++){var c=t.readUint8(),p={};a.props.push(p),p.essential=(c&128)>>7===1,this.flags&1?p.property_index=(c&127)<<8|t.readUint8():p.property_index=c&127}}}),r.createFullBoxCtor("iref",function(t){var e,s;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===r.OK)this.version===0?s=new r.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):s=new r.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),s.write===r.Box.prototype.write&&s.type!=="mdat"&&(n.warn("BoxParser",s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),this.references.push(s);else return}),r.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3}),r.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),r.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),r.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var s=0;s<e;s++){var a={};this.levels[s]=a,a.track_ID=t.readUint32();var h=t.readUint8();switch(a.padding_flag=h>>7,a.assignment_type=h&127,a.assignment_type){case 0:a.grouping_type=t.readString(4);break;case 1:a.grouping_type=t.readString(4),a.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:a.sub_track_id=t.readUint32();break;default:n.warn("BoxParser","Unknown leva assignement type")}}}),r.createBoxCtor("lhvC",function(t){var e,s,a;this.configurationVersion=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,a=t.readUint8(),this.numTemporalLayers=(a&13)>>3,this.temporalIdNested=(a&4)>>2,this.lengthSizeMinusOne=a&3,this.nalu_arrays=[];var h=t.readUint8();for(e=0;e<h;e++){var c=[];this.nalu_arrays.push(c),a=t.readUint8(),c.completeness=(a&128)>>7,c.nalu_type=a&63;var p=t.readUint16();for(s=0;s<p;s++){var g={};c.push(g);var m=t.readUint16();g.data=t.readUint8Array(m)}}}),r.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),r.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()});function v(t,e){this.x=t,this.y=e}v.prototype.toString=function(){return"("+this.x+","+this.y+")"},r.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]=new v(t.readUint16(),t.readUint16()),this.display_primaries[1]=new v(t.readUint16(),t.readUint16()),this.display_primaries[2]=new v(t.readUint16(),t.readUint16()),this.white_point=new v(t.readUint16(),t.readUint16()),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),r.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),r.createFullBoxCtor("mehd",function(t){this.flags&1&&(n.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),r.createFullBoxCtor("meta",function(t){this.boxes=[],r.ContainerBox.prototype.parse.call(this,t)}),r.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),r.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),r.createFullBoxCtor("mskC",function(t){this.bits_per_pixel=t.readUint8()}),r.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),r.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),r.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),r.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var s=0;s<Math.floor((e+1)/2);s++)this.padbits=t.readUint8()}),r.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),r.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),r.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),r.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var s=0;s<e;s++)this.rate[s]=t.readUint32(),this.initial_delay[s]=t.readUint32()}),r.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()}),r.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),r.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),r.createFullBoxCtor("prdi",function(t){if(this.step_count=t.readUint16(),this.item_count=[],this.flags&2)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()}),r.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()}),r.createFullBoxCtor("pssh",function(t){if(this.system_id=r.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var s=0;s<e;s++)this.kid[s]=r.parseHex16(t)}var a=t.readUint32();a>0&&(this.data=t.readUint8Array(a))}),r.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),r.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),r.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),r.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),r.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),r.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var s=0;s<e;s++)this.version===0?this.offset[s]=t.readUint32():this.offset[s]=t.readUint64()}),r.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var s=0;s<e;s++)this.sample_info_size[s]=t.readUint8()}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),r.createSampleGroupCtor("alst",function(t){var e,s=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<s;e++)this.sample_offset[e]=t.readUint32();var a=this.description_length-4-4*s;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<a/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),r.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),r.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var s=t.readUint8(),a=0;a<s;a++){var h={};this.dependency.push(h),h.subSeqDirectionFlag=t.readUint8(),h.layerNumber=t.readUint8(),h.subSequenceIdentifier=t.readUint16()}}),r.createSampleGroupCtor("dtrt",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("mvif",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),r.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}),r.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)n.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),r.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),r.SampleGroupEntry.prototype.parse=function(t){n.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},r.createSampleGroupCtor("scif",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("scnm",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=r.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),r.createSampleGroupCtor("stsa",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63}),r.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),r.createSampleGroupCtor("tsas",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("tscl",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("vipr",function(t){n.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),s=0;s<e;s++){var a={};this.entries.push(a),a.sample_count=t.readInt32(),a.group_description_index=t.readInt32()}});function E(t,e){this.bad_pixel_row=t,this.bad_pixel_column=e}E.prototype.toString=function(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"},r.createFullBoxCtor("sbpm",function(t){var e;for(this.component_count=t.readUint16(),this.component_index=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16());var s=t.readUint8();for(this.correction_applied=(s&128)==128,this.num_bad_rows=t.readUint32(),this.num_bad_cols=t.readUint32(),this.num_bad_pixels=t.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[],e=0;e<this.num_bad_rows;e++)this.bad_rows.push(t.readUint32());for(e=0;e<this.num_bad_cols;e++)this.bad_columns.push(t.readUint32());for(e=0;e<this.num_bad_pixels;e++){var a=t.readUint32(),h=t.readUint32();this.bad_pixels.push(new E(a,h))}}),r.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),r.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),r.createFullBoxCtor("sdtp",function(t){var e,s=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var a=0;a<s;a++)e=t.readUint8(),this.is_leading[a]=e>>6,this.sample_depends_on[a]=e>>4&3,this.sample_is_depended_on[a]=e>>2&3,this.sample_has_redundancy[a]=e&3}),r.createFullBoxCtor("senc"),r.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),n.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),s=0;s<e;s++){var a;r[this.grouping_type+"SampleGroupEntry"]?a=new r[this.grouping_type+"SampleGroupEntry"](this.grouping_type):a=new r.SampleGroupEntry(this.grouping_type),this.entries.push(a),this.version===1?this.default_length===0?a.description_length=t.readUint32():a.description_length=this.default_length:a.description_length=this.default_length,a.write===r.SampleGroupEntry.prototype.write&&(n.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),a.data=t.readUint8Array(a.description_length),t.position-=a.description_length),a.parse(t)}}),r.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),s=0;s<e;s++){var a={};this.references.push(a);var h=t.readUint32();a.reference_type=h>>31&1,a.referenced_size=h&2147483647,a.subsegment_duration=t.readUint32(),h=t.readUint32(),a.starts_with_SAP=h>>31&1,a.SAP_type=h>>28&7,a.SAP_delta_time=h&268435455}}),r.SingleItemTypeReferenceBox=function(t,e,s,a){r.Box.call(this,t,e),this.hdr_size=s,this.start=a},r.SingleItemTypeReferenceBox.prototype=new r.Box,r.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var s=0;s<e;s++)this.references[s]={},this.references[s].to_item_ID=t.readUint16()},r.SingleItemTypeReferenceBoxLarge=function(t,e,s,a){r.Box.call(this,t,e),this.hdr_size=s,this.start=a},r.SingleItemTypeReferenceBoxLarge.prototype=new r.Box,r.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var s=0;s<e;s++)this.references[s]={},this.references[s].to_item_ID=t.readUint32()},r.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),r.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),r.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),s=0;s<e;s++){var a={};this.subsegments.push(a),a.ranges=[];for(var h=t.readUint32(),c=0;c<h;c++){var p={};a.ranges.push(p),p.level=t.readUint8(),p.range_size=t.readUint24()}}}),r.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var s=0;s<e;s++)this.chunk_offsets.push(t.readUint32())}),r.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var s=0;s<e;s++)this.priority[s]=t.readUint16()}),r.createFullBoxCtor("sthd"),r.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var s=0;s<e;s++)this.attribute_list[s]=t.readUint32()}),r.createFullBoxCtor("stsc",function(t){var e,s;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(s=0;s<e;s++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),r.createFullBoxCtor("stsd",function(t){var e,s,a,h;for(this.entries=[],a=t.readUint32(),e=1;e<=a;e++)if(s=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),s.code===r.OK)r[s.type+"SampleEntry"]?(h=new r[s.type+"SampleEntry"](s.size),h.hdr_size=s.hdr_size,h.start=s.start):(n.warn("BoxParser","Unknown sample entry type: "+s.type),h=new r.SampleEntry(s.type,s.size,s.hdr_size,s.start)),h.write===r.SampleEntry.prototype.write&&(n.info("BoxParser","SampleEntry "+h.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),h.parseDataAndRewind(t)),h.parse(t),this.entries.push(h);else return}),r.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var s=0;s<e;s++)this.group_description_index[s]=t.readUint32()}),r.createFullBoxCtor("stsh",function(t){var e,s;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(s=0;s<e;s++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),r.createFullBoxCtor("stss",function(t){var e,s;if(s=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<s;e++)this.sample_numbers.push(t.readUint32())}),r.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),r.createFullBoxCtor("stts",function(t){var e,s,a;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(s=0;s<e;s++)this.sample_counts.push(t.readUint32()),a=t.readInt32(),a<0&&(n.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),a=1),this.sample_deltas.push(a)}),r.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var s=t.readUint32();this.stereo_indication_type=t.readString(s);var a,h;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(a=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),a.code===r.OK)h=a.box,this.boxes.push(h),this[h.type]=h;else return}),r.createBoxCtor("styp",function(t){r.ftypBox.prototype.parse.call(this,t)}),r.createFullBoxCtor("stz2",function(t){var e,s;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),s=t.readUint32(),this.field_size===4)for(e=0;e<s;e+=2){var a=t.readUint8();this.sample_sizes[e]=a>>4&15,this.sample_sizes[e+1]=a&15}else if(this.field_size===8)for(e=0;e<s;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<s;e++)this.sample_sizes[e]=t.readUint16();else n.error("BoxParser","Error in length field in stz2 box")}),r.createFullBoxCtor("subs",function(t){var e,s,a,h;for(a=t.readUint32(),this.entries=[],e=0;e<a;e++){var c={};if(this.entries[e]=c,c.sample_delta=t.readUint32(),c.subsamples=[],h=t.readUint16(),h>0)for(s=0;s<h;s++){var p={};c.subsamples.push(p),this.version==1?p.size=t.readUint32():p.size=t.readUint16(),p.priority=t.readUint8(),p.discardable=t.readUint8(),p.codec_specific_parameters=t.readUint32()}}}),r.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=r.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),r.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),r.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),r.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var s=t.readUint32(),a=0;a<s;a++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),r.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),r.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),r.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),r.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),r.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),r.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),r.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},r.createTrackGroupCtor("msrc"),r.TrackReferenceTypeBox=function(t,e,s,a){r.Box.call(this,t,e),this.hdr_size=s,this.start=a},r.TrackReferenceTypeBox.prototype=new r.Box,r.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},r.trefBox.prototype.parse=function(t){for(var e,s;t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===r.OK)s=new r.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),s.write===r.Box.prototype.write&&s.type!=="mdat"&&(n.info("BoxParser","TrackReference "+s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),this.boxes.push(s);else return},r.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===r.OK)box=ret.box,this.boxes.push(box);else return}),r.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),r.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),r.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&r.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&r.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var s=0;s<this.sample_count;s++)this.flags&r.TRUN_FLAGS_DURATION&&(this.sample_duration[s]=t.readUint32()),this.flags&r.TRUN_FLAGS_SIZE&&(this.sample_size[s]=t.readUint32()),this.flags&r.TRUN_FLAGS_FLAGS&&(this.sample_flags[s]=t.readUint32()),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[s]=t.readUint32():this.sample_composition_time_offset[s]=t.readInt32())}),r.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var s=0;s<e;s++)this.attribute_list[s]=t.readUint32()}),r.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),r.createBoxCtor("tyco",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var s=0;s<e;s++)this.compatible_brands[s]=t.readString(4)}),r.createFullBoxCtor("udes",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()}),r.createFullBoxCtor("uncC",function(t){var e;if(this.profile=t.readUint32(),this.version!=1){if(this.version==0){for(this.component_count=t.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var s=t.readUint8();this.component_little_endian=s>>7&1,this.block_pad_lsb=s>>6&1,this.block_little_endian=s>>5&1,this.block_reversed=s>>4&1,this.pad_unknown=s>>3&1,this.pixel_size=t.readUint32(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}}}),r.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())}),r.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),r.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),r.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=r.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),r.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),r.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=r.parseHex16(t)}),r.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var s={},a=0,h=0;this.version===1?(a=t.readUint64(),h=t.readUint64()):(a=t.readUint32(),h=t.readUint32()),s.absolute_time=a,s.absolute_duration=h,this.entries.push(s)}}),r.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),r.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),r.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))}),r.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),r.createFullBoxCtor("vvcC",function(t){var e,s,a={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(S){this.held_bits=S.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(S){this.held_bits=S.readUint16(),this.num_held_bits=16},extract_bits:function(S){var z=this.held_bits>>this.num_held_bits-S&(1<<S)-1;return this.num_held_bits-=S,z}};if(a.stream_read_1_bytes(t),a.extract_bits(5),this.lengthSizeMinusOne=a.extract_bits(2),this.ptl_present_flag=a.extract_bits(1),this.ptl_present_flag){a.stream_read_2_bytes(t),this.ols_idx=a.extract_bits(9),this.num_sublayers=a.extract_bits(3),this.constant_frame_rate=a.extract_bits(2),this.chroma_format_idc=a.extract_bits(2),a.stream_read_1_bytes(t),this.bit_depth_minus8=a.extract_bits(3),a.extract_bits(5);{if(a.stream_read_2_bytes(t),a.extract_bits(2),this.num_bytes_constraint_info=a.extract_bits(6),this.general_profile_idc=a.extract_bits(7),this.general_tier_flag=a.extract_bits(1),this.general_level_idc=t.readUint8(),a.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=a.extract_bits(1),this.ptl_multilayer_enabled_flag=a.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var h=a.extract_bits(6);a.stream_read_1_bytes(t);var c=a.extract_bits(2);this.general_constraint_info[e]=h<<2|c}this.general_constraint_info[this.num_bytes_constraint_info-1]=a.extract_bits(6)}else a.extract_bits(6);if(this.num_sublayers>1){for(a.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,s=this.num_sublayers-2;s>=0;--s){var p=a.extract_bits(1);this.ptl_sublayer_present_mask|=p<<s}for(s=this.num_sublayers;s<=8&&this.num_sublayers>1;++s)a.extract_bits(1);for(this.sublayer_level_idc=[],s=this.num_sublayers-2;s>=0;--s)this.ptl_sublayer_present_mask&1<<s&&(this.sublayer_level_idc[s]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var g=12,m=13;this.nalu_arrays=[];var b=t.readUint8();for(e=0;e<b;e++){var w=[];this.nalu_arrays.push(w),a.stream_read_1_bytes(t),w.completeness=a.extract_bits(1),a.extract_bits(2),w.nalu_type=a.extract_bits(5);var U=1;for(w.nalu_type!=m&&w.nalu_type!=g&&(U=t.readUint16()),s=0;s<U;s++){var B=t.readUint16();w.push({data:t.readUint8Array(B),length:B})}}}),r.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3}),r.SampleEntry.prototype.isVideo=function(){return!1},r.SampleEntry.prototype.isAudio=function(){return!1},r.SampleEntry.prototype.isSubtitle=function(){return!1},r.SampleEntry.prototype.isMetadata=function(){return!1},r.SampleEntry.prototype.isHint=function(){return!1},r.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},r.SampleEntry.prototype.getWidth=function(){return""},r.SampleEntry.prototype.getHeight=function(){return""},r.SampleEntry.prototype.getChannelCount=function(){return""},r.SampleEntry.prototype.getSampleRate=function(){return""},r.SampleEntry.prototype.getSampleSize=function(){return""},r.VisualSampleEntry.prototype.isVideo=function(){return!0},r.VisualSampleEntry.prototype.getWidth=function(){return this.width},r.VisualSampleEntry.prototype.getHeight=function(){return this.height},r.AudioSampleEntry.prototype.isAudio=function(){return!0},r.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},r.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},r.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},r.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},r.MetadataSampleEntry.prototype.isMetadata=function(){return!0},r.decimalToHex=function(t,e){var s=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;s.length<e;)s="0"+s;return s},r.avc1SampleEntry.prototype.getCodec=r.avc2SampleEntry.prototype.getCodec=r.avc3SampleEntry.prototype.getCodec=r.avc4SampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+r.decimalToHex(this.avcC.AVCProfileIndication)+r.decimalToHex(this.avcC.profile_compatibility)+r.decimalToHex(this.avcC.AVCLevelIndication):t},r.hev1SampleEntry.prototype.getCodec=r.hvc1SampleEntry.prototype.getCodec=function(){var t,e=r.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var s=this.hvcC.general_profile_compatibility,a=0;for(t=0;t<32&&(a|=s&1,t!=31);t++)a<<=1,s>>=1;e+=r.decimalToHex(a,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var h=!1,c="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||h)&&(c="."+r.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+c,h=!0);e+=c}return e},r.vvc1SampleEntry.prototype.getCodec=r.vvi1SampleEntry.prototype.getCodec=function(){var t,e=r.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var s="";if(this.vvcC.general_constraint_info){var a=[],h=0;h|=this.vvcC.ptl_frame_only_constraint<<7,h|=this.vvcC.ptl_multilayer_enabled<<6;var c;for(t=0;t<this.vvcC.general_constraint_info.length;++t)h|=this.vvcC.general_constraint_info[t]>>2&63,a.push(h),h&&(c=t),h=this.vvcC.general_constraint_info[t]>>2&3;if(c===void 0)s=".CA";else{s=".C";var p="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",g=0,m=0;for(t=0;t<=c;++t)for(g=g<<8|a[t],m+=8;m>=5;){var b=g>>m-5&31;s+=p[b],m-=5,g&=(1<<m)-1}m&&(g<<=5-m,s+=p[g&31])}}e+=s}return e},r.mp4aSampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),s=this.esds.esd.getAudioConfig();return t+"."+r.decimalToHex(e)+(s?"."+s:"")}else return t},r.stxtSampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},r.vp08SampleEntry.prototype.getCodec=r.vp09SampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var s=this.vpcC.bitDepth;return s==8&&(s="08"),t+".0"+this.vpcC.profile+"."+e+"."+s},r.av01SampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var s;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?s=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(s=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+s},r.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>f&&(this.size+=8),this.type==="uuid"&&(this.size+=16),n.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>f?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>f&&t.writeUint64(this.size)},r.FullBox.prototype.writeHeader=function(t){this.size+=4,r.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},r.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},r.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)},r.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},r.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},r.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},r.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},r.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},r.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var s=this.entries[e];t.writeUint32(s.segment_duration),t.writeInt32(s.media_time),t.writeInt16(s.media_rate_integer),t.writeInt16(s.media_rate_fraction)}},r.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=16+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},r.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},r.hdlrBox.prototype.write=function(t){this.size=20+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},r.hvcCBox.prototype.write=function(t){var e,s;for(this.size=23,e=0;e<this.nalu_arrays.length;e++)for(this.size+=3,s=0;s<this.nalu_arrays[e].length;s++)this.size+=2+this.nalu_arrays[e][s].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),s=0;s<this.nalu_arrays[e].length;s++)t.writeUint16(this.nalu_arrays[e][s].data.length),t.writeUint8Array(this.nalu_arrays[e][s].data)},r.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},r.mdhdBox.prototype.write=function(t){this.size=20,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},r.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},r.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},r.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=96,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},r.SampleEntry.prototype.writeHeader=function(t){this.size=8,r.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},r.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=70,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},r.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=20,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},r.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},r.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},r.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var s=this.entries[e];t.writeInt32(s.sample_count),t.writeInt32(s.group_description_index)}},r.sgpdBox.prototype.write=function(t){var e,s;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)s=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=s.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)s=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(s.description_length),s.write(t)},r.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var s=this.references[e];t.writeUint32(s.reference_type<<31|s.referenced_size),t.writeUint32(s.subsegment_duration),t.writeUint32(s.starts_with_SAP<<31|s.SAP_type<<28|s.SAP_delta_time)}},r.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},r.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},r.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},r.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;n.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},r.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},r.stszBox.prototype.write=function(t){var e,s=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){s=!1;break}else e++;else s=!1;this.size=8,s||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),s?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),s||t.writeUint32Array(this.sample_sizes)},r.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},r.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},r.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&r.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&r.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&r.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&r.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&r.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},r.tkhdBox.prototype.write=function(t){this.version=0,this.size=80,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},r.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},r.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&r.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&r.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&r.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&r.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&r.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&r.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&r.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&r.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&r.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&r.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},r["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},r["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},r.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},r.vpcCBox.prototype.write=function(t){this.version=1;const e=8+this.codecIntializationDataSize;this.size=e,this.writeHeader(t),t.writeUint8(this.profile),t.writeUint8(this.level);let s=this.bitDepth<<4|(this.chromaSubsampling&7)<<1|this.videoFullRangeFlag&1;t.writeUint8(s),t.writeUint8(this.colourPrimaries),t.writeUint8(this.transferCharacteristics),t.writeUint8(this.matrixCoefficients),t.writeUint16(this.codecIntializationDataSize),this.codecIntializationDataSize>0&&t.writeUint8Array(this.codecIntializationData)},r.cttsBox.prototype.unpack=function(t){var e,s,a;for(a=0,e=0;e<this.sample_counts.length;e++)for(s=0;s<this.sample_counts[e];s++)t[a].pts=t[a].dts+this.sample_offsets[e],a++},r.sttsBox.prototype.unpack=function(t){var e,s,a;for(a=0,e=0;e<this.sample_counts.length;e++)for(s=0;s<this.sample_counts[e];s++)a===0?t[a].dts=0:t[a].dts=t[a-1].dts+this.sample_deltas[e],a++},r.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},r.stscBox.prototype.unpack=function(t){var e,s,a,h,c;for(h=0,c=0,e=0;e<this.first_chunk.length;e++)for(s=0;s<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);s++)for(c++,a=0;a<this.samples_per_chunk[e];a++){if(t[h])t[h].description_index=this.sample_description_index[e],t[h].chunk_index=c;else return;h++}},r.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},r.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],r.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],r.boxEqualFields=function(t,e){if(t&&!e)return!1;var s;for(s in t)if(!(r.DIFF_BOXES_PROP_NAMES.indexOf(s)>-1)){if(t[s]instanceof r.Box||e[s]instanceof r.Box)continue;if(typeof t[s]>"u"||typeof e[s]>"u")continue;if(typeof t[s]=="function"||typeof e[s]=="function")continue;if(t.subBoxNames&&t.subBoxNames.indexOf(s.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(s.slice(0,4))>-1)continue;if(s==="data"||s==="start"||s==="size"||s==="creation_time"||s==="modification_time")continue;if(r.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(s)>-1)continue;if(t[s]!==e[s])return!1}return!0},r.boxEqual=function(t,e){if(!r.boxEqualFields(t,e))return!1;for(var s=0;s<r.DIFF_BOXES_PROP_NAMES.length;s++){var a=r.DIFF_BOXES_PROP_NAMES[s];if(t[a]&&e[a]&&!r.boxEqual(t[a],e[a]))return!1}return!0};var x=function(){};x.prototype.parseSample=function(t){var e={},s;e.resources=[];var a=new l(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=a.readString(t.data.length);else if(e.documentString=a.readString(t.subsamples[0].size),t.subsamples.length>1)for(s=1;s<t.subsamples.length;s++)e.resources[s]=a.readUint8Array(t.subsamples[s].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var F=function(){};F.prototype.parseSample=function(t){var e,s=new l(t.data.buffer);return e=s.readString(t.data.length),e},F.prototype.parseConfig=function(t){var e,s=new l(t.buffer);return s.readUint32(),e=s.readCString(),e},d.XMLSubtitlein4Parser=x,d.Textin4Parser=F;var y=function(t){this.stream=t||new u,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};y.prototype.setSegmentOptions=function(t,e,s){var a=this.getTrackById(t);if(a){var h={};this.fragmentedTracks.push(h),h.id=t,h.user=e,h.trak=a,a.nextSample=0,h.segmentStream=null,h.nb_samples=1e3,h.rapAlignement=!0,s&&(s.nbSamples&&(h.nb_samples=s.nbSamples),s.rapAlignement&&(h.rapAlignement=s.rapAlignement))}},y.prototype.unsetSegmentOptions=function(t){for(var e=-1,s=0;s<this.fragmentedTracks.length;s++){var a=this.fragmentedTracks[s];a.id==t&&(e=s)}e>-1&&this.fragmentedTracks.splice(e,1)},y.prototype.setExtractionOptions=function(t,e,s){var a=this.getTrackById(t);if(a){var h={};this.extractedTracks.push(h),h.id=t,h.user=e,h.trak=a,a.nextSample=0,h.nb_samples=1e3,h.samples=[],s&&s.nbSamples&&(h.nb_samples=s.nbSamples)}},y.prototype.unsetExtractionOptions=function(t){for(var e=-1,s=0;s<this.extractedTracks.length;s++){var a=this.extractedTracks[s];a.id==t&&(e=s)}e>-1&&this.extractedTracks.splice(e,1)},y.prototype.parse=function(){var t,e,s=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=r.parseOneBox(this.stream,s),t.code===r.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var a;switch(e=t.box,a=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),a){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[a]!==void 0&&n.warn("ISOFile","Duplicate Box of type: "+a+", overriding previous occurrence"),this[a]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},y.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(n.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(n.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(n.warn("ISOFile","Not ready to start parsing"),!1))},y.prototype.appendBuffer=function(t,e){var s;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(s=this.nextSeekPosition,this.nextSeekPosition=void 0):s=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(s=this.stream.getEndFilePositionAfter(s))):this.nextParsePosition?s=this.nextParsePosition:s=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(n.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+s),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),n.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),s},y.prototype.getInfo=function(){var t,e,s={},a,h,c,p,g=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(s.hasMoov=!0,s.duration=this.moov.mvhd.duration,s.timescale=this.moov.mvhd.timescale,s.isFragmented=this.moov.mvex!=null,s.isFragmented&&this.moov.mvex.mehd&&(s.fragment_duration=this.moov.mvex.mehd.fragment_duration),s.isProgressive=this.isProgressive,s.hasIOD=this.moov.iods!=null,s.brands=[],s.brands.push(this.ftyp.major_brand),s.brands=s.brands.concat(this.ftyp.compatible_brands),s.created=new Date(g+this.moov.mvhd.creation_time*1e3),s.modified=new Date(g+this.moov.mvhd.modification_time*1e3),s.tracks=[],s.audioTracks=[],s.videoTracks=[],s.subtitleTracks=[],s.metadataTracks=[],s.hintTracks=[],s.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(a=this.moov.traks[t],p=a.mdia.minf.stbl.stsd.entries[0],h={},s.tracks.push(h),h.id=a.tkhd.track_id,h.name=a.mdia.hdlr.name,h.references=[],a.tref)for(e=0;e<a.tref.boxes.length;e++)c={},h.references.push(c),c.type=a.tref.boxes[e].type,c.track_ids=a.tref.boxes[e].track_ids;a.edts&&(h.edits=a.edts.elst.entries),h.created=new Date(g+a.tkhd.creation_time*1e3),h.modified=new Date(g+a.tkhd.modification_time*1e3),h.movie_duration=a.tkhd.duration,h.movie_timescale=s.timescale,h.layer=a.tkhd.layer,h.alternate_group=a.tkhd.alternate_group,h.volume=a.tkhd.volume,h.matrix=a.tkhd.matrix,h.track_width=a.tkhd.width/65536,h.track_height=a.tkhd.height/65536,h.timescale=a.mdia.mdhd.timescale,h.cts_shift=a.mdia.minf.stbl.cslg,h.duration=a.mdia.mdhd.duration,h.samples_duration=a.samples_duration,h.codec=p.getCodec(),h.kind=a.udta&&a.udta.kinds.length?a.udta.kinds[0]:{schemeURI:"",value:""},h.language=a.mdia.elng?a.mdia.elng.extended_language:a.mdia.mdhd.languageString,h.nb_samples=a.samples.length,h.size=a.samples_size,h.bitrate=h.size*8*h.timescale/h.samples_duration,p.isAudio()?(h.type="audio",s.audioTracks.push(h),h.audio={},h.audio.sample_rate=p.getSampleRate(),h.audio.channel_count=p.getChannelCount(),h.audio.sample_size=p.getSampleSize()):p.isVideo()?(h.type="video",s.videoTracks.push(h),h.video={},h.video.width=p.getWidth(),h.video.height=p.getHeight()):p.isSubtitle()?(h.type="subtitles",s.subtitleTracks.push(h)):p.isHint()?(h.type="metadata",s.hintTracks.push(h)):p.isMetadata()?(h.type="metadata",s.metadataTracks.push(h)):(h.type="metadata",s.otherTracks.push(h))}else s.hasMoov=!1;if(s.mime="",s.hasMoov&&s.tracks){for(s.videoTracks&&s.videoTracks.length>0?s.mime+='video/mp4; codecs="':s.audioTracks&&s.audioTracks.length>0?s.mime+='audio/mp4; codecs="':s.mime+='application/mp4; codecs="',t=0;t<s.tracks.length;t++)t!==0&&(s.mime+=","),s.mime+=s.tracks[t].codec;s.mime+='"; profiles="',s.mime+=this.ftyp.compatible_brands.join(),s.mime+='"'}return s},y.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)},y.prototype.processSamples=function(t){var e,s;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var a=this.fragmentedTracks[e];for(s=a.trak;s.nextSample<s.samples.length&&this.sampleProcessingStarted;){n.debug("ISOFile","Creating media fragment on track #"+a.id+" for sample "+s.nextSample);var h=this.createFragment(a.id,s.nextSample,a.segmentStream);if(h)a.segmentStream=h,s.nextSample++;else break;if((s.nextSample%a.nb_samples===0||t||s.nextSample>=s.samples.length)&&(n.info("ISOFile","Sending fragmented data on track #"+a.id+" for samples ["+Math.max(0,s.nextSample-a.nb_samples)+","+(s.nextSample-1)+"]"),n.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(a.id,a.user,a.segmentStream.buffer,s.nextSample,t||s.nextSample>=s.samples.length),a.segmentStream=null,a!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var c=this.extractedTracks[e];for(s=c.trak;s.nextSample<s.samples.length&&this.sampleProcessingStarted;){n.debug("ISOFile","Exporting on track #"+c.id+" sample #"+s.nextSample);var p=this.getSample(s,s.nextSample);if(p)s.nextSample++,c.samples.push(p);else{this.setNextSeekPositionFromSample(s.samples[s.nextSample]);break}if((s.nextSample%c.nb_samples===0||s.nextSample>=s.samples.length)&&(n.debug("ISOFile","Sending samples on track #"+c.id+" for sample "+s.nextSample),this.onSamples&&this.onSamples(c.id,c.user,c.samples),c.samples=[],c!==this.extractedTracks[e]))break}}}},y.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},y.prototype.getBoxes=function(t,e){var s=[];return y._sweep.call(this,t,s,e),s},y._sweep=function(t,e,s){this.type&&this.type==t&&e.push(this);for(var a in this.boxes){if(e.length&&s)return;y._sweep.call(this.boxes[a],t,e,s)}},y.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples},y.prototype.getTrackSample=function(t,e){var s=this.getTrackById(t),a=this.getSample(s,e);return a},y.prototype.releaseUsedSamples=function(t,e){var s=0,a=this.getTrackById(t);a.lastValidSample||(a.lastValidSample=0);for(var h=a.lastValidSample;h<e;h++)s+=this.releaseSample(a,h);n.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+s+", remaining: "+this.samplesDataSize+")"),a.lastValidSample=e},y.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},y.prototype.stop=function(){this.sampleProcessingStarted=!1},y.prototype.flush=function(){n.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},y.prototype.seekTrack=function(t,e,s){var a,h,c=1/0,p=0,g=0,m;if(s.samples.length===0)return n.info("ISOFile","No sample in track, cannot seek! Using time "+n.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(a=0;a<s.samples.length;a++){if(h=s.samples[a],a===0)g=0,m=h.timescale;else if(h.cts>t*h.timescale){g=a-1;break}e&&h.is_sync&&(p=a)}for(e&&(g=p),t=s.samples[g].cts,s.nextSample=g;s.samples[g].alreadyRead===s.samples[g].size&&s.samples[g+1];)g++;return c=s.samples[g].offset+s.samples[g].alreadyRead,n.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+s.nextSample+" on track "+s.tkhd.track_id+", time "+n.getDurationString(t,m)+" and offset: "+c),{offset:c,time:t/m}},y.prototype.getTrackDuration=function(t){var e;return t.samples?(e=t.samples[t.samples.length-1],(e.cts+e.duration)/e.timescale):1/0},y.prototype.seek=function(t,e){var s=this.moov,a,h,c,p={offset:1/0,time:1/0};if(this.moov){for(c=0;c<s.traks.length;c++)a=s.traks[c],!(t>this.getTrackDuration(a))&&(h=this.seekTrack(t,e,a),h.offset<p.offset&&(p.offset=h.offset),h.time<p.time&&(p.time=h.time));return n.info("ISOFile","Seeking at time "+n.getDurationString(p.time,1)+" needs a buffer with a fileStart position of "+p.offset),p.offset===1/0?p={offset:this.nextParsePosition,time:0}:p.offset=this.stream.getEndFilePositionAfter(p.offset),n.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+p.offset),p}else throw"Cannot seek: moov not received!"},y.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var s=this.boxes[e],a=t.boxes[e];if(!r.boxEqual(s,a))return!1;e++}return!0},d.ISOFile=y,y.prototype.lastBoxStartPosition=0,y.prototype.parsingMdat=null,y.prototype.nextParsePosition=0,y.prototype.discardMdatData=!1,y.prototype.processIncompleteBox=function(t){var e,s,a;return t.type==="mdat"?(e=new r[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,a=this.stream.seek(e.start+e.size,!1,this.discardMdatData),a?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),s=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,s?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},y.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null},y.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(n.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},y.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},y.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},y.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},y.prototype.add=r.Box.prototype.add,y.prototype.addBox=r.Box.prototype.addBox,y.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var s=this.add("moov");return s.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),s.add("mvex"),this},y.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var s=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,s.add("tkhd").set("flags",r.TKHD_FLAG_ENABLED|r.TKHD_FLAG_IN_MOVIE|r.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("width",e.width<<16).set("height",e.height<<16);var a=s.add("mdia");a.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),a.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),a.add("elng").set("extended_language",e.language||"fr-FR");var h=a.add("minf");if(r[e.type+"SampleEntry"]!==void 0){var c=new r[e.type+"SampleEntry"];c.data_reference_index=1;var p="";for(var g in r.sampleEntryCodes)for(var m=r.sampleEntryCodes[g],b=0;b<m.length;b++)if(m.indexOf(e.type)>-1){p=g;break}switch(p){case"Visual":if(h.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),c.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var w=new r.avcCBox;w.parse(new l(e.avcDecoderConfigRecord)),c.addBox(w)}else if(e.hevcDecoderConfigRecord){var U=new r.hvcCBox;U.parse(new l(e.hevcDecoderConfigRecord)),c.addBox(U)}else if(e.vpcDecoderConfigRecord){var B=new r.vpcCBox;B.parse(new l(e.vpcDecoderConfigRecord)),c.addBox(B)}break;case"Audio":h.add("smhd").set("balance",e.balance||0),c.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":h.add("hmhd");break;case"Subtitle":switch(h.add("sthd"),e.type){case"stpp":c.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":h.add("nmhd");break;case"System":h.add("nmhd");break;default:h.add("nmhd");break}e.description&&c.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(z){c.addBox(z)}),h.add("dinf").add("dref").addEntry(new r["url Box"]().set("flags",1));var S=h.add("stbl");return S.add("stsd").addEntry(c),S.add("stts").set("sample_counts",[]).set("sample_deltas",[]),S.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),S.add("stco").set("chunk_offsets",[]),S.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(s),e.id}},r.Box.prototype.computeSize=function(t){var e=t||new o;e.endianness=o.BIG_ENDIAN,this.write(e)},y.prototype.addSample=function(t,e,s){var a=s||{},h={},c=this.getTrackById(t);if(c!==null){h.number=c.samples.length,h.track_id=c.tkhd.track_id,h.timescale=c.mdia.mdhd.timescale,h.description_index=a.sample_description_index?a.sample_description_index-1:0,h.description=c.mdia.minf.stbl.stsd.entries[h.description_index],h.data=e,h.size=e.byteLength,h.alreadyRead=h.size,h.duration=a.duration||1,h.cts=a.cts||0,h.dts=a.dts||0,h.is_sync=a.is_sync||!1,h.is_leading=a.is_leading||0,h.depends_on=a.depends_on||0,h.is_depended_on=a.is_depended_on||0,h.has_redundancy=a.has_redundancy||0,h.degradation_priority=a.degradation_priority||0,h.offset=0,h.subsamples=a.subsamples,c.samples.push(h),c.samples_size+=h.size,c.samples_duration+=h.duration,c.first_dts===void 0&&(c.first_dts=a.dts),this.processSamples();var p=this.createSingleSampleMoof(h);return this.addBox(p),p.computeSize(),p.trafs[0].truns[0].data_offset=p.size+8,this.add("mdat").data=new Uint8Array(e),h}},y.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var s=new r.moofBox;s.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var a=s.add("traf"),h=this.getTrackById(t.track_id);return a.add("tfhd").set("track_id",t.track_id).set("flags",r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),a.add("tfdt").set("baseMediaDecodeTime",t.dts-(h.first_dts||0)),a.add("trun").set("flags",r.TRUN_FLAGS_DATA_OFFSET|r.TRUN_FLAGS_DURATION|r.TRUN_FLAGS_SIZE|r.TRUN_FLAGS_FLAGS|r.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),s},y.prototype.lastMoofIndex=0,y.prototype.samplesDataSize=0,y.prototype.resetTables=function(){var t,e,s,a,h,c,p,g;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,s=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,s.chunk_offsets=[],a=e.mdia.minf.stbl.stsc,a.first_chunk=[],a.samples_per_chunk=[],a.sample_description_index=[],h=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,h.sample_sizes=[],c=e.mdia.minf.stbl.stts,c.sample_counts=[],c.sample_deltas=[],p=e.mdia.minf.stbl.ctts,p&&(p.sample_counts=[],p.sample_offsets=[]),g=e.mdia.minf.stbl.stss;var m=e.mdia.minf.stbl.boxes.indexOf(g);m!=-1&&(e.mdia.minf.stbl.boxes[m]=null)}},y.initSampleGroups=function(t,e,s,a,h){var c,p,g,m;function b(w,U,B){this.grouping_type=w,this.grouping_type_parameter=U,this.sbgp=B,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),p=0;p<s.length;p++){for(m=s[p].grouping_type+"/"+s[p].grouping_type_parameter,g=new b(s[p].grouping_type,s[p].grouping_type_parameter,s[p]),e&&(e.sample_groups_info[m]=g),t.sample_groups_info[m]||(t.sample_groups_info[m]=g),c=0;c<a.length;c++)a[c].grouping_type===s[p].grouping_type&&(g.description=a[c],g.description.used=!0);if(h)for(c=0;c<h.length;c++)h[c].grouping_type===s[p].grouping_type&&(g.fragment_description=h[c],g.fragment_description.used=!0,g.is_fragment=!0)}if(e){if(h)for(p=0;p<h.length;p++)!h[p].used&&h[p].version>=2&&(m=h[p].grouping_type+"/0",g=new b(h[p].grouping_type,0),g.is_fragment=!0,e.sample_groups_info[m]||(e.sample_groups_info[m]=g))}else for(p=0;p<a.length;p++)!a[p].used&&a[p].version>=2&&(m=a[p].grouping_type+"/0",g=new b(a[p].grouping_type,0),t.sample_groups_info[m]||(t.sample_groups_info[m]=g))},y.setSampleGroupProperties=function(t,e,s,a){var h,c;e.sample_groups=[];for(h in a)if(e.sample_groups[h]={},e.sample_groups[h].grouping_type=a[h].grouping_type,e.sample_groups[h].grouping_type_parameter=a[h].grouping_type_parameter,s>=a[h].last_sample_in_run&&(a[h].last_sample_in_run<0&&(a[h].last_sample_in_run=0),a[h].entry_index++,a[h].entry_index<=a[h].sbgp.entries.length-1&&(a[h].last_sample_in_run+=a[h].sbgp.entries[a[h].entry_index].sample_count)),a[h].entry_index<=a[h].sbgp.entries.length-1?e.sample_groups[h].group_description_index=a[h].sbgp.entries[a[h].entry_index].group_description_index:e.sample_groups[h].group_description_index=-1,e.sample_groups[h].group_description_index!==0){var p;a[h].fragment_description?p=a[h].fragment_description:p=a[h].description,e.sample_groups[h].group_description_index>0?(e.sample_groups[h].group_description_index>65535?c=(e.sample_groups[h].group_description_index>>16)-1:c=e.sample_groups[h].group_description_index-1,p&&c>=0&&(e.sample_groups[h].description=p.entries[c])):p&&p.version>=2&&p.default_group_description_index>0&&(e.sample_groups[h].description=p.entries[p.default_group_description_index-1])}},y.process_sdtp=function(t,e,s){e&&(t?(e.is_leading=t.is_leading[s],e.depends_on=t.sample_depends_on[s],e.is_depended_on=t.sample_is_depended_on[s],e.has_redundancy=t.sample_has_redundancy[s]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},y.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},y.prototype.buildTrakSampleLists=function(t){var e,s,a,h,c,p,g,m,b,w,U,B,S,z,P,rt,ut,K,O,X,zt,Xt,j,pt;if(t.samples=[],t.samples_duration=0,t.samples_size=0,s=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,a=t.mdia.minf.stbl.stsc,h=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,c=t.mdia.minf.stbl.stts,p=t.mdia.minf.stbl.ctts,g=t.mdia.minf.stbl.stss,m=t.mdia.minf.stbl.stsd,b=t.mdia.minf.stbl.subs,B=t.mdia.minf.stbl.stdp,w=t.mdia.minf.stbl.sbgps,U=t.mdia.minf.stbl.sgpds,K=-1,O=-1,X=-1,zt=-1,Xt=0,j=0,pt=0,y.initSampleGroups(t,null,w,U),!(typeof h>"u")){for(e=0;e<h.sample_sizes.length;e++){var C={};C.number=e,C.track_id=t.tkhd.track_id,C.timescale=t.mdia.mdhd.timescale,C.alreadyRead=0,t.samples[e]=C,C.size=h.sample_sizes[e],t.samples_size+=C.size,e===0?(z=1,S=0,C.chunk_index=z,C.chunk_run_index=S,ut=a.samples_per_chunk[S],rt=0,S+1<a.first_chunk.length?P=a.first_chunk[S+1]-1:P=1/0):e<ut?(C.chunk_index=z,C.chunk_run_index=S):(z++,C.chunk_index=z,rt=0,z<=P||(S++,S+1<a.first_chunk.length?P=a.first_chunk[S+1]-1:P=1/0),C.chunk_run_index=S,ut+=a.samples_per_chunk[S]),C.description_index=a.sample_description_index[C.chunk_run_index]-1,C.description=m.entries[C.description_index],C.offset=s.chunk_offsets[C.chunk_index-1]+rt,rt+=C.size,e>K&&(O++,K<0&&(K=0),K+=c.sample_counts[O]),e>0?(t.samples[e-1].duration=c.sample_deltas[O],t.samples_duration+=t.samples[e-1].duration,C.dts=t.samples[e-1].dts+t.samples[e-1].duration):C.dts=0,p?(e>=X&&(zt++,X<0&&(X=0),X+=p.sample_counts[zt]),C.cts=t.samples[e].dts+p.sample_offsets[zt]):C.cts=C.dts,g?(e==g.sample_numbers[Xt]-1?(C.is_sync=!0,Xt++):(C.is_sync=!1,C.degradation_priority=0),b&&b.entries[j].sample_delta+pt==e+1&&(C.subsamples=b.entries[j].subsamples,pt+=b.entries[j].sample_delta,j++)):C.is_sync=!0,y.process_sdtp(t.mdia.minf.stbl.sdtp,C,C.number),B?C.degradation_priority=B.priority[e]:C.degradation_priority=0,b&&b.entries[j].sample_delta+pt==e&&(C.subsamples=b.entries[j].subsamples,pt+=b.entries[j].sample_delta),(w.length>0||U.length>0)&&y.setSampleGroupProperties(t,C,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},y.prototype.updateSampleLists=function(){var t,e,s,a,h,c,p,g,m,b,w,U,B,S,z;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(m=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,m.type=="moof")for(b=m,t=0;t<b.trafs.length;t++){for(w=b.trafs[t],U=this.getTrackById(w.tfhd.track_id),U.samples==null&&(U.samples=[]),B=this.getTrexById(w.tfhd.track_id),w.tfhd.flags&r.TFHD_FLAG_SAMPLE_DESC?a=w.tfhd.default_sample_description_index:a=B?B.default_sample_description_index:1,w.tfhd.flags&r.TFHD_FLAG_SAMPLE_DUR?h=w.tfhd.default_sample_duration:h=B?B.default_sample_duration:0,w.tfhd.flags&r.TFHD_FLAG_SAMPLE_SIZE?c=w.tfhd.default_sample_size:c=B?B.default_sample_size:0,w.tfhd.flags&r.TFHD_FLAG_SAMPLE_FLAGS?p=w.tfhd.default_sample_flags:p=B?B.default_sample_flags:0,w.sample_number=0,w.sbgps.length>0&&y.initSampleGroups(U,w,w.sbgps,U.mdia.minf.stbl.sgpds,w.sgpds),e=0;e<w.truns.length;e++){var P=w.truns[e];for(s=0;s<P.sample_count;s++){S={},S.moof_number=this.lastMoofIndex,S.number_in_traf=w.sample_number,w.sample_number++,S.number=U.samples.length,w.first_sample_index=U.samples.length,U.samples.push(S),S.track_id=U.tkhd.track_id,S.timescale=U.mdia.mdhd.timescale,S.description_index=a-1,S.description=U.mdia.minf.stbl.stsd.entries[S.description_index],S.size=c,P.flags&r.TRUN_FLAGS_SIZE&&(S.size=P.sample_size[s]),U.samples_size+=S.size,S.duration=h,P.flags&r.TRUN_FLAGS_DURATION&&(S.duration=P.sample_duration[s]),U.samples_duration+=S.duration,U.first_traf_merged||s>0?S.dts=U.samples[U.samples.length-2].dts+U.samples[U.samples.length-2].duration:(w.tfdt?S.dts=w.tfdt.baseMediaDecodeTime:S.dts=0,U.first_traf_merged=!0),S.cts=S.dts,P.flags&r.TRUN_FLAGS_CTS_OFFSET&&(S.cts=S.dts+P.sample_composition_time_offset[s]),z=p,P.flags&r.TRUN_FLAGS_FLAGS?z=P.sample_flags[s]:s===0&&P.flags&r.TRUN_FLAGS_FIRST_FLAG&&(z=P.first_sample_flags),S.is_sync=!(z>>16&1),S.is_leading=z>>26&3,S.depends_on=z>>24&3,S.is_depended_on=z>>22&3,S.has_redundancy=z>>20&3,S.degradation_priority=z&65535;var rt=!!(w.tfhd.flags&r.TFHD_FLAG_BASE_DATA_OFFSET),ut=!!(w.tfhd.flags&r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),K=!!(P.flags&r.TRUN_FLAGS_DATA_OFFSET),O=0;rt?O=w.tfhd.base_data_offset:ut||e===0?O=b.start:O=g,e===0&&s===0?K?S.offset=O+P.data_offset:S.offset=O:S.offset=g,g=S.offset+S.size,(w.sbgps.length>0||w.sgpds.length>0||U.mdia.minf.stbl.sbgps.length>0||U.mdia.minf.stbl.sgpds.length>0)&&y.setSampleGroupProperties(U,S,S.number_in_traf,w.sample_groups_info)}}if(w.subs){U.has_fragment_subsamples=!0;var X=w.first_sample_index;for(e=0;e<w.subs.entries.length;e++)X+=w.subs.entries[e].sample_delta,S=U.samples[X-1],S.subsamples=w.subs.entries[e].subsamples}}}},y.prototype.getSample=function(t,e){var s,a=t.samples[e];if(!this.moov)return null;if(!a.data)a.data=new Uint8Array(a.size),a.alreadyRead=0,this.samplesDataSize+=a.size,n.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+a.size+" (total: "+this.samplesDataSize+")");else if(a.alreadyRead==a.size)return a;for(;;){var h=this.stream.findPosition(!0,a.offset+a.alreadyRead,!1);if(h>-1){s=this.stream.buffers[h];var c=s.byteLength-(a.offset+a.alreadyRead-s.fileStart);if(a.size-a.alreadyRead<=c)return n.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-s.fileStart)+" read size: "+(a.size-a.alreadyRead)+" full size: "+a.size+")"),o.memcpy(a.data.buffer,a.alreadyRead,s,a.offset+a.alreadyRead-s.fileStart,a.size-a.alreadyRead),s.usedBytes+=a.size-a.alreadyRead,this.stream.logBufferLevel(),a.alreadyRead=a.size,a;if(c===0)return null;n.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-s.fileStart)+" read size: "+c+" full size: "+a.size+")"),o.memcpy(a.data.buffer,a.alreadyRead,s,a.offset+a.alreadyRead-s.fileStart,c),a.alreadyRead+=c,s.usedBytes+=c,this.stream.logBufferLevel()}else return null}},y.prototype.releaseSample=function(t,e){var s=t.samples[e];return s.data?(this.samplesDataSize-=s.size,s.data=null,s.alreadyRead=0,s.size):0},y.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},y.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var s=this.moov.traks[t];t>0&&(e+=","),e+=s.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},y.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var s=this.moov.mvex.trexs[e];if(s.track_id==t)return s}return null},y.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var s=this.moov.traks[e];if(s.tkhd.track_id==t)return s}return null},y.prototype.items=[],y.prototype.entity_groups=[],y.prototype.itemsDataSize=0,y.prototype.flattenItemInfo=function(){var t=this.items,e=this.entity_groups,s,a,h,c=this.meta;if(c!=null&&c.hdlr!==void 0&&c.iinf!==void 0){for(s=0;s<c.iinf.item_infos.length;s++)h={},h.id=c.iinf.item_infos[s].item_ID,t[h.id]=h,h.ref_to=[],h.name=c.iinf.item_infos[s].item_name,c.iinf.item_infos[s].protection_index>0&&(h.protection=c.ipro.protections[c.iinf.item_infos[s].protection_index-1]),c.iinf.item_infos[s].item_type?h.type=c.iinf.item_infos[s].item_type:h.type="mime",h.content_type=c.iinf.item_infos[s].content_type,h.content_encoding=c.iinf.item_infos[s].content_encoding;if(c.grpl)for(s=0;s<c.grpl.boxes.length;s++)entity_group={},entity_group.id=c.grpl.boxes[s].group_id,entity_group.entity_ids=c.grpl.boxes[s].entity_ids,entity_group.type=c.grpl.boxes[s].type,e[entity_group.id]=entity_group;if(c.iloc)for(s=0;s<c.iloc.items.length;s++){var p=c.iloc.items[s];switch(h=t[p.item_ID],p.data_reference_index!==0&&(n.warn("Item storage with reference to other files: not supported"),h.source=c.dinf.boxes[p.data_reference_index-1]),p.construction_method){case 0:break;case 1:n.warn("Item storage with construction_method : not supported");break;case 2:n.warn("Item storage with construction_method : not supported");break}for(h.extents=[],h.size=0,a=0;a<p.extents.length;a++)h.extents[a]={},h.extents[a].offset=p.extents[a].extent_offset+p.base_offset,h.extents[a].length=p.extents[a].extent_length,h.extents[a].alreadyRead=0,h.size+=h.extents[a].length}if(c.pitm&&(t[c.pitm.item_id].primary=!0),c.iref)for(s=0;s<c.iref.references.length;s++){var g=c.iref.references[s];for(a=0;a<g.references.length;a++)t[g.from_item_ID].ref_to.push({type:g.type,id:g.references[a]})}if(c.iprp)for(var m=0;m<c.iprp.ipmas.length;m++){var b=c.iprp.ipmas[m];for(s=0;s<b.associations.length;s++){var w=b.associations[s];if(h=t[w.id],h||(h=e[w.id]),h)for(h.properties===void 0&&(h.properties={},h.properties.boxes=[]),a=0;a<w.props.length;a++){var U=w.props[a];if(U.property_index>0&&U.property_index-1<c.iprp.ipco.boxes.length){var B=c.iprp.ipco.boxes[U.property_index-1];h.properties[B.type]=B,h.properties.boxes.push(B)}}}}}},y.prototype.getItem=function(t){var e,s;if(!this.meta)return null;if(s=this.items[t],!s.data&&s.size)s.data=new Uint8Array(s.size),s.alreadyRead=0,this.itemsDataSize+=s.size,n.debug("ISOFile","Allocating item #"+t+" of size "+s.size+" (total: "+this.itemsDataSize+")");else if(s.alreadyRead===s.size)return s;for(var a=0;a<s.extents.length;a++){var h=s.extents[a];if(h.alreadyRead!==h.length){var c=this.stream.findPosition(!0,h.offset+h.alreadyRead,!1);if(c>-1){e=this.stream.buffers[c];var p=e.byteLength-(h.offset+h.alreadyRead-e.fileStart);if(h.length-h.alreadyRead<=p)n.debug("ISOFile","Getting item #"+t+" extent #"+a+" data (alreadyRead: "+h.alreadyRead+" offset: "+(h.offset+h.alreadyRead-e.fileStart)+" read size: "+(h.length-h.alreadyRead)+" full extent size: "+h.length+" full item size: "+s.size+")"),o.memcpy(s.data.buffer,s.alreadyRead,e,h.offset+h.alreadyRead-e.fileStart,h.length-h.alreadyRead),e.usedBytes+=h.length-h.alreadyRead,this.stream.logBufferLevel(),s.alreadyRead+=h.length-h.alreadyRead,h.alreadyRead=h.length;else return n.debug("ISOFile","Getting item #"+t+" extent #"+a+" partial data (alreadyRead: "+h.alreadyRead+" offset: "+(h.offset+h.alreadyRead-e.fileStart)+" read size: "+p+" full extent size: "+h.length+" full item size: "+s.size+")"),o.memcpy(s.data.buffer,s.alreadyRead,e,h.offset+h.alreadyRead-e.fileStart,p),h.alreadyRead+=p,s.alreadyRead+=p,e.usedBytes+=p,this.stream.logBufferLevel(),null}else return null}}return s.alreadyRead===s.size?s:null},y.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var s=0;s<e.extents.length;s++){var a=e.extents[s];a.alreadyRead=0}return e.size}else return 0},y.prototype.processItems=function(t){for(var e in this.items){var s=this.items[e];this.getItem(s.id),t&&!s.sent&&(t(s),s.sent=!0,s.data=null)}},y.prototype.hasItem=function(t){for(var e in this.items){var s=this.items[e];if(s.name===t)return s.id}return-1},y.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},y.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)},y.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},s=null;if(e.itemId?s=this.getItem(e.itemId):s=this.getPrimaryItem(),s==null)return null;var a=new y;a.discardMdatData=!1;var h={type:s.type,description_boxes:s.properties.boxes};s.properties.ispe&&(h.width=s.properties.ispe.image_width,h.height=s.properties.ispe.image_height);var c=a.addTrack(h);return c?(a.addSample(c,s.data),a):null},y.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},y.prototype.createFragment=function(t,e,s){var a=this.getTrackById(t),h=this.getSample(a,e);if(h==null)return this.setNextSeekPositionFromSample(a.samples[e]),null;var c=s||new o;c.endianness=o.BIG_ENDIAN;var p=this.createSingleSampleMoof(h);p.write(c),p.trafs[0].truns[0].data_offset=p.size+8,n.debug("MP4Box","Adjusting data_offset with new value "+p.trafs[0].truns[0].data_offset),c.adjustUint32(p.trafs[0].truns[0].data_offset_position,p.trafs[0].truns[0].data_offset);var g=new r.mdatBox;return g.data=h.data,g.write(c),c},y.writeInitializationSegment=function(t,e,s,a){var h;n.debug("ISOFile","Generating initialization segment");var c=new o;c.endianness=o.BIG_ENDIAN,t.write(c);var p=e.add("mvex");for(s&&p.add("mehd").set("fragment_duration",s),h=0;h<e.traks.length;h++)p.add("trex").set("track_id",e.traks[h].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",a).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(c),c.buffer},y.prototype.save=function(t){var e=new o;e.endianness=o.BIG_ENDIAN,this.write(e),e.save(t)},y.prototype.getBuffer=function(){var t=new o;return t.endianness=o.BIG_ENDIAN,this.write(t),t.buffer},y.prototype.initializeSegmentation=function(){var t,e,s,a;for(this.onSegment===null&&n.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var h=new r.moovBox;h.mvhd=this.moov.mvhd,h.boxes.push(h.mvhd),s=this.getTrackById(this.fragmentedTracks[t].id),h.boxes.push(s),h.traks.push(s),a={},a.id=s.tkhd.track_id,a.user=this.fragmentedTracks[t].user,a.buffer=y.writeInitializationSegment(this.ftyp,h,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(a)}return e},r.Box.prototype.printHeader=function(t){this.size+=8,this.size>f&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},r.FullBox.prototype.printHeader=function(t){this.size+=4,r.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},r.Box.prototype.print=function(t){this.printHeader(t)},r.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var s=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=s}},y.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},r.mvhdBox.prototype.print=function(t){r.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},r.tkhdBox.prototype.print=function(t){r.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var D={};D.createFile=function(t,e){var s=t!==void 0?t:!0,a=new y(e);return a.discardMdatData=!s,a},d.createFile=D.createFile})(Tt)),Tt}var Se=be(),Pt=we(Se);const xe=()=>{let d,n=16.6;self.onmessage=l=>{l.data.event==="start"&&(self.clearInterval(d),d=self.setInterval(()=>{self.postMessage({})},n)),l.data.event==="stop"&&self.clearInterval(d)}},Ue=()=>{const d=new Blob([`(${xe.toString()})()`]),n=URL.createObjectURL(d);return new Worker(n)},Q=new Map;let Lt=1,_t=null;globalThis.Worker!=null&&(_t=Ue(),_t.onmessage=()=>{Lt+=1;for(const[d,n]of Q)if(Lt%d===0)for(const l of n)l()});const Ee=(d,n)=>{const l=Math.round(n/16.6),o=Q.get(l)??new Set;return o.add(d),Q.set(l,o),Q.size===1&&o.size===1&&_t?.postMessage({event:"start"}),()=>{o.delete(d),o.size===0&&Q.delete(l),Q.size===0&&(Lt=0,_t?.postMessage({event:"stop"}))}};function Ce(d){return d instanceof Error?String(d):typeof d=="object"?JSON.stringify(d,(n,l)=>l instanceof Error?String(l):l):String(d)}function Ae(){const d=new Date;return`${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}.${d.getMilliseconds()}`}let $t=1;const Kt=[],Jt=["debug","info","warn","error"].reduce((d,n,l)=>Object.assign(d,{[n]:(...o)=>{$t<=l&&(console[n](...o),Kt.push({lvName:n,timeStr:Ae(),args:o}))}}),{}),nt=new Map,I={setLogLevel:d=>{$t=nt.get(d)??1},...Jt,create:d=>Object.fromEntries(Object.entries(Jt).map(([n,l])=>[n,(...o)=>l(d,...o)])),async dump(){return Kt.reduce((d,{lvName:n,timeStr:l,args:o})=>d+`[${n}][${l}]  ${o.map(f=>Ce(f)).join(" ")}
`,"")}};nt.set(I.debug,0),nt.set(I.info,1),nt.set(I.warn,2),nt.set(I.error,3),(async function(){if(await Promise.resolve(),!(globalThis.navigator==null||globalThis.document==null)&&(I.info(`@webav version: 1.2.7, date: ${new Date().toLocaleDateString()}`),I.info(globalThis.navigator.userAgent),document.addEventListener("visibilitychange",()=>{I.info(`visibilitychange: ${document.visibilityState}`)}),"PressureObserver"in globalThis)){let d="";new PressureObserver(n=>{const l=JSON.stringify(n.map(o=>o.state));l!==d&&(I.info(`cpu state change: ${l}`),d=l)}).observe("cpu")}})();class Fe{constructor(n,l,o){this.length_=n,this.scaleFactor_=(n-1)/l,this.interpolate=this.cubic,o.method==="point"?this.interpolate=this.point:o.method==="linear"?this.interpolate=this.linear:o.method==="sinc"&&(this.interpolate=this.sinc),this.tangentFactor_=1-Math.max(0,Math.min(1,o.tension||0)),this.sincFilterSize_=o.sincFilterSize||1,this.kernel_=Ie(o.sincWindow||Be)}point(n,l){return this.getClippedInput_(Math.round(this.scaleFactor_*n),l)}linear(n,l){n=this.scaleFactor_*n;let o=Math.floor(n);return n-=o,(1-n)*this.getClippedInput_(o,l)+n*this.getClippedInput_(o+1,l)}cubic(n,l){n=this.scaleFactor_*n;let o=Math.floor(n),f=[this.getTangent_(o,l),this.getTangent_(o+1,l)],u=[this.getClippedInput_(o,l),this.getClippedInput_(o+1,l)];n-=o;let _=n*n,r=n*_;return(2*r-3*_+1)*u[0]+(r-2*_+n)*f[0]+(-2*r+3*_)*u[1]+(r-_)*f[1]}sinc(n,l){n=this.scaleFactor_*n;let o=Math.floor(n),f=o-this.sincFilterSize_+1,u=o+this.sincFilterSize_,_=0;for(let r=f;r<=u;r++)_+=this.kernel_(n-r)*this.getClippedInput_(r,l);return _}getTangent_(n,l){return this.tangentFactor_*(this.getClippedInput_(n+1,l)-this.getClippedInput_(n-1,l))/2}getClippedInput_(n,l){return 0<=n&&n<this.length_?l[n]:0}}function Be(d){return Math.exp(-d/2*d/2)}function Ie(d){return function(n){return ze(n)*d(n)}}function ze(d){return d===0?1:Math.sin(Math.PI*d)/(Math.PI*d)}class Te{constructor(n,l,o){let f=2*Math.PI*o/l,u=0;this.filters=[];for(let _=0;_<=n;_++)_-n/2===0?this.filters[_]=f:(this.filters[_]=Math.sin(f*(_-n/2))/(_-n/2),this.filters[_]*=.54-.46*Math.cos(2*Math.PI*_/n)),u=u+this.filters[_];for(let _=0;_<=n;_++)this.filters[_]/=u;this.z=this.initZ_()}filter(n){this.z.buf[this.z.pointer]=n;let l=0;for(let o=0,f=this.z.buf.length;o<f;o++)l+=this.filters[o]*this.z.buf[(this.z.pointer+o)%this.z.buf.length];return this.z.pointer=(this.z.pointer+1)%this.z.buf.length,l}reset(){this.z=this.initZ_()}initZ_(){let n=[];for(let l=0;l<this.filters.length-1;l++)n.push(0);return{buf:n,pointer:0}}}class Pe{constructor(n,l,o){let f=[];for(let u=0;u<n;u++)f.push(this.getCoeffs_({Fs:l,Fc:o,Q:.5/Math.sin(Math.PI/(n*2)*(u+.5))}));this.stages=[];for(let u=0;u<f.length;u++)this.stages[u]={b0:f[u].b[0],b1:f[u].b[1],b2:f[u].b[2],a1:f[u].a[0],a2:f[u].a[1],k:f[u].k,z:[0,0]}}filter(n){let l=n;for(let o=0,f=this.stages.length;o<f;o++)l=this.runStage_(o,l);return l}getCoeffs_(n){let l={};l.z=[0,0],l.a=[],l.b=[];let o=this.preCalc_(n,l);return l.k=1,l.b.push((1-o.cw)/(2*o.a0)),l.b.push(2*l.b[0]),l.b.push(l.b[0]),l}preCalc_(n,l){let o={},f=2*Math.PI*n.Fc/n.Fs;return o.alpha=Math.sin(f)/(2*n.Q),o.cw=Math.cos(f),o.a0=1+o.alpha,l.a0=o.a0,l.a.push(-2*o.cw/o.a0),l.k=1,l.a.push((1-o.alpha)/o.a0),o}runStage_(n,l){let o=l*this.stages[n].k-this.stages[n].a1*this.stages[n].z[0]-this.stages[n].a2*this.stages[n].z[1],f=this.stages[n].b0*o+this.stages[n].b1*this.stages[n].z[0]+this.stages[n].b2*this.stages[n].z[1];return this.stages[n].z[1]=this.stages[n].z[0],this.stages[n].z[0]=o,f}reset(){for(let n=0;n<this.stages.length;n++)this.stages[n].z=[0,0]}}const Le={point:!1,linear:!1,cubic:!0,sinc:!0},Qt={IIR:16,FIR:71},ke={IIR:Pe,FIR:Te};function Re(d,n,l,o={}){let f=(l-n)/n+1,u=new Float64Array(d.length*f);o.method=o.method||"cubic";let _=new Fe(d.length,u.length,{method:o.method,tension:o.tension||0,sincFilterSize:o.sincFilterSize||6,sincWindow:o.sincWindow||void 0});if(o.LPF===void 0&&(o.LPF=Le[o.method]),o.LPF){o.LPFType=o.LPFType||"IIR";const r=ke[o.LPFType];if(l>n){let v=new r(o.LPFOrder||Qt[o.LPFType],l,n/2);De(d,u,_,v)}else{let v=new r(o.LPFOrder||Qt[o.LPFType],n,l/2);Me(d,u,_,v)}}else qt(d,u,_);return u}function qt(d,n,l){for(let o=0,f=n.length;o<f;o++)n[o]=l.interpolate(o,d)}function De(d,n,l,o){for(let f=0,u=n.length;f<u;f++)n[f]=o.filter(l.interpolate(f,d));o.reset();for(let f=n.length-1;f>=0;f--)n[f]=o.filter(n[f])}function Me(d,n,l,o){for(let f=0,u=d.length;f<u;f++)d[f]=o.filter(d[f]);o.reset();for(let f=d.length-1;f>=0;f--)d[f]=o.filter(d[f]);qt(d,n,l)}var te=d=>{throw TypeError(d)},ee=(d,n,l)=>n.has(d)||te("Cannot "+l),A=(d,n,l)=>(ee(d,n,"read from private field"),l?l.call(d):n.get(d)),M=(d,n,l)=>n.has(d)?te("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(d):n.set(d,l),R=(d,n,l,o)=>(ee(d,n,"write to private field"),n.set(d,l),l);const ie="KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIHUobil7aWYobj09PSIvIilyZXR1cm57cGFyZW50Om51bGwsbmFtZToiIn07Y29uc3QgZT1uLnNwbGl0KCIvIikuZmlsdGVyKGk9PmkubGVuZ3RoPjApO2lmKGUubGVuZ3RoPT09MCl0aHJvdyBFcnJvcigiSW52YWxpZCBwYXRoIik7Y29uc3QgYT1lW2UubGVuZ3RoLTFdLHI9Ii8iK2Uuc2xpY2UoMCwtMSkuam9pbigiLyIpO3JldHVybntuYW1lOmEscGFyZW50OnJ9fWFzeW5jIGZ1bmN0aW9uIHcobixlKXtjb25zdHtwYXJlbnQ6YSxuYW1lOnJ9PXUobik7aWYoYT09bnVsbClyZXR1cm4gYXdhaXQgbmF2aWdhdG9yLnN0b3JhZ2UuZ2V0RGlyZWN0b3J5KCk7Y29uc3QgaT1hLnNwbGl0KCIvIikuZmlsdGVyKHQ9PnQubGVuZ3RoPjApO3RyeXtsZXQgdD1hd2FpdCBuYXZpZ2F0b3Iuc3RvcmFnZS5nZXREaXJlY3RvcnkoKTtmb3IoY29uc3QgcyBvZiBpKXQ9YXdhaXQgdC5nZXREaXJlY3RvcnlIYW5kbGUocyx7Y3JlYXRlOmUuY3JlYXRlfSk7aWYoZS5pc0ZpbGUpcmV0dXJuIGF3YWl0IHQuZ2V0RmlsZUhhbmRsZShyLHtjcmVhdGU6ZS5jcmVhdGV9KX1jYXRjaCh0KXtpZih0Lm5hbWU9PT0iTm90Rm91bmRFcnJvciIpcmV0dXJuIG51bGw7dGhyb3cgdH19Y29uc3QgZj17fTtzZWxmLm9ubWVzc2FnZT1hc3luYyBuPT57dmFyIGk7Y29uc3R7ZXZ0VHlwZTplLGFyZ3M6YX09bi5kYXRhO2xldCByPWZbYS5maWxlSWRdO3RyeXtsZXQgdDtjb25zdCBzPVtdO2lmKGU9PT0icmVnaXN0ZXIiKXtjb25zdCBsPWF3YWl0IHcoYS5maWxlUGF0aCx7Y3JlYXRlOiEwLGlzRmlsZTohMH0pO2lmKGw9PW51bGwpdGhyb3cgRXJyb3IoYG5vdCBmb3VuZCBmaWxlOiAke2EuZmlsZUlkfWApO3I9YXdhaXQgbC5jcmVhdGVTeW5jQWNjZXNzSGFuZGxlKHttb2RlOmEubW9kZX0pLGZbYS5maWxlSWRdPXJ9ZWxzZSBpZihlPT09ImNsb3NlIilhd2FpdCByLmNsb3NlKCksZGVsZXRlIGZbYS5maWxlSWRdO2Vsc2UgaWYoZT09PSJ0cnVuY2F0ZSIpYXdhaXQgci50cnVuY2F0ZShhLm5ld1NpemUpO2Vsc2UgaWYoZT09PSJ3cml0ZSIpe2NvbnN0e2RhdGE6bCxvcHRzOm99PW4uZGF0YS5hcmdzO3Q9YXdhaXQgci53cml0ZShsLG8pfWVsc2UgaWYoZT09PSJyZWFkIil7Y29uc3R7b2Zmc2V0Omwsc2l6ZTpvfT1uLmRhdGEuYXJncyxnPW5ldyBVaW50OEFycmF5KG8pLGQ9YXdhaXQgci5yZWFkKGcse2F0Omx9KSxjPWcuYnVmZmVyO3Q9ZD09PW8/YzooKGk9Yy50cmFuc2Zlcik9PW51bGw/dm9pZCAwOmkuY2FsbChjLGQpKT8/Yy5zbGljZSgwLGQpLHMucHVzaCh0KX1lbHNlIGU9PT0iZ2V0U2l6ZSI/dD1hd2FpdCByLmdldFNpemUoKTplPT09ImZsdXNoIiYmYXdhaXQgci5mbHVzaCgpO3NlbGYucG9zdE1lc3NhZ2Uoe2V2dFR5cGU6ImNhbGxiYWNrIixjYklkOm4uZGF0YS5jYklkLHJldHVyblZhbDp0fSxzKX1jYXRjaCh0KXtjb25zdCBzPXQ7c2VsZi5wb3N0TWVzc2FnZSh7ZXZ0VHlwZToidGhyb3dFcnJvciIsY2JJZDpuLmRhdGEuY2JJZCxlcnJNc2c6cy5uYW1lKyI6ICIrcy5tZXNzYWdlK2AKYCtKU09OLnN0cmluZ2lmeShuLmRhdGEpfSl9fX0pKCk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPW9wZnMtd29ya2VyLUY0UldscWNfLmpzLm1hcAo=",Ne=d=>Uint8Array.from(atob(d),n=>n.charCodeAt(0)),se=typeof self<"u"&&self.Blob&&new Blob([Ne(ie)],{type:"text/javascript;charset=utf-8"});function Oe(d){let n;try{if(n=se&&(self.URL||self.webkitURL).createObjectURL(se),!n)throw"";const l=new Worker(n,{name:d?.name});return l.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(n)}),l}catch{return new Worker("data:text/javascript;base64,"+ie,{name:d?.name})}finally{n&&(self.URL||self.webkitURL).revokeObjectURL(n)}}async function Ge(d,n,l){const o=Ye();return await o("register",{fileId:d,filePath:n,mode:l}),{read:async(f,u)=>await o("read",{fileId:d,offset:f,size:u}),write:async(f,u)=>await o("write",{fileId:d,data:f,opts:u},[ArrayBuffer.isView(f)?f.buffer:f]),close:async()=>await o("close",{fileId:d}),truncate:async f=>await o("truncate",{fileId:d,newSize:f}),getSize:async()=>await o("getSize",{fileId:d}),flush:async()=>await o("flush",{fileId:d})}}const gt=[];let kt=0;function Ye(){if(gt.length<3){const n=d();return gt.push(n),n}else{const n=gt[kt];return kt=(kt+1)%gt.length,n}function d(){const n=new Oe;let l=0,o={};return n.onmessage=({data:f})=>{var u,_;f.evtType==="callback"?(u=o[f.cbId])==null||u.resolve(f.returnVal):f.evtType==="throwError"&&((_=o[f.cbId])==null||_.reject(Error(f.errMsg))),delete o[f.cbId]},async function(f,u,_=[]){l+=1;const r=new Promise((v,E)=>{o[l]={resolve:v,reject:E}});return n.postMessage({cbId:l,evtType:f,args:u},_),r}}}function yt(d){if(d==="/")return{parent:null,name:""};const n=d.split("/").filter(f=>f.length>0);if(n.length===0)throw Error("Invalid path");const l=n[n.length-1],o="/"+n.slice(0,-1).join("/");return{name:l,parent:o}}async function V(d,n){const{parent:l,name:o}=yt(d);if(l==null)return await navigator.storage.getDirectory();const f=l.split("/").filter(u=>u.length>0);try{let u=await navigator.storage.getDirectory();for(const _ of f)u=await u.getDirectoryHandle(_,{create:n.create});return n.isFile?await u.getFileHandle(o,{create:n.create}):await u.getDirectoryHandle(o,{create:n.create})}catch(u){if(u.name==="NotFoundError")return null;throw u}}async function Rt(d){const{parent:n,name:l}=yt(d);if(n==null){const f=await navigator.storage.getDirectory();for await(const u of f.keys())await f.removeEntry(u,{recursive:!0});return}const o=await V(n,{create:!1,isFile:!1});if(o!=null)try{await o.removeEntry(l,{recursive:!0})}catch(f){if(f.name==="NotFoundError")return;throw f}}function Dt(d,n){return`${d}/${n}`.replace("//","/")}function q(d){return new re(d)}var G,mt,at;const He=class me{constructor(n){M(this,G),M(this,mt),M(this,at),R(this,G,n);const{parent:l,name:o}=yt(n);R(this,mt,o),R(this,at,l)}get kind(){return"dir"}get name(){return A(this,mt)}get path(){return A(this,G)}get parent(){return A(this,at)==null?null:q(A(this,at))}async create(){return await V(A(this,G),{create:!0,isFile:!1}),q(A(this,G))}async exists(){return await V(A(this,G),{create:!1,isFile:!1})instanceof FileSystemDirectoryHandle}async remove(n={}){for(const l of await this.children())try{await l.remove(n)}catch(o){console.warn(o)}try{await Rt(A(this,G))}catch(l){console.warn(l)}}async children(){const n=await V(A(this,G),{create:!1,isFile:!1});if(n==null)return[];const l=[];for await(const o of n.values())l.push((o.kind==="file"?ot:q)(Dt(A(this,G),o.name)));return l}async copyTo(n){if(!await this.exists())throw Error(`dir ${this.path} not exists`);if(n instanceof me){const l=await n.exists()?q(Dt(n.path,this.name)):n;return await l.create(),await Promise.all((await this.children()).map(o=>o.copyTo(l))),l}else if(n instanceof FileSystemDirectoryHandle)return await Promise.all((await this.children()).map(async l=>{l.kind==="file"?await l.copyTo(await n.getFileHandle(l.name,{create:!0})):await l.copyTo(await n.getDirectoryHandle(l.name,{create:!0}))})),null;throw Error("Illegal target type")}async moveTo(n){const l=await this.copyTo(n);return await this.remove(),l}};G=new WeakMap,mt=new WeakMap,at=new WeakMap;let re=He;const Mt=new Map;function ot(d,n="rw"){if(n==="rw"){const l=Mt.get(d)??new xt(d,n);return Mt.set(d,l),l}return new xt(d,n)}async function Nt(d,n,l={overwrite:!0}){if(n instanceof xt){await Nt(d,await n.stream(),l);return}const o=await(d instanceof xt?d:ot(d,"rw")).createWriter();try{if(l.overwrite&&await o.truncate(0),n instanceof ReadableStream){const f=n.getReader();for(;;){const{done:u,value:_}=await f.read();if(u)break;await o.write(_)}}else await o.write(n)}catch(f){throw f}finally{await o.close()}}let Ve=0;const We=()=>++Ve;var N,ht,vt,lt,wt,Y,bt,St,tt;const Ze=class ve{constructor(n,l){M(this,N),M(this,ht),M(this,vt),M(this,lt),M(this,wt),M(this,Y,0),M(this,bt,async()=>{}),M(this,St,(()=>{let u=null;return()=>(R(this,Y,A(this,Y)+1),u!=null||(u=new Promise(async(_,r)=>{try{const v=await Ge(A(this,wt),A(this,N),A(this,lt));R(this,bt,async()=>{u!=null&&(u=null,R(this,Y,0),await v.close().catch(console.error))}),_([v,async()=>{R(this,Y,A(this,Y)-1),!(A(this,Y)>0)&&(u=null,await v.close())}])}catch(v){r(v)}})),u)})()),M(this,tt,!1),R(this,wt,We()),R(this,N,n),R(this,lt,{r:"read-only",rw:"readwrite","rw-unsafe":"readwrite-unsafe"}[l]);const{parent:o,name:f}=yt(n);if(o==null)throw Error("Invalid path");R(this,vt,f),R(this,ht,o)}get kind(){return"file"}get path(){return A(this,N)}get name(){return A(this,vt)}get parent(){return A(this,ht)==null?null:q(A(this,ht))}async createWriter(){if(A(this,lt)==="read-only")throw Error("file is read-only");if(A(this,tt))throw Error("Other writer have not been closed");R(this,tt,!0);try{const n=new TextEncoder,[l,o]=await A(this,St).call(this);let f=await l.getSize(),u=!1;return{write:async(_,r={})=>{if(u)throw Error("Writer is closed");const v=typeof _=="string"?n.encode(_):_,E=r.at??f,x=v.byteLength;return f=E+x,await l.write(v,{at:E})},truncate:async _=>{if(u)throw Error("Writer is closed");await l.truncate(_),f>_&&(f=_)},flush:async()=>{if(u)throw Error("Writer is closed");await l.flush()},close:async()=>{if(u)throw Error("Writer is closed");u=!0,R(this,tt,!1),await o()}}}catch(n){throw R(this,tt,!1),n}}async createReader(){const[n,l]=await A(this,St).call(this);let o=!1,f=0;return{read:async(u,_={})=>{if(o)throw Error("Reader is closed");const r=_.at??f,v=await n.read(r,u);return f=r+v.byteLength,v},getSize:async()=>{if(o)throw Error("Reader is closed");return await n.getSize()},close:async()=>{o||(o=!0,await l())}}}async text(){return new TextDecoder().decode(await this.arrayBuffer())}async arrayBuffer(){const n=await V(A(this,N),{create:!1,isFile:!0});return n==null?new ArrayBuffer(0):(await n.getFile()).arrayBuffer()}async stream(){const n=await this.getOriginFile();return n==null?new ReadableStream({pull:l=>{l.close()}}):n.stream()}async getOriginFile(){var n;return(n=await V(A(this,N),{create:!1,isFile:!0}))==null?void 0:n.getFile()}async getSize(){const n=await V(A(this,N),{create:!1,isFile:!0});return n==null?0:(await n.getFile()).size}async exists(){return await V(A(this,N),{create:!1,isFile:!0})instanceof FileSystemFileHandle}async remove(n={}){if(n.force===!0){await A(this,bt).call(this),await Rt(A(this,N)),Mt.delete(A(this,N));return}if(A(this,Y)>0)throw Error("exists unclosed reader/writer");await Rt(A(this,N))}async copyTo(n){if(n instanceof ve)return n.path===this.path?this:(await Nt(n,this),n);if(n instanceof re){if(!await this.exists())throw Error(`file ${this.path} not exists`);return await this.copyTo(ot(Dt(n.path,this.name)))}else if(n instanceof FileSystemFileHandle)return await(await this.stream()).pipeTo(await n.createWritable()),null;throw Error("Illegal target type")}async moveTo(n){const l=await this.copyTo(n);return await this.remove(),l}};N=new WeakMap,ht=new WeakMap,vt=new WeakMap,lt=new WeakMap,wt=new WeakMap,Y=new WeakMap,bt=new WeakMap,St=new WeakMap,tt=new WeakMap;let xt=Ze;const Ot="/.opfs-tools-temp-dir";async function ne(d){try{if(d.kind==="file"){if(!await d.exists())return!0;const n=await d.createWriter();await n.truncate(0),await n.close(),await d.remove()}else await d.remove();return!0}catch(n){return console.warn(n),!1}}function Xe(){setInterval(async()=>{for(const d of await q(Ot).children()){const n=/^\d+-(\d+)$/.exec(d.name);(n==null||Date.now()-Number(n[1])>2592e5)&&await ne(d)}},60*1e3)}const Gt=[];let ae=!1;async function je(){if(globalThis.localStorage==null)return;const d="OPFS_TOOLS_EXPIRES_TMP_FILES";ae||(ae=!0,globalThis.addEventListener("unload",()=>{Gt.length!==0&&localStorage.setItem(d,`${localStorage.getItem(d)??""},${Gt.join(",")}`)}));let n=localStorage.getItem(d)??"";for(const l of n.split(","))l.length!==0&&await ne(ot(`${Ot}/${l}`))&&(n=n.replace(l,""));localStorage.setItem(d,n.replace(/,{2,}/g,","))}(async function(){var d;globalThis.__opfs_tools_tmpfile_init__!==!0&&(globalThis.__opfs_tools_tmpfile_init__=!0,!(globalThis.FileSystemDirectoryHandle==null||globalThis.FileSystemFileHandle==null||((d=globalThis.navigator)==null?void 0:d.storage.getDirectory)==null)&&(Xe(),await je()))})();function $e(){const d=`${Math.random().toString().slice(2)}-${Date.now()}`;return Gt.push(d),ot(`${Ot}/${d}`)}function Ke(d){if(d.format==="f32-planar"){const n=[];for(let l=0;l<d.numberOfChannels;l+=1){const o=d.allocationSize({planeIndex:l}),f=new ArrayBuffer(o);d.copyTo(f,{planeIndex:l}),n.push(new Float32Array(f))}return n}else if(d.format==="f32"){const n=new ArrayBuffer(d.allocationSize({planeIndex:0}));return d.copyTo(n,{planeIndex:0}),Qe(new Float32Array(n),d.numberOfChannels)}else if(d.format==="s16"){const n=new ArrayBuffer(d.allocationSize({planeIndex:0}));return d.copyTo(n,{planeIndex:0}),Je(new Int16Array(n),d.numberOfChannels)}throw Error("Unsupported audio data format")}function Je(d,n){const l=d.length/n,o=Array.from({length:n},()=>new Float32Array(l));for(let f=0;f<l;f++)for(let u=0;u<n;u++){const _=d[f*n+u];o[u][f]=_/32768}return o}function Qe(d,n){const l=d.length/n,o=Array.from({length:n},()=>new Float32Array(l));for(let f=0;f<l;f++)for(let u=0;u<n;u++)o[u][f]=d[f*n+u];return o}function qe(d){return Array(d.numberOfChannels).fill(0).map((n,l)=>d.getChannelData(l))}async function ti(d,n){const l={type:n,data:d},o=new ImageDecoder(l);await Promise.all([o.completed,o.tracks.ready]);let f=o.tracks.selectedTrack?.frameCount??1;const u=[];for(let _=0;_<f;_+=1)u.push((await o.decode({frameIndex:_})).image);return u}async function ei(d,n,l){const o=d.length,f=Array(l.chanCount).fill(0).map(()=>new Float32Array(0));if(o===0)return f;const u=Math.max(...d.map(E=>E.length));if(u===0)return f;if(globalThis.OfflineAudioContext==null)return d.map(E=>new Float32Array(Re(E,n,l.rate,{method:"sinc",LPF:!1})));const _=new globalThis.OfflineAudioContext(l.chanCount,u*l.rate/n,l.rate),r=_.createBufferSource(),v=_.createBuffer(o,u,n);return d.forEach((E,x)=>v.copyToChannel(E,x)),r.buffer=v,r.connect(_.destination),r.start(),qe(await _.startRendering())}function oe(d){return new Promise(n=>{const l=Ee(()=>{l(),n()},d)})}const et={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2"};function ii(d,n){const l=n.videoTracks[0],o={};if(l!=null){const u=si(d.getTrackById(l.id))?.buffer,{descKey:_,type:r}=l.codec.startsWith("avc1")?{descKey:"avcDecoderConfigRecord",type:"avc1"}:l.codec.startsWith("hvc1")?{descKey:"hevcDecoderConfigRecord",type:"hvc1"}:{descKey:"",type:""};_!==""&&(o.videoTrackConf={timescale:l.timescale,duration:l.duration,width:l.video.width,height:l.video.height,brands:n.brands,type:r,[_]:u}),o.videoDecoderConf={codec:l.codec,codedHeight:l.video.height,codedWidth:l.video.width,description:u}}const f=n.audioTracks[0];if(f!=null){const u=ri(d),_=u==null?{}:ni(u);o.audioTrackConf={timescale:f.timescale,samplerate:_.sampleRate??f.audio.sample_rate,channel_count:_.numberOfChannels??f.audio.channel_count,hdlr:"soun",type:f.codec.startsWith("mp4a")?"mp4a":f.codec,description:u},o.audioDecoderConf={codec:_.codec??et.codec,numberOfChannels:_.numberOfChannels??f.audio.channel_count,sampleRate:_.sampleRate??f.audio.sample_rate}}return o}function si(d){for(const n of d.mdia.minf.stbl.stsd.entries){const l=n.avcC??n.hvcC??n.av1C??n.vpcC;if(l!=null){const o=new Pt.DataStream(void 0,0,Pt.DataStream.BIG_ENDIAN);return l.write(o),new Uint8Array(o.buffer.slice(8))}}}function ri(d,n="mp4a"){return d.moov?.traks.map(l=>l.mdia.minf.stbl.stsd.entries).flat().find(({type:l})=>l===n)?.esds}function ni(d){let n="mp4a";const l=d.esd.descs[0];if(l==null)return{};n+="."+l.oti.toString(16);const o=l.descs[0];if(o==null)return n.endsWith("40")&&(n+=".2"),{codec:n};const f=(o.data[0]&248)>>3;n+="."+f;const[u,_]=o.data,r=((u&7)<<1)+(_>>7),v=(_&127)>>3;return{codec:n,sampleRate:[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][r],numberOfChannels:v}}async function ai(d,n,l){const o=Pt.createFile(!1);o.onReady=u=>{n({mp4boxFile:o,info:u});const _=u.videoTracks[0]?.id;_!=null&&o.setExtractionOptions(_,"video",{nbSamples:100});const r=u.audioTracks[0]?.id;r!=null&&o.setExtractionOptions(r,"audio",{nbSamples:100}),o.start()},o.onSamples=l,await f();async function f(){let u=0;const _=30*1024*1024;for(;;){const r=await d.read(_,{at:u});if(r.byteLength===0)break;r.fileStart=u;const v=o.appendBuffer(r);if(v==null)break;u=v}o.stop()}}function oi(d){if(d?.length!==9)return{};const n=new Int32Array(d.buffer),l=n[0]/65536,o=n[1]/65536,f=n[3]/65536,u=n[4]/65536,_=n[6]/65536,r=n[7]/65536,v=n[8]/(1<<30),E=Math.sqrt(l*l+f*f),x=Math.sqrt(o*o+u*u),F=Math.atan2(f,l),y=F*180/Math.PI;return{scaleX:E,scaleY:x,rotationRad:F,rotationDeg:y,translateX:_,translateY:r,perspective:v}}function hi(d,n,l){const o=(Math.round(l/90)*90+360)%360;if(o===0)return v=>v;const f=o===90||o===270?n:d,u=o===90||o===270?d:n,_=new OffscreenCanvas(f,u),r=_.getContext("2d");return r.translate(f/2,u/2),r.rotate(-o*Math.PI/180),r.translate(-d/2,-n/2),v=>{if(v==null)return null;r.drawImage(v,0,0);const E=new VideoFrame(_,{timestamp:v.timestamp,duration:v.duration??void 0});return v.close(),E}}let Yt=0;function Ht(d){return d.kind==="file"&&d.createReader instanceof Function}class ${#t=Yt++;#n=I.create(`MP4Clip id:${this.#t},`);ready;#e=!1;#a={duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0};get meta(){return{...this.#a}}#s;#r=[];async getFileHeaderBinData(){await this.ready;const n=await this.#s.getOriginFile();if(n==null)throw Error("MP4Clip localFile is not origin file");return await new Blob(this.#r.map(({start:l,size:o})=>n.slice(l,l+o))).arrayBuffer()}#i={perspective:1,rotationRad:0,rotationDeg:0,scaleX:1,scaleY:1,translateX:0,translateY:0};#l=n=>n;#d=1;#h=[];#f=[];#p=null;#c=null;#u={video:null,audio:null};#o={audio:!0};constructor(n,l={}){if(!(n instanceof ReadableStream)&&!Ht(n)&&!Array.isArray(n.videoSamples))throw Error("Illegal argument");this.#o={audio:!0,...l},this.#d=typeof l.audio=="object"&&"volume"in l.audio?l.audio.volume:1;const o=async f=>(await Nt(this.#s,f),this.#s);this.#s=Ht(n)?n:"localFile"in n?n.localFile:$e(),this.ready=(n instanceof ReadableStream?o(n).then(f=>he(f,this.#o)):Ht(n)?he(n,this.#o):Promise.resolve(n)).then(async({videoSamples:f,audioSamples:u,decoderConf:_,headerBoxPos:r,parsedMatrix:v})=>{this.#h=f,this.#f=u,this.#u=_,this.#r=r,this.#i=v;const{videoFrameFinder:E,audioFrameFinder:x}=di({video:_.video==null?null:{..._.video,hardwareAcceleration:this.#o.__unsafe_hardwareAcceleration__},audio:_.audio},await this.#s.createReader(),f,u,this.#o.audio!==!1?this.#d:0);this.#p=E,this.#c=x;const{codedWidth:F,codedHeight:y}=_.video??{};return F&&y&&(this.#l=hi(F,y,v.rotationDeg)),this.#a=li(_,f,u,v.rotationDeg),this.#n.info("MP4Clip meta:",this.#a),{...this.#a}})}tickInterceptor=async(n,l)=>l;async tick(n){if(n>=this.#a.duration)return await this.tickInterceptor(n,{audio:await this.#c?.find(n)??[],state:"done"});const[l,o]=await Promise.all([this.#c?.find(n)??[],this.#p?.find(n).then(this.#l)]);return o==null?await this.tickInterceptor(n,{audio:l,state:"success"}):await this.tickInterceptor(n,{video:o,audio:l,state:"success"})}#_=new AbortController;async thumbnails(n=100,l){this.#_.abort(),this.#_=new AbortController;const o=this.#_.signal;await this.ready;const f="generate thumbnails aborted";if(o.aborted)throw Error(f);const{width:u,height:_}=this.#a,r=_i(n,Math.round(_*(n/u)),{quality:.1,type:"image/png"});return new Promise(async(v,E)=>{let x=[];const F=this.#u.video;if(F==null||this.#h.length===0){y();return}o.addEventListener("abort",()=>{E(Error(f))});async function y(){o.aborted||v(await Promise.all(x.map(async a=>({ts:a.ts,img:await a.img}))))}function D(a){x.push({ts:a.timestamp,img:r(a)})}const{start:t=0,end:e=this.#a.duration,step:s}=l??{};if(s){let a=t;const h=new de(await this.#s.createReader(),this.#h,{...F,hardwareAcceleration:this.#o.__unsafe_hardwareAcceleration__});for(;a<=e&&!o.aborted;){const c=await h.find(a);c&&D(c),a+=s}h.destroy(),y()}else await vi(this.#h,this.#s,F,o,{start:t,end:e},(a,h)=>{a!=null&&D(a),h&&y()})})}async split(n){if(await this.ready,n<=0||n>=this.#a.duration)throw Error('"time" out of bounds');const[l,o]=gi(this.#h,n),[f,u]=yi(this.#f,n),_=new $({localFile:this.#s,videoSamples:l??[],audioSamples:f??[],decoderConf:this.#u,headerBoxPos:this.#r,parsedMatrix:this.#i},this.#o),r=new $({localFile:this.#s,videoSamples:o??[],audioSamples:u??[],decoderConf:this.#u,headerBoxPos:this.#r,parsedMatrix:this.#i},this.#o);return await Promise.all([_.ready,r.ready]),[_,r]}async clone(){await this.ready;const n=new $({localFile:this.#s,videoSamples:[...this.#h],audioSamples:[...this.#f],decoderConf:this.#u,headerBoxPos:this.#r,parsedMatrix:this.#i},this.#o);return await n.ready,n.tickInterceptor=this.tickInterceptor,n}async splitTrack(){await this.ready;const n=[];if(this.#h.length>0){const l=new $({localFile:this.#s,videoSamples:[...this.#h],audioSamples:[],decoderConf:{video:this.#u.video,audio:null},headerBoxPos:this.#r,parsedMatrix:this.#i},this.#o);await l.ready,l.tickInterceptor=this.tickInterceptor,n.push(l)}if(this.#f.length>0){const l=new $({localFile:this.#s,videoSamples:[],audioSamples:[...this.#f],decoderConf:{audio:this.#u.audio,video:null},headerBoxPos:this.#r,parsedMatrix:this.#i},this.#o);await l.ready,l.tickInterceptor=this.tickInterceptor,n.push(l)}return n}destroy(){this.#e||(this.#n.info("MP4Clip destroy"),this.#e=!0,this.#p?.destroy(),this.#c?.destroy())}}function li(d,n,l,o){const f={duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0};if(d.video!=null&&n.length>0){f.width=d.video.codedWidth??0,f.height=d.video.codedHeight??0;const r=(Math.round(o/90)*90+360)%360;(r===90||r===270)&&([f.width,f.height]=[f.height,f.width])}d.audio!=null&&l.length>0&&(f.audioSampleRate=et.sampleRate,f.audioChanCount=et.channelCount);let u=0,_=0;if(n.length>0)for(let r=n.length-1;r>=0;r--){const v=n[r];if(!v.deleted){u=v.cts+v.duration;break}}if(l.length>0){const r=l.at(-1);_=r.cts+r.duration}return f.duration=Math.max(u,_),f}function di(d,n,l,o,f){return{audioFrameFinder:f===0||d.audio==null||o.length===0?null:new ci(n,o,d.audio,{volume:f,targetSampleRate:et.sampleRate}),videoFrameFinder:d.video==null||l.length===0?null:new de(n,l,d.video)}}async function he(d,n={}){let l=null;const o={video:null,audio:null};let f=[],u=[],_=[];const r={perspective:1,rotationRad:0,rotationDeg:0,scaleX:1,scaleY:1,translateX:0,translateY:0};let v=-1,E=-1;const x=await d.createReader();await ai(x,async y=>{l=y.info;const D=y.mp4boxFile.ftyp;_.push({start:D.start,size:D.size});const t=y.mp4boxFile.moov;_.push({start:t.start,size:t.size}),Object.assign(r,oi(l.videoTracks[0]?.matrix));let{videoDecoderConf:e,audioDecoderConf:s}=ii(y.mp4boxFile,y.info);if(o.video=e??null,o.audio=s??null,e==null&&s==null&&I.error("MP4Clip no video and audio track"),s!=null){const{supported:a}=await AudioDecoder.isConfigSupported(s);a||I.error(`MP4Clip audio codec is not supported: ${s.codec}`)}if(e!=null){const{supported:a}=await VideoDecoder.isConfigSupported(e);a||I.error(`MP4Clip video codec is not supported: ${e.codec}`)}I.info("mp4BoxFile moov ready",{...y.info,tracks:null,videoTracks:null,audioTracks:null},o)},(y,D,t)=>{if(D==="video"){v===-1&&(v=t[0].dts);for(const e of t)f.push(le(e,v,"video"))}else if(D==="audio"&&n.audio){E===-1&&(E=t[0].dts);for(const e of t)u.push(le(e,E,"audio"))}}),await x.close();const F=f.at(-1)??u.at(-1);if(l==null)throw Error("MP4Clip stream is done, but not emit ready");if(F==null)throw Error("MP4Clip stream not contain any sample");return Wt(f),I.info("mp4 stream parsed"),{videoSamples:f,audioSamples:u,decoderConf:o,headerBoxPos:_,parsedMatrix:r}}function le(d,n=0,l){let o=d.offset;const f=l==="video"&&d.is_sync?mi(d.data,d.description.type):-1;let u=d.size;return f>0&&(o+=f,u-=f),{...d,is_idr:f>=0,offset:o,size:u,cts:(d.cts-n)/d.timescale*1e6,dts:(d.dts-n)/d.timescale*1e6,duration:d.duration/d.timescale*1e6,timescale:1e6,data:l==="video"?null:d.data}}class de{constructor(n,l,o){this.localFileReader=n,this.samples=l,this.conf=o}#t=null;#n=0;#e={abort:!1,st:performance.now()};find=async n=>{(this.#t==null||this.#t.state==="closed"||n<=this.#n||n-this.#n>3e6)&&this.#o(n),this.#e.abort=!0,this.#n=n,this.#e={abort:!1,st:performance.now()};const l=await this.#p(n,this.#t,this.#e);return this.#h=0,l};#a=0;#s=!1;#r=0;#i=[];#l=0;#d=0;#h=0;#f=!1;#p=async(n,l,o)=>{if(l==null||l.state==="closed"||o.abort)return null;if(this.#i.length>0){const f=this.#i[0];return n<f.timestamp?null:(this.#i.shift(),n>f.timestamp+(f.duration??0)?(f.close(),await this.#p(n,l,o)):(!this.#f&&this.#i.length<10&&this.#u(l).catch(u=>{throw this.#f=!0,this.#o(n),u}),f))}if(this.#c||this.#l<this.#d&&l.decodeQueueSize>0){if(performance.now()-o.st>6e3)throw Error(`MP4Clip.tick video timeout, ${JSON.stringify(this.#_())}`);this.#h+=1,await oe(15)}else{if(this.#r>=this.samples.length)return null;try{await this.#u(l)}catch(f){throw this.#o(n),f}}return await this.#p(n,l,o)};#c=!1;#u=async n=>{if(this.#c||n.decodeQueueSize>600)return;let l=this.#r+1;if(l>this.samples.length)return;this.#c=!0;let o=!1;for(;l<this.samples.length;l++){const f=this.samples[l];if(!o&&!f.deleted&&(o=!0),f.is_idr)break}if(o){const f=this.samples.slice(this.#r,l);if(f[0]?.is_idr!==!0)I.warn("First sample not idr frame");else{const u=performance.now(),_=await ce(f,this.localFileReader),r=performance.now()-u;if(r>1e3){const v=f[0],E=f.at(-1),x=E.offset+E.size-v.offset;I.warn(`Read video samples time cost: ${Math.round(r)}ms, file chunk size: ${x}`)}if(n.state==="closed")return;this.#a=_[0]?.duration??0,Vt(n,_,{onDecodingError:v=>{if(this.#s)throw v;this.#l===0&&(this.#s=!0,I.warn("Downgrade to software decode"),this.#o())}}),this.#d+=_.length}}this.#r=l,this.#c=!1};#o=n=>{if(this.#c=!1,this.#i.forEach(o=>o.close()),this.#i=[],n==null||n===0)this.#r=0;else{let o=0;for(let f=0;f<this.samples.length;f++){const u=this.samples[f];if(u.is_idr&&(o=f),!(u.cts<n)){this.#r=o;break}}}this.#d=0,this.#l=0,this.#t?.state!=="closed"&&this.#t?.close();const l={...this.conf,...this.#s?{hardwareAcceleration:"prefer-software"}:{}};this.#t=new VideoDecoder({output:o=>{if(this.#l+=1,o.timestamp===-1){o.close();return}let f=o;o.duration==null&&(f=new VideoFrame(o,{duration:this.#a}),o.close()),this.#i.push(f)},error:o=>{if(o.message.includes("Codec reclaimed due to inactivity")){this.#t=null,I.warn(o.message);return}const f=`VideoFinder VideoDecoder err: ${o.message}, config: ${JSON.stringify(l)}, state: ${JSON.stringify(this.#_())}`;throw I.error(f),Error(f)}}),this.#t.configure(l)};#_=()=>({time:this.#n,decState:this.#t?.state,decQSize:this.#t?.decodeQueueSize,decCusorIdx:this.#r,sampleLen:this.samples.length,inputCnt:this.#d,outputCnt:this.#l,cacheFrameLen:this.#i.length,softDeocde:this.#s,clipIdCnt:Yt,sleepCnt:this.#h,memInfo:ue()});destroy=()=>{this.#t?.state!=="closed"&&this.#t?.close(),this.#t=null,this.#e.abort=!0,this.#i.forEach(n=>n.close()),this.#i=[],this.localFileReader.close()}}function fi(d,n){for(let l=0;l<n.length;l++){const o=n[l];if(d>=o.cts&&d<o.cts+o.duration)return l;if(o.cts>d)break}return 0}class ci{constructor(n,l,o,f){this.localFileReader=n,this.samples=l,this.conf=o,this.#t=f.volume,this.#n=f.targetSampleRate}#t=1;#n;#e=null;#a={abort:!1,st:performance.now()};find=async n=>{const l=n<=this.#s||n-this.#s>1e5;(this.#e==null||this.#e.state==="closed"||l)&&this.#f(),l&&(this.#s=n,this.#r=fi(n,this.samples)),this.#a.abort=!0;const o=n-this.#s;this.#s=n,this.#a={abort:!1,st:performance.now()};const f=await this.#d(Math.ceil(o*(this.#n/1e6)),this.#e,this.#a);return this.#l=0,f};#s=0;#r=0;#i={frameCnt:0,data:[]};#l=0;#d=async(n,l=null,o)=>{if(l==null||o.abort||l.state==="closed"||n===0)return[];const f=this.#i.frameCnt-n;if(f>0)return f<et.sampleRate/10&&this.#h(l),fe(this.#i,n);if(l.decoding){if(performance.now()-o.st>3e3)throw o.abort=!0,Error(`MP4Clip.tick audio timeout, ${JSON.stringify(this.#p())}`);this.#l+=1,await oe(15)}else{if(this.#r>=this.samples.length-1)return fe(this.#i,this.#i.frameCnt);this.#h(l)}return this.#d(n,l,o)};#h=n=>{if(n.decodeQueueSize>10)return;const l=[];let o=this.#r;for(;o<this.samples.length;){const f=this.samples[o];if(o+=1,!f.deleted&&(l.push(f),l.length>=10))break}this.#r=o,n.decode(l.map(f=>new EncodedAudioChunk({type:"key",timestamp:f.cts,duration:f.duration,data:f.data})))};#f=()=>{this.#s=0,this.#r=0,this.#i={frameCnt:0,data:[]},this.#e?.close(),this.#e=ui(this.conf,{resampleRate:et.sampleRate,volume:this.#t},n=>{this.#i.data.push(n),this.#i.frameCnt+=n[0].length})};#p=()=>({time:this.#s,decState:this.#e?.state,decQSize:this.#e?.decodeQueueSize,decCusorIdx:this.#r,sampleLen:this.samples.length,pcmLen:this.#i.frameCnt,clipIdCnt:Yt,sleepCnt:this.#l,memInfo:ue()});destroy=()=>{this.#e=null,this.#a.abort=!0,this.#i={frameCnt:0,data:[]},this.localFileReader.close()}}function ui(d,n,l){let o=0,f=0;const u=x=>{if(f+=1,x.length!==0){if(n.volume!==1)for(const F of x)for(let y=0;y<F.length;y++)F[y]*=n.volume;x.length===1&&(x=[x[0],x[0]]),l(x)}},_=pi(u),r=n.resampleRate!==d.sampleRate;let v=new AudioDecoder({output:x=>{const F=Ke(x);r?_(()=>ei(F,x.sampleRate,{rate:n.resampleRate,chanCount:x.numberOfChannels})):u(F),x.close()},error:x=>{x.message.includes("Codec reclaimed due to inactivity")||E("MP4Clip AudioDecoder err",x)}});v.configure(d);function E(x,F){const y=`${x}: ${F.message}, state: ${JSON.stringify({qSize:v.decodeQueueSize,state:v.state,inputCnt:o,outputCnt:f})}`;throw I.error(y),Error(y)}return{decode(x){o+=x.length;try{for(const F of x)v.decode(F)}catch(F){E("decode audio chunk error",F)}},close(){v.state!=="closed"&&v.close()},get decoding(){return o>f&&v.decodeQueueSize>0},get state(){return v.state},get decodeQueueSize(){return v.decodeQueueSize}}}function pi(d){const n=[];let l=0;function o(_,r){n[r]=_,f()}function f(){const _=n[l];_!=null&&(d(_),l+=1,f())}let u=0;return _=>{const r=u;u+=1,_().then(v=>o(v,r)).catch(v=>o(v,r))}}function fe(d,n){const l=[new Float32Array(n),new Float32Array(n)];let o=0,f=0;for(;f<d.data.length;){const[u,_]=d.data[f];if(o+u.length>n){const r=n-o;l[0].set(u.subarray(0,r),o),l[1].set(_.subarray(0,r),o),d.data[f][0]=u.subarray(r,u.length),d.data[f][1]=_.subarray(r,_.length);break}else l[0].set(u,o),l[1].set(_,o),o+=u.length,f++}return d.data=d.data.slice(f),d.frameCnt-=n,l}async function ce(d,n){const l=d[0],o=d.at(-1);if(o==null)return[];const f=o.offset+o.size-l.offset;if(f<3e7){const u=new Uint8Array(await n.read(f,{at:l.offset}));return d.map(_=>{const r=_.offset-l.offset;return new EncodedVideoChunk({type:_.is_sync?"key":"delta",timestamp:_.cts,duration:_.duration,data:u.subarray(r,r+_.size)})})}return await Promise.all(d.map(async u=>new EncodedVideoChunk({type:u.is_sync?"key":"delta",timestamp:u.cts,duration:u.duration,data:await n.read(u.size,{at:u.offset})})))}function _i(d,n,l){const o=new OffscreenCanvas(d,n),f=o.getContext("2d");return async u=>(f.drawImage(u,0,0,d,n),u.close(),await o.convertToBlob(l))}function gi(d,n){if(d.length===0)return[];let l=0,o=0,f=-1;for(let v=0;v<d.length;v++){const E=d[v];if(f===-1&&n<E.cts&&(f=v-1),E.is_idr)if(f===-1)l=v;else{o=v;break}}const u=d[f];if(u==null)throw Error("Not found video sample by time");const _=d.slice(0,o===0?d.length:o).map(v=>({...v}));for(let v=l;v<_.length;v++){const E=_[v];n<E.cts&&(E.deleted=!0,E.cts=-1)}Wt(_);const r=d.slice(u.is_idr?f:l).map(v=>({...v,cts:v.cts-n}));for(const v of r)v.cts<0&&(v.deleted=!0,v.cts=-1);return Wt(r),[_,r]}function yi(d,n){if(d.length===0)return[];let l=-1;for(let u=0;u<d.length;u++){const _=d[u];if(!(n>_.cts)){l=u;break}}if(l===-1)throw Error("Not found audio sample by time");const o=d.slice(0,l).map(u=>({...u})),f=d.slice(l).map(u=>({...u,cts:u.cts-n}));return[o,f]}function Vt(d,n,l){if(d.state==="configured"){for(let o=0;o<n.length;o++)d.decode(n[o]);d.flush().catch(o=>{if(!(o instanceof Error))throw o;if(o.message.includes("Decoding error")&&l.onDecodingError!=null){l.onDecodingError(o);return}if(!o.message.includes("Aborted due to close"))throw o})}}function mi(d,n){if(n!=="avc1"&&n!=="hvc1")return 0;const l=new DataView(d.buffer);for(let o=0;o<d.byteLength-4;){if(n==="avc1"){const f=l.getUint8(o+4)&31;if(f===5||f===7||f===8)return o}else if(n==="hvc1"){const f=l.getUint8(o+4)>>1&63;if(f===19||f===20||f===32||f===33||f===34)return o}o+=l.getUint32(o)+4}return-1}async function vi(d,n,l,o,f,u){const _=await n.createReader(),r=await ce(d.filter(x=>!x.deleted&&x.is_sync&&x.cts>=f.start&&x.cts<=f.end),_);if(r.length===0||o.aborted){u(null,!0);return}let v=0;Vt(E(),r,{onDecodingError:x=>{I.warn("thumbnailsByKeyFrame",x),v===0?Vt(E(!0),r,{onDecodingError:F=>{_.close(),I.error("thumbnailsByKeyFrame retry soft deocde",F)}}):(u(null,!0),_.close())}});function E(x=!1){const F={...l,...x?{hardwareAcceleration:"prefer-software"}:{}},y=new VideoDecoder({output:D=>{v+=1;const t=v===r.length;u(D,t),t&&(_.close(),y.state!=="closed"&&y.close())},error:D=>{const t=`thumbnails decoder error: ${D.message}, config: ${JSON.stringify(F)}, state: ${JSON.stringify({qSize:y.decodeQueueSize,state:y.state,outputCnt:v,inputCnt:r.length})}`;throw I.error(t),Error(t)}});return o.addEventListener("abort",()=>{_.close(),y.state!=="closed"&&y.close()}),y.configure(F),y}}function Wt(d){let n=0,l=null;for(const o of d)if(!o.deleted){if(o.is_sync&&(n+=1),n>=2)break;(l==null||o.cts<l.cts)&&(l=o)}l!=null&&l.cts<2e5&&(l.duration+=l.cts,l.cts=0)}function ue(){try{const d=performance.memory;return{jsHeapSizeLimit:d.jsHeapSizeLimit,totalJSHeapSize:d.totalJSHeapSize,usedJSHeapSize:d.usedJSHeapSize,percentUsed:(d.usedJSHeapSize/d.jsHeapSizeLimit).toFixed(3),percentTotal:(d.totalJSHeapSize/d.jsHeapSizeLimit).toFixed(3)}}catch{return{}}}class W{ready;#t={duration:0,width:0,height:0};get meta(){return{...this.#t}}#n=null;#e=[];constructor(n){const l=o=>(this.#n=o,this.#t.width=o.width,this.#t.height=o.height,this.#t.duration=1/0,{...this.#t});if(n instanceof ReadableStream)this.ready=new Response(n).blob().then(o=>createImageBitmap(o)).then(l);else if(n instanceof ImageBitmap)this.ready=Promise.resolve(l(n));else if(Array.isArray(n)&&n.every(o=>o instanceof VideoFrame)){this.#e=n;const o=this.#e[0];if(o==null)throw Error("The frame count must be greater than 0");this.#t={width:o.displayWidth,height:o.displayHeight,duration:this.#e.reduce((f,u)=>f+(u.duration??0),0)},this.ready=Promise.resolve({...this.#t,duration:1/0})}else if("type"in n)this.ready=this.#a(n.stream,n.type).then(()=>({width:this.#t.width,height:this.#t.height,duration:1/0}));else throw Error("Illegal arguments")}async#a(n,l){this.#e=await ti(n,l);const o=this.#e[0];if(o==null)throw Error("No frame available in gif");this.#t={duration:this.#e.reduce((f,u)=>f+(u.duration??0),0),width:o.codedWidth,height:o.codedHeight},I.info("ImgClip ready:",this.#t)}tickInterceptor=async(n,l)=>l;async tick(n){if(this.#n!=null)return await this.tickInterceptor(n,{video:await createImageBitmap(this.#n),state:"success"});const l=n%this.#t.duration;return await this.tickInterceptor(n,{video:(this.#e.find(o=>l>=o.timestamp&&l<=o.timestamp+(o.duration??0))??this.#e[0]).clone(),state:"success"})}async split(n){if(await this.ready,this.#n!=null)return[new W(await createImageBitmap(this.#n)),new W(await createImageBitmap(this.#n))];let l=-1;for(let u=0;u<this.#e.length;u++){const _=this.#e[u];if(!(n>_.timestamp)){l=u;break}}if(l===-1)throw Error("Not found frame by time");const o=this.#e.slice(0,l).map(u=>new VideoFrame(u)),f=this.#e.slice(l).map(u=>new VideoFrame(u,{timestamp:u.timestamp-n}));return[new W(o),new W(f)]}async clone(){await this.ready;const n=this.#n==null?this.#e.map(o=>o.clone()):await createImageBitmap(this.#n),l=new W(n);return l.tickInterceptor=this.tickInterceptor,l}destroy(){I.info("ImgClip destroy"),this.#n?.close(),this.#e.forEach(n=>n.close())}}let L,T,k=0,dt,it=[],H=[],Z,ft,Ut=null,Zt=0,ct=!1,Et=!1,st=0;const wi=d=>{d.offscreen&&(L=d.offscreen,T=L.getContext("2d")),it=d.TrackResource;for(let n=0;n<H.length;n++)H[n]?.destroy?.();H=[]},bi=d=>{d.size&&(L.width=d.size.width,L.height=d.size.height),Ft()},Ct=()=>{ct=!1,Et=!1,st=0,Ut!==null&&(clearTimeout(Ut),Ut=null),postMessage({type:"stop"})},Si=()=>{ct&&Ct()},At=async d=>{if(H[d])return H[d];if(!it[d])return null;const n=it[d];if(n.use_material_type==="video"&&n.video){const l=(await fetch(n.video)).body,o=new $(l);await o.ready;const[f]=await o.splitTrack();H[d]=f}else if(n.use_material_type==="image"&&n.image){const l=await(await fetch(n.image)).blob(),o=new W(await createImageBitmap(l));await o.ready;const f=new J(o,n.duration*1e3);H[d]=f}else{const l=new OffscreenCanvas(L.width,L.height),o=l.getContext("2d");o.fillStyle="black",o.fillRect(0,0,L.width,L.height);const f=l.transferToImageBitmap(),u=new W(f);await u.ready;const _=new J(u,n.duration*1e3);H[d]=_}return H[d]},Ft=async()=>{if(Z){const{state:d,video:n}=await Z.tick(0);n&&d==="success"&&ge(n)}},Bt=d=>{it[d]&&At(d).then(n=>{ft=n})},xi=async()=>{if(k++,ft)Z=ft,ft=null,postMessage({type:"play",index:k}),dt=it[k];else return Ct(),!1;return Bt(k+1),!0},pe=60,_e=Math.floor(1e3/pe);console.log("FPS",pe,_e+"ms");let It=0;const ge=async d=>{T.clearRect(0,0,L.width,L.height);const n=d.displayWidth||d.codedWidth||d.width||L.width,l=d.displayHeight||d.codedHeight||d.height||L.height,o=Math.min(L.width/n,L.height/l),f=Math.round(n*o),u=Math.round(l*o),_=Math.round((L.width-f)/2),r=Math.round((L.height-u)/2);T.drawImage(d,_,r,f,u);const v=dt?.dialogues?.find(x=>It>=x.start_time&&It<=x.end_time),E=f-20;v&&(T.fillStyle="white",T.font="16px Arial",T.textAlign="center",T.strokeStyle="black",T.lineWidth=2,ye(v.content,L.width/2,u-130,E)),dt?.narration&&(T.fillStyle="white",T.font="16px Arial",T.textAlign="start",T.strokeStyle="black",T.lineWidth=2,ye(dt.narration,_+10,30,E)),d.close()},Ui=()=>{if(ct||Et)return;Et=!0,ct=!0,Zt=performance.now()-st,postMessage({type:"play",index:k}),dt=it[k];const d=async()=>{if(!ct)return;const l=performance.now();st=Math.round((l-Zt)*1e3),It=st/1e3;const{state:o,video:f}=await Z.tick(st);if(postMessage({type:"currentTime",currentTime:It}),o==="done"){await xi()&&(Zt=performance.now(),st=0,n());return}f&&o==="success"&&ge(f),n()},n=()=>{Ut=self.setTimeout(d,_e)};Et=!1,n()},ye=(d,n,l,o)=>{if(T.measureText(d).width>o){const u=d.split("");let _=[],r="";for(let v=0;v<u.length;v++)T.measureText(r+u[v]).width>=o&&(_.push(r),r=""),r+=u[v];r!=""&&_.push(r);for(let v=_.length-1;v>=0;v--)T.strokeText(_[v],n,l+v*24),T.fillText(_[v],n,l+v*24)}else T.strokeText(d,n,l),T.fillText(d,n,l)};onmessage=async d=>{const n=d.data;switch(n.type){case"load":wi(n),k=n.index??0,Z=await At(k),Ft(),Bt(k+1);break;case"resize":bi(n);break;case"play":k!==n.index&&(k=n.index??0,Z=await At(k),Ft(),Bt(k+1)),Ui();break;case"switchClip":k=n.index??0,Z=await At(k),Ft(),Bt(k+1);break;case"pause":Si();break;case"stop":Ct();break;case"destroy":Ct(),Z=null,ft=null;break}}})();
