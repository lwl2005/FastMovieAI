import{d as me,r as x,P as fe,a6 as xe,e as G,s as r,l as o,k as h,I as ne,M as de,u as n,a4 as be,h as g,p as ye,t as y,w as O,z as Se,j as ie,f as z,m as s,a5 as Ie,S as we,J as oe,ao as Ue,C as Ce,x as N,E as b,O as je,ae as te,q as he,am as Le,ak as Ee,B as De,ab as Te,ap as qe,L as We,N as He,D as ge,aq as Ke,o as Qe,a as Xe,aA as Ye,aB as Ze}from"./vendor-t8h0TCfL.js";import{_ as ve,$ as M,R as B,c as eo,u as oo,k as to,r as ke}from"./index-B0RNcuq8.js";import{_ as so}from"./xl-scene-create-BQ6JDdxe.js";import{_ as Re}from"./usePoints-C21LjXJs.js";import{_ as lo}from"./xl-dialogue-create.vue_vue_type_script_setup_true_lang-B8hHj5VF.js";import{_ as ao}from"./index-BFBlsriZ.js";import{I as no}from"./icon-next-step-QYE4O6tF.js";import{I as $e}from"./icon-batch-CVIIjHri.js";import{u as io}from"./usePush-v4t_r-_Z.js";import"./icon-points-01HE_Clx.js";import"./xl-actor-create-BekV8bjq.js";import"./icon-image-BfHAjLRU.js";const ro={class:"episode-tabs",style:{"--el-anchor-active-color":"var(--el-color-success)","--el-anchor-marker-bg-color":"var(--el-color-success)"}},co=["onClick"],uo=me({__name:"episode",props:{modelValue:{default:""},drama_id:{default:""},episode_id:{default:""},episodeList:{default:()=>[]},loading:{default:!1},loadingText:{default:"加载中..."}},emits:["update:modelValue"],setup(K,{emit:se}){const le=K,m=se,T=x(le.episodeList),V=i=>{m("update:modelValue",i.id)};return(i,$)=>{const F=be,U=xe;return fe((g(),G(F,{class:"p-4",ref:"tabsRef","element-loading-text":K.loadingText},{default:r(()=>[o("div",ro,[(g(!0),h(ne,null,de(n(T),(D,L)=>(g(),h("span",{key:D.id,onClick:A=>V(D),class:ye(["episode-tabs-item",{"is-active":D.id===K.modelValue}])}," #"+y(L+1)+" "+y(D.title),11,co))),128))])]),_:1},8,["element-loading-text"])),[[U,!!K.loading]])}}}),po=ve(uo,[["__scopeId","data-v-ccbc25b7"]]),fo={class:"scene-list pb-10"},_o={class:"flex flex-center grid-gap-2"},mo={class:"flex grid-gap-4 flex-center"},vo={class:"text-dark h10 font-weight-600 py-4"},go=["onClick"],xo={class:"flex flex-center grid-gap-2 scene-item-delete"},bo={key:0,class:"flex flex-column grid-gap-4 position-relative"},yo={class:"flex flex-center"},So={class:"flex-1"},Co={class:"text-text-primary"},ho={class:"flex flex-center"},Vo={class:"flex-1"},ko={class:"text-text-primary"},$o={class:"mt-4"},Io={class:"text-info"},wo={class:"flex grid-gap-2"},Uo={class:"flex-1 grid-columns-2 grid-gap-2"},Lo={class:"flex grid-gap-2"},Eo={class:"flex flex-x-flex-end"},Do={key:0,class:"loading-mask","element-loading-text":"绘制场景中..."},Ro=me({__name:"scene",props:{modelValue:{default:""},scene:{default:()=>[]},drama_id:{default:""},episode_id:{default:""},episodeInfo:{default:()=>({})}},emits:["update:modelValue","update:scene"],setup(K,{expose:se,emit:le}){const m=K,T=le,V=x(m.scene),i=x(m.episodeInfo);O(()=>m.episodeInfo,c=>{i.value=c}),O(V,c=>{T("update:scene",c)}),O(()=>m.scene,c=>{V.value=c});const $=x(m.modelValue);O($,c=>{T("update:modelValue",c)}),O(()=>m.modelValue,c=>{$.value=c});const F=x(!1),U=x(!1),D=c=>{U.value=!0;const p=JSON.parse(JSON.stringify(V.value)),e=V.value.filter(u=>u.id!==c.id),f=e.sort((u,v)=>u.sort-v.sort).map((u,v)=>({...u,sort:v+1}));return V.value=e.map(u=>f.find(S=>S.id===u.id)??u),M.post("/app/shortplay/api/Scene/deleteScene",{id:c.id,drama_id:m.drama_id,episode_id:m.episode_id}).then(u=>{u.code===B.SUCCESS?(b.success("删除成功"),$.value==c.id&&($.value="")):(b.error(u.msg),V.value=p)}).catch(()=>{b.error("删除失败"),V.value=p}).finally(()=>{U.value=!1})},L=c=>{c.editMode||c.saveLoading||(c.component="form",c.originData=JSON.parse(JSON.stringify(c)))},A=c=>{const p=c.originData;p&&Object.assign(c,p),c.originData=null,c.editMode=!1,c.component="view"},q=c=>{c.editMode&&(c.saveLoading=!0,M.post("/app/shortplay/api/Scene/update",c).then(p=>{p.code===B.SUCCESS?(c.editMode=!1,c.originData=null,c.component="view"):b.error(p.msg)}).catch(()=>{b.error("保存失败")}).finally(()=>{c.saveLoading=!1}))},E=x(!1),W=Se({model_id:""}),R=x(!1),Y=()=>{R.value=!0},re=()=>{R.value=!1},Q=()=>{E.value||(E.value=!0,M.post("/app/shortplay/api/Generate/scene",{...W,drama_id:m.drama_id,episode_id:m.episode_id}).then(c=>{E.value=!1,c.code===B.SUCCESS?(i.value.init_scene_state=!0,R.value=!1):b.error(c.msg)}).catch(()=>{E.value=!1,b.error("绘制场景失败")}).finally(()=>{E.value=!1}))},J=x({}),X=x(),H=x(!1),j=x(!1),ce=(c,p)=>{if(c){if(j.value||c.image_state)return;J.value=c,X.value=p}else{if(E.value)return;J.value={},X.value=void 0}je(()=>{H.value=!0})},Z=x(null),ee=()=>{Z.value?.open?.({drama_id:m.drama_id,episode_id:m.episode_id})},ue=c=>{V.value.push({...c,component:"view",saveLoading:!1})};return se({openCreateScene:ee,openGenerateImage:ce,openGenerateSceneDialog:Y}),(c,p)=>{const t=Ue,e=Re,f=Ce,u=we,v=Ie,S=ie("Edit"),a=he,I=ie("Delete"),C=Le,P=De,pe=Ee,_e=so,k=be,ae=xe;return fe((g(),G(k,{class:"p-4"},{default:r(()=>[o("div",fo,[n(V).length===0?(g(),G(v,{key:0,description:"暂无场景"},{default:r(()=>[s(u,{modelValue:n(R),"onUpdate:modelValue":p[1]||(p[1]=_=>oe(R)?R.value=_:null),class:"generate-scene-dialog",draggable:""},{header:r(()=>[...p[2]||(p[2]=[o("span",{class:"font-weight-600"},"AI绘制场景",-1)])]),footer:r(()=>[o("div",_o,[s(f,{type:"info",onClick:re,disabled:n(E)},{default:r(()=>[...p[3]||(p[3]=[N("取消",-1)])]),_:1},8,["disabled"]),s(f,{type:"success",icon:"Check",onClick:Q,disabled:!n(W).model_id||n(E),loading:n(E)},{default:r(()=>[...p[4]||(p[4]=[N("绘制",-1)])]),_:1},8,["disabled","loading"])])]),default:r(()=>[s(t,{title:"当前分集尚未创建场景和分镜，是否使用AI绘制？",type:"warning",closable:!1}),s(e,{modelValue:n(W).model_id,"onUpdate:modelValue":p[0]||(p[0]=_=>n(W).model_id=_),scene:"creative_scenes","no-init":""},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1})):(g(!0),h(ne,{key:1},de(n(V),_=>(g(),h("div",{class:ye(["p-6 bg-gray rounded-4 flex flex-column grid-gap-4 scene-item",{"scene-item-current":_.id===n($)}]),key:_.id},[o("div",mo,[o("span",vo,"#"+y(_.id),1),p[7]||(p[7]=o("div",{class:"flex-1"},null,-1)),o("div",{class:"flex flex-center grid-gap-2 scene-item-copy",onClick:te(w=>L(_),["stop"])},[s(a,{size:"16"},{default:r(()=>[s(S)]),_:1}),p[5]||(p[5]=o("span",{class:"text-nowrap"},"编辑",-1))],8,go),s(C,{icon:"Delete",title:"确定删除该场景吗？",placement:"bottom-end","confirm-button-type":"danger",width:"fit-content",onConfirm:w=>D(_)},{reference:r(()=>[o("div",xo,[s(a,{size:"16"},{default:r(()=>[s(I)]),_:1}),p[6]||(p[6]=o("span",{class:"text-nowrap"},"删除",-1))])]),_:1},8,["onConfirm"])]),_.component==="view"?(g(),h("div",bo,[o("div",yo,[p[8]||(p[8]=o("span",{class:"scene-item-label"},"场景：",-1)),o("div",So,[o("span",Co,y(_.title),1)])]),o("div",ho,[p[9]||(p[9]=o("span",{class:"scene-item-label"},"地点：",-1)),o("div",Vo,[o("span",ko,y(_.scene_space)+"·"+y(_.scene_location)+"·"+y(_.scene_time)+"·"+y(_.scene_weather),1)])]),o("div",$o,[o("span",Io,y(_.description),1)])])):_.component==="form"?(g(),G(pe,{key:1,class:"flex flex-column grid-gap-4",disabled:_.saveLoading},{default:r(()=>[o("div",wo,[p[10]||(p[10]=o("span",{class:"scene-item-label pt-3"},"地点：",-1)),o("div",Uo,[s(P,{modelValue:_.scene_space,"onUpdate:modelValue":w=>_.scene_space=w,placeholder:"内景OR外景",class:"scene-item-input grid-column-1 w-100",onInput:w=>_.editMode=!0},null,8,["modelValue","onUpdate:modelValue","onInput"]),s(P,{modelValue:_.scene_location,"onUpdate:modelValue":w=>_.scene_location=w,placeholder:"地点",class:"scene-item-input grid-column-1",onInput:w=>_.editMode=!0},null,8,["modelValue","onUpdate:modelValue","onInput"]),s(P,{modelValue:_.scene_time,"onUpdate:modelValue":w=>_.scene_time=w,placeholder:"大概时间",class:"scene-item-input grid-column-1",onInput:w=>_.editMode=!0},null,8,["modelValue","onUpdate:modelValue","onInput"]),s(P,{modelValue:_.scene_weather,"onUpdate:modelValue":w=>_.scene_weather=w,placeholder:"天气",class:"scene-item-input grid-column-1",onInput:w=>_.editMode=!0},null,8,["modelValue","onUpdate:modelValue","onInput"])])]),o("div",Lo,[p[11]||(p[11]=o("span",{class:"scene-item-label pt-3"},"描述：",-1)),s(P,{modelValue:_.description,"onUpdate:modelValue":w=>_.description=w,type:"textarea",autosize:{minRows:1,maxRows:10},placeholder:"请输入描述",class:"scene-item-textarea",onInput:w=>_.editMode=!0},null,8,["modelValue","onUpdate:modelValue","onInput"])]),o("div",Eo,[s(f,{type:"info",onClick:te(w=>A(_),["stop"])},{default:r(()=>[...p[12]||(p[12]=[N("取消",-1)])]),_:1},8,["onClick"]),s(f,{type:"success",icon:"Check",onClick:te(w=>q(_),["stop"]),disabled:!_.editMode,loading:_.saveLoading},{default:r(()=>[...p[13]||(p[13]=[N("保存",-1)])]),_:1},8,["onClick","disabled","loading"])])]),_:2},1032,["disabled"])):z("",!0)],2))),128))]),n(i).init_scene_state?fe((g(),h("div",Do,null,512)),[[ae,n(i).init_scene_state]]):z("",!0),s(_e,{ref_key:"sceneCreateRef",ref:Z,onSuccess:ue},null,512)]),_:1})),[[ae,n(F)||n(U)]])}}}),zo=ve(Ro,[["__scopeId","data-v-2198f754"]]),Mo={class:"storyboard-list pb-10"},Bo=["onClick"],No={class:"flex grid-gap-4 flex-center"},Oo=["onClick"],Fo=["onClick"],Jo=["onClick"],Go={class:"flex flex-center grid-gap-2 storyboard-item-delete"},Ao={key:0,class:"flex flex-column grid-gap-4"},Po={class:"flex flex-center"},jo={class:"flex-1"},To={key:0,class:"text-regular"},qo={class:"flex flex-center"},Wo={class:"flex-1 flex grid-gap-2"},Ho={key:0,class:"el-tag el-tag--info text-wrap"},Ko={key:1,class:"el-tag el-tag--info text-wrap"},Qo={key:2,class:"el-tag el-tag--info text-wrap"},Xo={class:"flex flex-center"},Yo={class:"flex-1 flex grid-gap-2"},Zo={class:"flex flex-center"},et={class:"flex-1"},ot={class:"text-info"},tt={class:"flex flex-center"},st={class:"flex-1"},lt={class:"text-info"},at={class:"flex flex-center"},nt={class:"flex-1"},dt={class:"text-info"},it={class:"flex flex-center"},rt={class:"flex-1"},ct={class:"text-info"},ut={class:"flex flex-center"},pt={class:"flex-1"},ft={class:"text-info"},_t={class:"flex flex-center"},mt={class:"flex-1"},vt={class:"text-info"},gt={class:"flex"},xt={key:0,class:"flex-1 flex flex-column grid-gap-2 flex-y-flex-start"},bt=["onClick"],yt={class:"h10 text-info flex grid-gap-4"},St={key:1,class:"flex-1"},Ct={class:"flex flex-center"},ht={class:"flex-1"},Vt={class:"flex flex-center"},kt={class:"flex-1 flex grid-gap-2 flex-x-flex-start"},$t={class:"flex flex-center"},It={class:"flex-1 flex grid-gap-2"},wt={class:"el-tag__content"},Ut={class:"flex grid-gap-2"},Lt={class:"flex grid-gap-2"},Et={class:"flex grid-gap-2"},Dt={class:"flex grid-gap-2"},Rt={class:"flex grid-gap-2"},zt={class:"flex flex-x-flex-end"},Mt={key:0,class:"loading-mask","element-loading-text":"绘制分镜中..."},Bt={class:"flex flex-center grid-gap-2"},Nt=me({__name:"storyboard",props:{modelValue:{default:""},storyboard:{default:()=>[]},scene:{default:()=>[]},currentSceneId:{default:void 0},drama_id:{default:""},episode_id:{default:""},episodeInfo:{default:()=>({})}},emits:["update:modelValue","update:storyboard","update:currentSceneId"],setup(K,{expose:se,emit:le}){const m=K,T=le,V=x(m.episodeInfo);O(()=>m.episodeInfo,t=>{V.value=t});const i=x(m.storyboard);O(()=>m.storyboard,t=>{i.value=t}),O(i,t=>{T("update:storyboard",t)});const $=x(m.modelValue);O($,t=>{T("update:modelValue",t)});const F=x(m.currentSceneId);O(F,t=>{T("update:currentSceneId",t)});const U=x(!1),D=(t,e)=>{if(e===void 0)return;U.value=!0;const f=i.value,u=JSON.parse(JSON.stringify(i.value)),v=f.sort((C,P)=>C.sort-P.sort),S=v.findIndex(C=>C.id===t.id);if(S===-1)return;const a=v.findIndex(C=>C.sort===e);if(a===-1)return;const I=v.splice(S,1)[0];v.splice(a,0,I),v.forEach((C,P)=>{C.sort=P+1}),i.value=f.map(C=>v.find(pe=>pe.id===C.id)??C),M.post("/app/shortplay/api/Storyboard/updateSort",{drama_id:m.drama_id,episode_id:m.episode_id,storyboards:v.map(C=>({id:C.id,sort:C.sort}))}).then(C=>{C.code!==B.SUCCESS&&(b.error(C.msg),i.value=u)}).catch(()=>{b.error("更新分镜失败"),i.value=u}).finally(()=>{U.value=!1})},L=x(!1),A=t=>{L.value=!0;const e=i.value,f=e.map(a=>({...a})).sort((a,I)=>a.sort-I.sort),u=f.findIndex(a=>a.id===t.id);if(u===-1){L.value=!1;return}const v={...t,id:void 0,sort:t.sort+1};f.splice(u+1,0,v),f.forEach((a,I)=>{a.sort=I+1});const S=JSON.parse(JSON.stringify(e));i.value=e.map(a=>f.find(C=>C.id===a.id)??a),i.value.push(v),M.post("/app/shortplay/api/Storyboard/copyStoryboard",{drama_id:m.drama_id,episode_id:m.episode_id,copy_id:t.id,new_sort:v.sort}).then(a=>{a.code===B.SUCCESS?(v.id=a.data.id,i.value=i.value.map(I=>I===v&&!I.id?{...I,id:a.data.id}:I),b.success("复制成功")):(b.error(a.msg),i.value=S)}).catch(()=>{b.error("复制失败"),i.value=S}).finally(()=>{L.value=!1})},q=x(!1),E=t=>{q.value=!0;const e=t.scene_id,f=JSON.parse(JSON.stringify(i.value)),v=i.value.filter(a=>a.id!==t.id),S=v.sort((a,I)=>a.sort-I.sort).map((a,I)=>({...a,sort:I+1}));i.value=v.map(a=>S.find(C=>C.id===a.id)??a),M.post("/app/shortplay/api/Storyboard/deleteStoryboard",{id:t.id,scene_id:e,drama_id:m.drama_id,episode_id:m.episode_id}).then(a=>{a.code===B.SUCCESS?b.success("删除成功"):(b.error(a.msg),i.value=f)}).catch(()=>{b.error("删除失败"),i.value=f}).finally(()=>{q.value=!1})},W=x(),R=t=>{M.post("/app/shortplay/api/Storyboard/insertAfter",{drama_id:m.drama_id,episode_id:m.episode_id,after_id:t?.id}).then(e=>{if(e.code===B.SUCCESS){const f=e.data.id;let u=1;const v={id:f,scene_id:null,drama_id:m.drama_id,sort:u,component:"form",description:"",dialogue:null};if(t){const S=i.value.findIndex(a=>a.id===t.id);v.sort=t.sort+1,u=v.sort,i.value.splice(S+1,0,v)}else i.value.push(v);i.value.sort((S,a)=>S.sort-a.sort).forEach(S=>{S.sort>=u&&S.id!==f&&S.sort++})}else b.error(e.msg)}).catch(()=>{b.error("插入失败")})},Y=t=>{t.editMode||t.saveLoading||(t.component="form",t.originData=JSON.parse(JSON.stringify(t)))},re=t=>{const e=t.originData;e&&Object.assign(t,e),t.originData=null,t.editMode=!1,t.component="view"},Q=t=>{t.editMode&&(t.saveLoading=!0,M.post("/app/shortplay/api/Storyboard/update",t).then(e=>{e.code===B.SUCCESS?(t.originData=null,re(t),t.sceneFind=m.scene.find(f=>f.id===t.scene_id),F.value=t.scene_id):b.error(e.msg)}).catch(()=>{b.error("保存失败")}).finally(()=>{t.saveLoading=!1}))},J=x(!1),X=Se({model_id:""}),H=x(!1),j=()=>{H.value=!1},ce=()=>{J.value||(J.value=!0,M.post("/app/shortplay/api/Generate/storyboard",{...X,drama_id:m.drama_id,episode_id:m.episode_id}).then(t=>{J.value=!1,t.code===B.SUCCESS?(V.value.init_storyboard_state=!0,H.value=!1):b.error(t.msg)}).catch(()=>{J.value=!1,b.error("绘制分镜失败")}).finally(()=>{J.value=!1}))},Z=(t,e)=>{const f=i.value[t].dialogues[e];ge.confirm("确定删除该对话吗？","提示",{title:"提示",message:"确定删除该对话吗？",beforeClose:(u,v,S)=>{u==="confirm"?(v.confirmButtonLoading=!0,v.cancelButtonLoading=!0,M.post("/app/shortplay/api/StoryboardDialogue/delete",{drama_id:m.drama_id,storyboard_id:i.value[t].id,dialogue_id:f.id}).then(a=>{a.code===B.SUCCESS?(b.success("删除成功"),i.value[t].dialogues.splice(e,1),S()):b.error(a.msg)}).catch(()=>{b.error("删除失败")}).finally(()=>{v.confirmButtonLoading=!1,v.cancelButtonLoading=!1})):S()}})},ee=x(),ue=t=>{ee.value?.open(t)},c=(t,e)=>{ee.value?.open(t,e)},p=(t,e)=>{const f=t.dialogues.find(u=>u.id===e.id);f?Object.assign(f,e):t.dialogues.push(e)};return se({openCreateStoryboard:R,openGenerateStoryboard:()=>{H.value=!0}}),(t,e)=>{const f=Ce,u=Ie,v=qe,S=ie("ChatDotRound"),a=he,I=ie("Edit"),C=ie("CopyDocument"),P=ie("Delete"),pe=Le,_e=ie("Close"),k=He,ae=We,_=De,w=Ee,ze=ao,Me=Te,Be=Ue,Ne=Re,Oe=we,Fe=lo,Je=be,Ve=xe;return fe((g(),G(Je,{class:"storyboard-scrollbar p-4",ref:"storyboardScrollbarRef"},{default:r(()=>[o("div",Mo,[n(i).length===0?(g(),G(u,{key:0,description:"暂无分镜"},{default:r(()=>[m.scene.length?(g(),G(f,{key:0,type:"success",icon:"Plus",bg:"",text:"",onClick:e[0]||(e[0]=l=>R())},{default:r(()=>[...e[4]||(e[4]=[N("新增",-1)])]),_:1})):z("",!0)]),_:1})):z("",!0),(g(!0),h(ne,null,de(n(i),(l,Ge)=>(g(),h("div",{class:ye(["p-6 bg-gray rounded-4 flex flex-column grid-gap-4 storyboard-item",{"storyboard-item-current":l.id===n($)}]),key:l.id,onClick:d=>{$.value=l.id,F.value=l.scene_id}},[o("div",No,[s(v,{"model-value":l.sort,min:1,controls:!1,disabled:n(U),style:{width:"120px","font-weight":"600"},size:"large",onChange:d=>D(l,d)},{prefix:r(()=>[...e[5]||(e[5]=[o("span",{class:"text-dark h10"},"分镜",-1)])]),_:1},8,["model-value","disabled","onChange"]),e[10]||(e[10]=o("div",{class:"flex-1"},null,-1)),o("div",{class:"flex flex-center grid-gap-2 storyboard-item-copy",onClick:d=>ue(l)},[s(a,{size:"16",class:"text-info"},{default:r(()=>[s(S)]),_:1}),e[6]||(e[6]=o("span",null,"新增对话",-1))],8,Oo),o("div",{class:"flex flex-center grid-gap-2 storyboard-item-copy",onClick:d=>Y(l)},[s(a,{size:"16"},{default:r(()=>[s(I)]),_:1}),e[7]||(e[7]=o("span",null,"编辑",-1))],8,Fo),o("div",{class:"flex flex-center grid-gap-2 storyboard-item-copy",onClick:te(d=>A(l),["stop"])},[s(a,{size:"16"},{default:r(()=>[s(C)]),_:1}),e[8]||(e[8]=o("span",null,"复制",-1))],8,Jo),s(pe,{icon:"Delete",title:"确定删除该分镜吗？",placement:"bottom-end","confirm-button-type":"danger",width:"fit-content",onConfirm:d=>E(l)},{reference:r(()=>[o("div",Go,[s(a,{size:"16"},{default:r(()=>[s(P)]),_:1}),e[9]||(e[9]=o("span",null,"删除",-1))])]),_:1},8,["onConfirm"])]),s(f,{type:"success",icon:"Plus",class:"storyboard-item-add",onClick:d=>R(l)},null,8,["onClick"]),l.component==="view"?(g(),h("div",Ao,[o("div",Po,[e[11]||(e[11]=o("span",{class:"storyboard-item-label"},"场景：",-1)),o("div",jo,[l.sceneFind?(g(),h("span",To,y(l.sceneFind.title)+"·"+y(l.sceneFind.scene_location),1)):z("",!0)])]),o("div",qo,[e[12]||(e[12]=o("span",{class:"storyboard-item-label"},"镜头设计：",-1)),o("div",Wo,[l.shot_type?(g(),h("span",Ho,y(l.shot_type),1)):z("",!0),l.shot_angle?(g(),h("span",Ko,y(l.shot_angle),1)):z("",!0),l.shot_motion?(g(),h("span",Qo,y(l.shot_motion),1)):z("",!0)])]),o("div",Xo,[e[13]||(e[13]=o("span",{class:"storyboard-item-label"},"出镜演员：",-1)),o("div",Yo,[(g(!0),h(ne,null,de(l.actors,d=>(g(),h("span",{class:"el-tag el-tag--info text-wrap",key:d.id},y(d.actor.name),1))),128))])]),o("div",Zo,[e[14]||(e[14]=o("span",{class:"storyboard-item-label"},"时长：",-1)),o("div",et,[o("span",ot,y(l.duration/1e3)+"秒",1)])]),o("div",tt,[e[15]||(e[15]=o("span",{class:"storyboard-item-label"},"画面描述：",-1)),o("div",st,[o("span",lt,y(l.description),1)])]),o("div",at,[e[16]||(e[16]=o("span",{class:"storyboard-item-label"},"首帧图提示词：",-1)),o("div",nt,[o("span",dt,y(l.image_prompt),1)])]),o("div",it,[e[17]||(e[17]=o("span",{class:"storyboard-item-label"},"视频提示词：",-1)),o("div",rt,[o("span",ct,y(l.video_prompt),1)])]),o("div",ut,[e[18]||(e[18]=o("span",{class:"storyboard-item-label"},"音效：",-1)),o("div",pt,[o("span",ft,y(l.sfx),1)])]),o("div",_t,[e[19]||(e[19]=o("span",{class:"storyboard-item-label"},"旁白内容：",-1)),o("div",mt,[o("span",vt,y(l.narration),1)])]),o("div",gt,[e[20]||(e[20]=o("span",{class:"storyboard-item-label pt-5"},"对话内容：",-1)),l.dialogues?.length>0?(g(),h("div",xt,[(g(!0),h(ne,null,de(l.dialogues,(d,Ae)=>(g(),h("div",{class:"flex grid-gap-2 el-tag el-tag--success flex-column",key:d.id},[o("span",{class:"text-wrap pointer",onClick:Pe=>c(l,d)},y(d.actor.name)+y(d.inner_monologue?"(内心OS)":"")+":"+y(d.content),9,bt),o("div",yt,[o("span",null,"语速："+y(d.prosody_speed)+"x",1),o("span",null,"音量："+y(d.prosody_volume),1),o("span",null,"情感："+y(d.emotion),1),o("span",null,"字幕时长："+y(d.start_time/1e3)+" ~ "+y(d.end_time/1e3)+"秒",1)]),s(a,{class:"dialogue-delete-icon",onClick:te(Pe=>Z(Ge,Ae),["stop"])},{default:r(()=>[s(_e)]),_:1},8,["onClick"])]))),128))])):(g(),h("div",St))])])):l.component==="form"?(g(),G(w,{key:1,class:"flex flex-column grid-gap-4",size:"large",disabled:l.saveLoading},{default:r(()=>[o("div",Ct,[e[21]||(e[21]=o("span",{class:"storyboard-item-label"},"场景：",-1)),o("div",ht,[s(ae,{modelValue:l.scene_id,"onUpdate:modelValue":d=>l.scene_id=d,teleported:!1,style:{"--el-select-bg-color":"var(--el-bg-color)","--el-select-input-focus-border-color":"var(--el-color-success)"},placeholder:"选择场景",onChange:d=>l.editMode=!0},{default:r(()=>[(g(!0),h(ne,null,de(m.scene,d=>(g(),G(k,{key:d.id,label:d.title+"·"+d.scene_location,value:d.id},{default:r(()=>[N(y(d.title)+"·"+y(d.scene_location),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])])]),o("div",Vt,[e[22]||(e[22]=o("span",{class:"storyboard-item-label"},"镜头设计：",-1)),o("div",kt,[s(ae,{class:"storyboard-item-select",modelValue:l.shot_type,"onUpdate:modelValue":d=>l.shot_type=d,filterable:"","allow-create":"",teleported:!1,placeholder:"镜头类型",onChange:d=>l.editMode=!0},{default:r(()=>[s(k,{label:"远景镜头",value:"远景镜头"}),s(k,{label:"中景镜头",value:"中景镜头"}),s(k,{label:"近景镜头",value:"近景镜头"}),s(k,{label:"特写镜头",value:"特写镜头"})]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),s(ae,{class:"storyboard-item-select",modelValue:l.shot_angle,"onUpdate:modelValue":d=>l.shot_angle=d,filterable:"","allow-create":"",teleported:!1,placeholder:"镜头视角",onChange:d=>l.editMode=!0},{default:r(()=>[s(k,{label:"正面镜头",value:"正面镜头"}),s(k,{label:"侧面镜头",value:"侧面镜头"}),s(k,{label:"背面镜头",value:"背面镜头"}),s(k,{label:"斜侧面镜头",value:"斜侧面镜头"}),s(k,{label:"斜背面镜头",value:"斜背面镜头"}),s(k,{label:"斜正面镜头",value:"斜正面镜头"}),s(k,{label:"斜侧面背面镜头",value:"斜侧面背面镜头"}),s(k,{label:"斜侧面正面镜头",value:"斜侧面正面镜头"}),s(k,{label:"斜背面正面镜头",value:"斜背面正面镜头"})]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),s(ae,{class:"storyboard-item-select",modelValue:l.shot_motion,"onUpdate:modelValue":d=>l.shot_motion=d,filterable:"","allow-create":"",teleported:!1,placeholder:"镜头运动",onChange:d=>l.editMode=!0},{default:r(()=>[s(k,{label:"固定镜头",value:"固定镜头"}),s(k,{label:"平稳推进",value:"平稳推进"}),s(k,{label:"缓慢推进",value:"缓慢推进"}),s(k,{label:"快速推进",value:"快速推进"}),s(k,{label:"极速推进",value:"极速推进"}),s(k,{label:"缓慢后退",value:"缓慢后退"}),s(k,{label:"快速后退",value:"快速后退"})]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])])]),o("div",$t,[e[23]||(e[23]=o("span",{class:"storyboard-item-label"},"出镜演员：",-1)),o("div",It,[(g(!0),h(ne,null,de(l.actors,d=>(g(),h("span",{class:"el-tag el-tag--info text-wrap",key:d.id,closable:""},[o("span",wt,y(d.actor.name),1),s(a,{class:"el-tag__close",onClick:e[1]||(e[1]=te(()=>{},["stop"]))},{default:r(()=>[s(_e)]),_:1})]))),128))])]),o("div",Ut,[e[24]||(e[24]=o("span",{class:"storyboard-item-label pt-3"},"画面描述：",-1)),s(_,{modelValue:l.description,"onUpdate:modelValue":d=>l.description=d,type:"textarea",autosize:{minRows:1,maxRows:10},placeholder:"请输入画面描述",class:"storyboard-item-textarea",onInput:d=>l.editMode=!0},null,8,["modelValue","onUpdate:modelValue","onInput"])]),o("div",Lt,[e[25]||(e[25]=o("span",{class:"storyboard-item-label pt-3"},"首帧图提示词：",-1)),s(_,{modelValue:l.image_prompt,"onUpdate:modelValue":d=>l.image_prompt=d,type:"textarea",autosize:{minRows:1,maxRows:10},placeholder:"请输入首帧图提示词",class:"storyboard-item-textarea",onInput:d=>l.editMode=!0},null,8,["modelValue","onUpdate:modelValue","onInput"])]),o("div",Et,[e[26]||(e[26]=o("span",{class:"storyboard-item-label pt-3"},"视频提示词：",-1)),s(_,{modelValue:l.video_prompt,"onUpdate:modelValue":d=>l.video_prompt=d,type:"textarea",autosize:{minRows:1,maxRows:10},placeholder:"请输入视频提示词",class:"storyboard-item-textarea",onInput:d=>l.editMode=!0},null,8,["modelValue","onUpdate:modelValue","onInput"])]),o("div",Dt,[e[27]||(e[27]=o("span",{class:"storyboard-item-label pt-3"},"音效：",-1)),s(_,{modelValue:l.sfx,"onUpdate:modelValue":d=>l.sfx=d,type:"textarea",autosize:{minRows:1,maxRows:10},placeholder:"请输入音效",class:"storyboard-item-textarea",onInput:d=>l.editMode=!0},null,8,["modelValue","onUpdate:modelValue","onInput"])]),o("div",Rt,[e[28]||(e[28]=o("span",{class:"storyboard-item-label pt-3"},"旁白内容：",-1)),s(_,{modelValue:l.narration,"onUpdate:modelValue":d=>l.narration=d,type:"textarea",autosize:{minRows:1,maxRows:10},placeholder:"请输入旁白内容",class:"storyboard-item-textarea",onInput:d=>l.editMode=!0},null,8,["modelValue","onUpdate:modelValue","onInput"])]),o("div",zt,[s(f,{type:"info",onClick:te(d=>re(l),["stop"])},{default:r(()=>[...e[29]||(e[29]=[N("取消",-1)])]),_:1},8,["onClick"]),s(f,{type:"success",icon:"Check",onClick:te(d=>Q(l),["stop"]),disabled:!l.editMode,loading:l.saveLoading},{default:r(()=>[...e[30]||(e[30]=[N("保存",-1)])]),_:1},8,["onClick","disabled","loading"])])]),_:2},1032,["disabled"])):z("",!0)],10,Bo))),128))]),n(V).init_storyboard_state?fe((g(),h("div",Mt,null,512)),[[Ve,n(V).init_storyboard_state]]):z("",!0),s(Me,{"virtual-ref":n(W),"virtual-triggering":"",placement:"bottom-start",width:"min(100vw,880px)",trigger:"click"},{default:r(()=>[s(ze)]),_:1},8,["virtual-ref"]),s(Oe,{modelValue:n(H),"onUpdate:modelValue":e[3]||(e[3]=l=>oe(H)?H.value=l:null),class:"generate-storyboard-dialog",draggable:""},{header:r(()=>[...e[31]||(e[31]=[o("span",{class:"font-weight-600"},"AI绘制分镜",-1)])]),footer:r(()=>[o("div",Bt,[s(f,{type:"info",onClick:j,disabled:n(J)},{default:r(()=>[...e[32]||(e[32]=[N("取消",-1)])]),_:1},8,["disabled"]),s(f,{type:"success",icon:"Check",onClick:ce,disabled:!n(X).model_id||n(J),loading:n(J)},{default:r(()=>[...e[33]||(e[33]=[N("绘制",-1)])]),_:1},8,["disabled","loading"])])]),default:r(()=>[s(Be,{title:"当前分集尚未创建分镜，是否使用AI绘制？",type:"warning",closable:!1}),s(Ne,{modelValue:n(X).model_id,"onUpdate:modelValue":e[2]||(e[2]=l=>n(X).model_id=l),scene:"creative_storyboards","no-init":""},null,8,["modelValue"])]),_:1},8,["modelValue"]),s(Fe,{ref_key:"dialogueCreateRef",ref:ee,onSuccess:p},null,512)]),_:1})),[[Ve,n(L)||n(q)]])}}}),Ot=ve(Nt,[["__scopeId","data-v-d639c0d4"]]),Ft={class:"flex flex-column draw-module"},Jt={class:"flex-1 flex flex-column rounded-6 border flex-center overflow-hidden"},Gt={class:"flex flex-center pr-4"},At={class:"flex flex-center grid-gap-2"},Pt={class:"flex flex-center pr-4"},jt={class:"flex flex-center grid-gap-2"},Tt={class:"p-4 w-100 flex grid-gap-4 flex-center"},qt=me({__name:"index",emits:["update:drama"],setup(K,{emit:se}){const le=eo(),{USERINFO:m}=oo(le),T=se,V=Ke(),i=x(V.params.drama_id),$=x(V.params.episode_id),F=x({}),U=x([]),D=x([]),L=x($.value),A=x(),q=x(),E=x({});O(L,t=>{A.value=void 0,q.value=void 0,ke.push(`/generate/drama/${i.value}/${t}`)}),O(()=>V.path,()=>{i.value=V.params.drama_id,$.value=V.params.episode_id,L.value=$.value,Q()}),O(i,(t,e)=>{e&&ue("private-generatescenestoryboard-"+e),p()});const W=x(null),R=x(null),Y=x(!1),re=()=>{i.value&&M.get("/app/shortplay/api/Works/details",{params:{id:i.value}}).then(t=>{t.code===B.SUCCESS?(E.value=t.data,T("update:drama",E.value)):b.error(t.msg)}).catch(()=>{b.error("获取短剧详情失败")})},Q=()=>{!i.value||!$.value||Y.value||(Y.value=!0,M.get("/app/shortplay/api/Works/episode",{params:{drama_id:i.value,episode_id:$.value}}).then(t=>{t.code===B.SUCCESS?(U.value=t.data.scenes.map(e=>({...e,component:"view",saveLoading:!1})),D.value=t.data.storyboards.map(e=>({...e,component:"view",saveLoading:!1})),delete t.data.scenes,delete t.data.storyboards,F.value=t.data):b.error(t.msg)}).finally(()=>{Y.value=!1}))},J=()=>{ke.push(`/generate/actors/${i.value}/${$.value}`)},X=()=>{ge.confirm("提示",{title:"提示",message:"确定清空本集场景吗？",beforeClose(t,e,f){t==="confirm"?(e.confirmButtonLoading=!0,e.cancelButtonLoading=!0,M.post("/app/shortplay/api/Scene/deleteScene",{drama_id:i.value,episode_id:$.value}).then(u=>{u.code===B.SUCCESS?(b.success(u.msg),Q(),f()):b.error(u.msg)}).catch(()=>{b.error("清空场景失败")}).finally(()=>{e.cancelButtonLoading=!0,e.confirmButtonLoading=!1})):f()}}).then(()=>{})},H=()=>{ge.confirm("提示",{title:"提示",message:"确定清空本集分镜吗？",beforeClose(t,e,f){t==="confirm"?(e.confirmButtonLoading=!0,e.cancelButtonLoading=!0,M.post("/app/shortplay/api/Storyboard/deleteStoryboard",{drama_id:i.value,episode_id:$.value}).then(u=>{u.code===B.SUCCESS?(b.success(u.msg),Q(),f()):b.error(u.msg)}).catch(()=>{b.error("清空场景失败")}).finally(()=>{e.cancelButtonLoading=!0,e.confirmButtonLoading=!1})):f()}}).then(()=>{})},j=Se({episode:400,scene:550}),ce=to();O(j,t=>{ce.set("splitterForm",t)});const Z=ce.get("splitterForm");Z&&(j.episode=Z.episode,j.scene=Z.scene);const{subscribe:ee,unsubscribe:ue,unsubscribeAll:c}=io(),p=()=>{i.value&&(ee("private-generatescenestoryboard-"+i.value,t=>{console.log("channels complete info message",t),t.episode_id===$.value&&Q()}),ee("private-generatesceneimage-"+m.value?.user,t=>{console.log("channels complete info message",t),U.value.forEach(e=>{e.id===t.id&&(e.image=t.image,e.image_state=0)})}))};return Qe(()=>{Q(),re(),p()}),Xe(()=>{c()}),(t,e)=>{const f=Ye,u=Ce,v=Ze,S=he;return g(),h("div",Ft,[o("div",Jt,[s(v,{class:"flex-1 w-100 overflow-hidden",style:{"--el-border-color-light":"transparent"}},{default:r(()=>[s(f,{size:n(j).episode,"onUpdate:size":e[1]||(e[1]=a=>n(j).episode=a),min:100,class:"overflow-hidden flex flex-column"},{default:r(()=>[e[14]||(e[14]=o("span",{class:"font-weight-600 p-4"},"#续集列表",-1)),n(E).episodes?.length>0?(g(),G(po,{key:0,modelValue:n(L),"onUpdate:modelValue":e[0]||(e[0]=a=>oe(L)?L.value=a:null),"episode-list":n(E).episodes,drama_id:n(i),episode_id:n($),loading:n(Y),"loading-text":"加载中..."},null,8,["modelValue","episode-list","drama_id","episode_id","loading"])):z("",!0)]),_:1},8,["size"]),s(f,{size:n(j).scene,"onUpdate:size":e[6]||(e[6]=a=>n(j).scene=a),min:100,class:"overflow-hidden flex flex-column position-relative"},{default:r(()=>[o("div",Gt,[e[17]||(e[17]=o("span",{class:"font-weight-600 p-4"},"#场景",-1)),e[18]||(e[18]=o("div",{class:"flex-1"},null,-1)),o("div",At,[s(u,{type:"danger",icon:"Delete",size:"small",bg:"",text:"",onClick:e[2]||(e[2]=a=>X())},{default:r(()=>[...e[15]||(e[15]=[N("一键清空本集场景",-1)])]),_:1}),s(u,{type:"success",icon:"Plus",size:"small",bg:"",text:"",onClick:e[3]||(e[3]=a=>n(W)?.openCreateScene?.())},{default:r(()=>[...e[16]||(e[16]=[N("新增",-1)])]),_:1})])]),s(zo,{ref_key:"sceneRef",ref:W,modelValue:n(A),"onUpdate:modelValue":e[4]||(e[4]=a=>oe(A)?A.value=a:null),scene:n(U),"onUpdate:scene":e[5]||(e[5]=a=>oe(U)?U.value=a:null),drama_id:n(i),episode_id:n(L),"episode-info":n(F)},null,8,["modelValue","scene","drama_id","episode_id","episode-info"])]),_:1},8,["size"]),s(f,{class:"overflow-hidden flex flex-column position-relative",min:100},{default:r(()=>[o("div",Pt,[e[21]||(e[21]=o("span",{class:"font-weight-600 p-4"},"#分镜",-1)),e[22]||(e[22]=o("div",{class:"flex-1"},null,-1)),o("div",jt,[n(D).length>0?(g(),G(u,{key:0,type:"danger",bg:"",text:"",size:"small",onClick:e[7]||(e[7]=a=>H())},{default:r(()=>[...e[19]||(e[19]=[N("一键清空分镜",-1)])]),_:1})):z("",!0),n(U).length>0?(g(),G(u,{key:1,type:"success",icon:"Plus",size:"small",bg:"",text:"",onClick:e[8]||(e[8]=a=>n(R)?.openCreateStoryboard?.())},{default:r(()=>[...e[20]||(e[20]=[N("新增",-1)])]),_:1})):z("",!0)])]),s(Ot,{ref_key:"storyboardRef",ref:R,modelValue:n(q),"onUpdate:modelValue":e[9]||(e[9]=a=>oe(q)?q.value=a:null),storyboard:n(D),"onUpdate:storyboard":e[10]||(e[10]=a=>oe(D)?D.value=a:null),scene:n(U),drama_id:n(i),episode_id:n(L),"current-scene-id":n(A),"onUpdate:currentSceneId":e[11]||(e[11]=a=>oe(A)?A.value=a:null),"episode-info":n(F)},null,8,["modelValue","storyboard","scene","drama_id","episode_id","current-scene-id","episode-info"])]),_:1})]),_:1})]),o("div",Tt,[n(U).length<=0?(g(),G(u,{key:0,type:"success",size:"large",onClick:e[12]||(e[12]=a=>n(W)?.openGenerateSceneDialog?.()),loading:!!n(F).init_scene_state,icon:$e},{default:r(()=>[...e[23]||(e[23]=[o("span",null,"初始化场景",-1)])]),_:1},8,["loading"])):z("",!0),s(u,{type:"success",size:"large",onClick:e[13]||(e[13]=a=>n(R)?.openGenerateStoryboard?.()),loading:!!n(F).init_storyboard_state,disabled:n(D).length<=0,icon:$e},{default:r(()=>[...e[24]||(e[24]=[o("span",null,"批量生成分镜",-1)])]),_:1},8,["loading","disabled"]),s(u,{type:"success",size:"large",onClick:J},{default:r(()=>[e[25]||(e[25]=o("span",null,"下一步",-1)),s(S,{size:"16",class:"ml-2"},{default:r(()=>[s(no)]),_:1})]),_:1})])])}}}),as=ve(qt,[["__scopeId","data-v-d54d20b4"]]);export{as as default};
