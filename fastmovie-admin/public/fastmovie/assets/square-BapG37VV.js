import{d as A,r as u,z as P,o as F,k as c,e as O,s as y,l,h as i,I as C,M as w,t as m,m as h,a8 as V,af as D,p as G,q as H,a6 as T,E,a5 as j}from"./vendor-C6C8mA7k.js";import{I as J}from"./icon-like-Xdsq6lRA.js";import{c as K,$ as S,R as I,r as Q,_ as X}from"./index-BY2sLTz-.js";const Y={class:"container"},Z=["onClick"],ee=["src"],se={class:"h10 font-weight-600 episode_num"},te={class:"flex p-4 flex-y-center grid-gap-2 flex-x-space-between position-absolute bottom-0 left-0 right-0"},ae={class:"flex flex-y-center grid-gap-2"},ne={class:"h9"},oe=["onClick"],le={class:"h9"},re={key:1,class:"flex flex-center"},v=4,b=16,ie=A({__name:"square",setup(ce){const _=u(null),r=u(Array.from({length:v},()=>({height:0,list:[]}))),k=P({page:1,page_size:10}),p=u(!1),f=u(!1);function L(e,s){return new Promise((t,d)=>{const o=new Image;o.onload=()=>{t(o.height*s/o.width)},o.onerror=d,o.src=e})}function M(){let e=0,s=r.value[0].height;for(let t=1;t<r.value.length;t++)r.value[t].height<s&&(s=r.value[t].height,e=t);return e}function R(e){const s=M(),t=r.value[s];t.list.push(e),t.height+=e.height+b}async function $(e){if(!_.value||!e.length)return;const t=(_.value.clientWidth-b*(v-1))/v,d=e.filter(a=>a?.drama?.cover).map(async a=>{try{const g=await L(a.drama.cover,t);return{...a,height:g}}catch{return null}});(await Promise.allSettled(d)).forEach(a=>{a.status==="fulfilled"&&a.value&&R(a.value)})}async function x(){if(!(p.value||f.value)){p.value=!0;try{const e=await S.get("/app/shortplay/api/Square/index",{params:k}),s=e?.data?.data||[];e.code===I.SUCCESS&&s.length?await $(s):f.value=!0}catch(e){console.error("获取列表失败:",e)}finally{p.value=!1}}}function q(){f.value||(k.page++,x())}function z(e){Q.push(`/play/${e.drama_id}/${e.episode.episode_id}`)}const B=K(),U=e=>{B.hasLogin()&&S.post("/app/shortplay/api/Square/likes",{drama_id:e.drama_id,episode_id:e.episode_id}).then(s=>{s.code===I.SUCCESS?(e.is_likes=!e.is_likes,e.likes=s.data.likes):E.error(s.msg)}).catch(()=>{E.error("点赞失败")})};return F(x),(e,s)=>{const t=V,d=H,o=j,a=T;return i(),c("div",Y,[r.value.length>0?(i(),O(o,{key:0,height:"100%","wrap-class":"flex-1",onEndReached:q},{default:y(()=>[l("div",{ref_key:"containerRef",ref:_,class:"waterfall"},[(i(!0),c(C,null,w(r.value,(g,N)=>(i(),c("div",{class:"column",key:N},[(i(!0),c(C,null,w(g.list,n=>(i(),c("div",{class:"item",key:n.id,onClick:W=>z(n)},[l("img",{src:n.drama.cover},null,8,ee),l("span",se,"共 "+m(n.episode_num)+" 集",1),l("div",te,[l("div",ae,[h(t,{src:n.user.headimg,alt:n.user.nickname,size:24},null,8,["src","alt"]),l("span",ne,m(n.user.nickname),1)]),l("div",{class:G(["flex flex-y-center grid-gap-2 pointer",[n.is_likes?"text-danger":"text-info"]]),onClick:D(W=>U(n),["stop"])},[h(d,{size:16},{default:y(()=>[h(J)]),_:1}),l("span",le,m(n.likes),1)],10,oe)])],8,Z))),128))]))),128))],512)]),_:1})):(i(),c("div",re,[h(a,{description:"暂无数据"})]))])}}}),_e=X(ie,[["__scopeId","data-v-72b24667"]]);export{_e as default};
